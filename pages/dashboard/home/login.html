<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Login — L3Z</title>
<meta http-equiv="Cache-Control" content="no-store"/>
<style>
  :root{--bg:#060b0d;--ink:#eaf7ff;--muted:#a8c6cc;--line:rgba(0,255,255,.18);--teal:#00ffff;--ok:#11d48a;--bad:#ff6b81}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
  .card{width:380px;max-width:92vw;background:linear-gradient(180deg,rgba(5,10,12,.78),rgba(5,10,12,.50));
        border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.5);padding:20px}
  h1{margin:0 0 8px;color:var(--teal);text-shadow:0 0 16px #00ffff55}
  .muted{margin:0 0 16px;color:var(--muted);font-size:13px}
  label{display:block;margin:12px 0 8px;font-size:14px}
  input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#081216;color:var(--ink);outline:none}
  button{width:100%;padding:12px;border:0;border-radius:10px;background:var(--teal);color:#001316;font-weight:800;cursor:pointer;box-shadow:0 0 20px #00ffff55;margin-top:12px}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
  .pill{padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cff;font-size:12px}
  #msg{min-height:18px;margin-top:10px;font-size:13px}
  #msg.ok{color:var(--ok)} #msg.bad{color:var(--bad)}
  .links{display:flex;gap:8px;margin-top:10px}
  .links a{flex:1;text-align:center;text-decoration:none;color:#001316;background:#bff;border-radius:10px;padding:10px 12px;font-weight:800}
</style>
</head>

<script>
  // Single source of truth for API base
  window.API_BASE = (location.hostname==='127.0.0.1'||location.hostname==='localhost')
    ? 'http://localhost:3000'
    : ''; // same-origin in production
</script>

<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1 style="margin:0">Account Login</h1>
      <span id="env" class="pill">—</span>
    </div>
    <p class="muted">Sign in as a viewer. If your username is <b>lash3z</b>, you’ll also unlock admin when the server allows it — or offline fallback is used.</p>

    <form id="f" autocomplete="on">
      <label for="username">Username</label>
      <input id="username" name="username" required autocomplete="username"/>

      <label for="password">Password</label>
      <input id="password" name="password" type="password" required autocomplete="current-password"/>

      <button id="submitBtn" type="submit">Sign in</button>
      <div id="msg" aria-live="polite"></div>

      <div id="nextLinks" class="links" style="display:none">
        <a href="/index.html">← Back to site</a>
        <a id="toAdmin" href="/pages/dashboard/admin/admin_hub.html">Administration</a>
      </div>
    </form>
  </div>
</div>

<script>
"use strict";
(function(){
  var API_BASE = window.API_BASE || "";
  var env = document.getElementById("env");
  env.textContent = location.origin + (API_BASE ? " → " + API_BASE : " (same-origin)");

  var f   = document.getElementById("f");
  var msg = document.getElementById("msg");
  var btn = document.getElementById("submitBtn");
  var links = document.getElementById("nextLinks");
  var toAdmin = document.getElementById("toAdmin");

  function setMsg(t, ok){
    msg.textContent = t || "";
    msg.className = ok===true ? "ok" : ok===false ? "bad" : "";
  }

  function setCookie(name,value,days){
    try{
      var s = name+"="+encodeURIComponent(value)+"; path=/; SameSite=Lax";
      if (location.protocol === "https:") s += "; Secure";
      if(days){
        var d=new Date();
        d.setTime(d.getTime()+days*86400000);
        s += "; expires="+d.toUTCString();
      }
      document.cookie = s;
    }catch(_){}
  }

  async function apiPost(path, body){
    var url = API_BASE + path; // empty API_BASE = same-origin
    var res = await fetch(url, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      credentials:"include",
      body: JSON.stringify(body||{})
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    var ct = res.headers.get("content-type") || "";
    if (ct.indexOf("application/json") !== -1) {
      return res.json();
    }
    return {};
  }

  async function tryViewer(username){
    try{
      await apiPost("/api/viewer/login",{ username: username });
      return true;
    }catch(_){ return false; }
  }

  async function tryAdmin(username,password){
    try{
      // Try new gate first, fall back to legacy
      try{
        await apiPost("/api/admin/gate/login",{ username: username, password: password });
        return true;
      }catch(_){
        await apiPost("/api/admin/login",{ username: username, password: password });
        return true;
      }
    }catch(_){ return false; }
  }

  function offlineLogin(username, makeAdmin){
    setCookie("viewer", username, 7);
    try{
      localStorage.setItem("lash3z_last_user", JSON.stringify(username));
      localStorage.setItem("l3z:session", JSON.stringify({ user: username, ts: Date.now() }));
      if (makeAdmin) localStorage.setItem("l3z:isAdmin", "true");
    }catch(_){}
  }

  f.addEventListener("submit", async function(ev){
    ev.preventDefault();

    var username = String(document.getElementById("username").value||"").trim();
    var password = String(document.getElementById("password").value||"");

    if(!username || !password){ setMsg("Enter username and password.", false); return; }

    btn.disabled = true; setMsg("Signing in…");

    // Remember last user locally for header/widgets
    try{ localStorage.setItem("lash3z_last_user", JSON.stringify(username)); }catch(_){}

    var viewerOK=false, adminOK=false, offline=false;

    // 1) Attempt viewer login via API
    viewerOK = await tryViewer(username);

    // 2) If viewer OK and username is special, try admin
    if (viewerOK && username.toLowerCase() === "lash3z"){
      adminOK = await tryAdmin(username, password);
    }

    // 3) Offline fallback
    if (!viewerOK){
      offline = true;
      var makeAdmin = (username.toLowerCase()==="lash3z");
      offlineLogin(username, makeAdmin);
      viewerOK = true;
      adminOK  = makeAdmin;
    }

    if (viewerOK){
      setMsg(
        offline
          ? (adminOK ? "Signed in (offline admin bypass)." : "Signed in (offline viewer).")
          : (adminOK ? "Signed in as admin." : "Signed in."),
        true
      );
      links.style.display = "flex";
      toAdmin.style.display = adminOK ? "inline-block" : "none";
    }else{
      setMsg("Login failed.", false);
    }

    btn.disabled = false;
  });
})();
</script>
</body>
</html>
