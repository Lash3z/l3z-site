<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sign in — LASH3Z</title>
  <link rel="icon" type="image/png" href="/assets/L3Z_logoMain.png">
  <style>
    :root{
      --bg:#0b0f14;--panel:#11161d;--ink:#e9f1ff;--line:rgba(0,255,255,.18);
      --gold:#ffcc66;--ok:#12d48a;--bad:#ff8fa0;--chip:#0c141a
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial,sans-serif}
    a{color:#9bd3ff;text-decoration:none}
    .wrap{display:grid;place-items:center;min-height:100vh;padding:16px}
    .card{
      width:100%;max-width:460px;background:linear-gradient(180deg,#0f131a,#0a0f15);
      border:1px solid var(--line);border-radius:14px;padding:18px 18px 20px;
      box-shadow:0 0 18px rgba(0,255,255,.08)
    }
    h1{margin:0 0 6px;font-size:18px;letter-spacing:.3px;color:#ffd78a}
    .tabs{display:flex;border:1px solid var(--line);border-radius:10px;overflow:hidden;margin:10px 0 12px}
    .tab{flex:1;text-align:center;padding:10px 12px;cursor:pointer;background:#0b1015}
    .tab.on{background:#152029;font-weight:700}
    label{display:block;margin:10px 0 6px}
    input{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);
      background:#0c1218;color:var(--ink)
    }
    button{
      width:100%;margin-top:14px;padding:12px;border:0;border-radius:10px;cursor:pointer;font-weight:800;
      color:#1a1304;background:linear-gradient(180deg,#ffd27a,#e3a93b)
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .msg{margin-top:10px;font-size:12px;min-height:16px;color:#9fb1c7}
    .msg.ok{color:var(--ok)} .msg.bad{color:var(--bad)}
    .hint{margin-top:10px;color:#9fb1c7;font-size:12px}
    .meta{display:flex;align-items:center;gap:8px;margin-top:8px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#091319;color:#cfe;font-size:12px}
    .kickBox{ margin-top:14px; padding:10px; border:1px solid var(--line); border-radius:12px; background:var(--chip); }
    .kickRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .kickTitle{ font-size:13px; color:#cfe; }
    .kickBtn{ padding:8px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.3); cursor:pointer; font-weight:800; color:#102b2b; background:linear-gradient(180deg,#98f7e1,#49d5b3); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Welcome back</h1>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab on" id="tabLogin">Sign in</div>
      <div class="tab" id="tabSignup">Create account</div>
    </div>

    <!-- Sign in -->
    <form id="formLogin">
      <label for="lu">Username</label>
      <input id="lu" autocomplete="username" required>

      <label for="lp">Password</label>
      <input id="lp" type="password" autocomplete="current-password" required>

      <button id="btnLogin" type="submit">Sign in</button>
      <div class="meta">
        <div class="pill" id="cookieState">cookie: checking…</div>
        <div id="loginMsg" class="msg"></div>
      </div>

      <div class="kickBox">
        <div class="kickRow">
          <div class="kickTitle">Link your Kick after login for profile display</div>
          <button type="button" class="kickBtn" id="kickLinkBtn1">Go to Kick Link</button>
        </div>
      </div>
    </form>

    <!-- Sign up -->
    <form id="formSignup" style="display:none">
      <label for="su">Username</label>
      <input id="su" autocomplete="username" required placeholder="3-20 chars, letters/numbers . _ -">

      <label for="se">Email (optional)</label>
      <input id="se" type="email" autocomplete="email" placeholder="you@example.com">

      <label for="sp">Password</label>
      <input id="sp" type="password" autocomplete="new-password" required>

      <button id="btnSignup" type="submit">Create account</button>
      <div class="meta">
        <div class="pill" id="cookieState2">cookie: —</div>
        <div id="signupMsg" class="msg"></div>
      </div>

      <div class="kickBox">
        <div class="kickRow">
          <div class="kickTitle">After sign up, link your Kick for profile display</div>
          <button type="button" class="kickBtn" id="kickLinkBtn2">Go to Kick Link</button>
        </div>
      </div>
    </form>

    <div class="hint">Trouble signing in? Ping a mod. If your API is on another domain, this page uses <code>/assets/api-base.js</code> with cookies.</div>
  </div>
</div>

<!-- Shared API client -->
<script src="/assets/api-base.js"></script>
<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const tabLogin = $("#tabLogin"), tabSignup = $("#tabSignup");
  const formLogin = $("#formLogin"), formSignup = $("#formSignup");
  const loginMsg = $("#loginMsg"), signupMsg = $("#signupMsg");
  const cookieState = $("#cookieState"), cookieState2 = $("#cookieState2");

  // UX helpers
  function msg(el, text, good){
    if(!el) return;
    el.textContent = text || "";
    el.className = "msg" + (good===true?" ok":good===false?" bad":"");
  }

  // Tabs
  function showLogin(){ tabLogin.classList.add("on"); tabSignup.classList.remove("on"); formLogin.style.display="block"; formSignup.style.display="none"; }
  function showSignup(){ tabSignup.classList.add("on"); tabLogin.classList.remove("on"); formLogin.style.display="none"; formSignup.style.display="block"; }
  tabLogin.addEventListener("click", showLogin);
  tabSignup.addEventListener("click", showSignup);

  // Cookie probe
  async function probeCookies(){
    try{ await api.get("/api/me"); cookieState.textContent="cookie: ok"; cookieState2.textContent="cookie: ok"; }
    catch{ cookieState.textContent="cookie: missing"; cookieState2.textContent="cookie: missing"; }
  }

  // Sign in
  $("#formLogin").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const u = $("#lu").value.trim().toLowerCase();
    const p = $("#lp").value;
    if(!u || !p){ msg(loginMsg, "Enter username & password.", false); return; }
    $("#btnLogin").disabled=true; msg(loginMsg, "Signing in…");
    try{
      await api.post("/api/auth/login", { username:u, password:p });
      msg(loginMsg, "Signed in. Redirecting…", true);
      localStorage.setItem("lash3z_last_user", u);
      setTimeout(()=> location.replace("/pages/dashboard/home/profile.html"), 150);
    }catch(e){
      msg(loginMsg, String((e.payload&& (e.payload.error||e.payload.detail)) || e.message).replace(/_/g," "), false);
    }finally{
      $("#btnLogin").disabled=false;
      probeCookies();
    }
  });

  // Sign up
  $("#formSignup").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const u = $("#su").value.trim().toLowerCase();
    const e = $("#se").value.trim();
    const p = $("#sp").value;
    if(!u || !p){ msg(signupMsg, "Username and password required.", false); return; }
    if(!/^[a-z0-9_.-]{3,20}$/i.test(u)){ msg(signupMsg, "Username format invalid.", false); return; }
    $("#btnSignup").disabled=true; msg(signupMsg, "Creating…");
    try{
      await api.post("/api/auth/signup", { username:u, email:e||null, password:p });
      msg(signupMsg, "Account created. Redirecting…", true);
      localStorage.setItem("lash3z_last_user", u);
      setTimeout(()=> location.replace("/pages/dashboard/home/profile.html"), 150);
    }catch(e){
      msg(signupMsg, String((e.payload&& (e.payload.error||e.payload.detail)) || e.message).replace(/_/g," "), false);
    }finally{
      $("#btnSignup").disabled=false;
      probeCookies();
    }
  });

  // Kick linking CTA
  document.getElementById("kickLinkBtn1")?.addEventListener("click", ()=>{
    location.href = "/pages/dashboard/home/profile.html#kick";
  });
  document.getElementById("kickLinkBtn2")?.addEventListener("click", ()=>{
    location.href = "/pages/dashboard/home/profile.html#kick";
  });

  // Prefill last user if available
  try{
    const last = localStorage.getItem("lash3z_last_user");
    if(last && !$("#lu").value) $("#lu").value = last;
    if(last && !$("#su").value) $("#su").value = last;
  }catch{}

  probeCookies();
})();
</script>
</body>
</html>
