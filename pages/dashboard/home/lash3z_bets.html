<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bets — L3Z</title>
<link rel="icon" type="image/png" href="/assets/L3Z_logoMain.png">
<style>
  :root{--bg:#0b0e13;--panel:#0f141b;--ink:#e8ecf3;--muted:#94a3b8;--line:rgba(0,255,255,.18);--ok:#12d48a;--err:#ff7a8a;--chip:#0c141a}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  a{color:#9bd3ff;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0a1016;color:#cfe;font-weight:800}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#0f131a,#0a0f15);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .head h2{margin:0;font-size:14px;letter-spacing:.3px;color:#ffd78a}
  .body{padding:12px;display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  input,select,button,textarea{background:#0f141b;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px 12px;font-size:14px}
  input[type="number"]{width:140px}
  button{cursor:pointer;font-weight:800}
  .primary{background:linear-gradient(180deg,#f5c462,#d49a2e);color:#1a1204;border:none}
  .ghost{background:#111a22}
  .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:920px}
  thead th{position:sticky;top:0;background:#0b1316;border-bottom:1px solid rgba(255,255,255,.08);font-weight:800;font-size:12px;color:#9fb3c5;text-align:left;padding:10px}
  tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
  tbody tr:hover{background:#0a1214}
  .status{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#0d141b;font-size:12px}
  .status.placed{color:#9bd3ff} .status.settled{color:#12d48a} .status.voided{color:#ff7a8a}
  .mini{font-size:12px;color:#9fb3c5}
  .pick{display:inline-block;margin-right:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0f171d;font-size:12px}
</style>
</head>
<body data-login-url="/login.html">
<div class="wrap">
  <div class="top">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="/assets/l3z_logo.png" alt="" style="width:36px;height:36px;border-radius:10px;border:1px solid var(--line)">
      <div class="pill">Bets</div>
    </div>
    <div class="row">
      <div class="pill">user: <b id="whoami">—</b></div>
      <div class="pill">balance: <b id="walletBalance">0 LBX</b></div>
      <button id="logout" class="ghost">Logout</button>
    </div>
  </div>

  <div class="grid">
    <!-- Bet Builder -->
    <section class="card">
      <div class="head"><h2>Bet Builder</h2><div class="row mini"><span id="bbState" class="muted">idle</span></div></div>
      <div class="body">
        <div class="row"><input id="bbGame" placeholder="Game / Market (e.g., Lucky7, Mega, PvP)"/></div>
        <div class="row"><input id="bbPicks" placeholder="Picks (comma separated, e.g., Doghouse, Wanted)"/></div>
        <div class="row">
          <label class="mini">Stake (LBX)</label>
          <input id="bbStake" type="number" min="1" step="1" value="1"/>
          <button id="bbPlace" class="primary">Place Bet</button>
        </div>
        <div class="mini">Places a bet via <code>/api/bets/place</code>. LBX is deducted immediately on success.</div>
      </div>
    </section>

    <!-- Stats -->
    <section class="card">
      <div class="head"><h2>My Stats</h2><div class="row mini"><span id="stState" class="muted"></span></div></div>
      <div class="body">
        <div class="row">
          <div class="pill">Open Bets: <b id="stOpen">0</b></div>
          <div class="pill">Staked (open): <b id="stStaked">0 LBX</b></div>
          <div class="pill">Potential Return: <b id="stPotential">0 LBX</b></div>
        </div>
        <div class="row mini">These are based on your current open bets.</div>
      </div>
    </section>
  </div>

  <!-- My Bets -->
  <section class="card">
    <div class="head">
      <h2>My Bets</h2>
      <div class="row">
        <select id="statusSel">
          <option value="placed" selected>Placed</option>
          <option value="settled">Settled</option>
          <option value="voided">Voided</option>
          <option value="">All</option>
        </select>
        <select id="limitSel">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
        <button id="refresh" class="ghost">Refresh</button>
        <span id="listState" class="muted mini">idle</span>
      </div>
    </div>
    <div class="body">
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:160px">Placed</th>
              <th style="width:160px">Game</th>
              <th>Picks</th>
              <th style="width:120px">Stake</th>
              <th style="width:120px">Status</th>
              <th style="width:140px">Potential</th>
              <th style="width:140px">Result</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="muted" style="padding:14px">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script src="/assets/api-base.js"></script>
<script src="/assets/js/bootstrap-auth.js"></script>
<script>
(() => {
  const $ = (s,r=document)=>r.querySelector(s);
  const $$= (s,r=document)=>Array.from(r.querySelectorAll(s));
  const rows = $("#rows");
  const listState=$("#listState"), stState=$("#stState"), bbState=$("#bbState");
  const statusSel=$("#statusSel"), limitSel=$("#limitSel");
  const bbGame=$("#bbGame"), bbPicks=$("#bbPicks"), bbStake=$("#bbStake"), bbPlace=$("#bbPlace");

  let myBets = [];

  const fmtLBX = n => `${Number(n||0).toLocaleString()} LBX`;
  const asNum  = v => { const n=Number(v); return Number.isFinite(n)?n:0; };
  const pill   = s => `<span class="status ${String(s||"").toLowerCase()}">${String(s||"")}</span>`;

  function calcOpenStats(list){
    const open = list.filter(b => (b.status === "placed"));
    const staked = open.reduce((a,b)=> a + asNum(b.amount), 0);
    const potential = open.reduce((a,b)=> a + asNum(b.potentialPayout||0), 0);
    $("#stOpen").textContent = String(open.length);
    $("#stStaked").textContent = fmtLBX(staked);
    $("#stPotential").textContent = fmtLBX(potential);
  }

  function paintList(list){
    rows.innerHTML = "";
    if (!list.length){
      rows.innerHTML = '<tr><td colspan="7" class="muted" style="padding:14px">No bets found.</td></tr>';
      return;
    }
    for (const b of list){
      const picks = Array.isArray(b.picks)
        ? b.picks.map(p=>p.label||p.choice||p.name||"Pick").map(t=>`<span class="pick">${t}</span>`).join(" ")
        : (b.pickLabel || "—");
      const result = (b.status==="settled")
        ? (b.payout>0 ? `+${fmtLBX(b.payout)}` : fmtLBX(0))
        : (b.status==="voided" ? "REFUND" : "—");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(b.createdAt || b.placedAt || Date.now()).toLocaleString()}</td>
        <td><b>${b.game || b.type || "Bet"}</b></td>
        <td>${picks}</td>
        <td>${fmtLBX(b.amount)}</td>
        <td>${pill(b.status||"placed")}</td>
        <td>${fmtLBX(b.potentialPayout || 0)}</td>
        <td>${result}</td>
      `;
      rows.appendChild(tr);
    }
  }

  async function loadMyBets(){
    listState.textContent = "loading…";
    rows.innerHTML = '<tr><td colspan="7" class="muted" style="padding:14px">Loading…</td></tr>';
    try{
      const qs = api.qs({
        status: statusSel.value || undefined,
        limit:  Number(limitSel.value||50),
      });
      const j = await api.get(`/api/bets/my${qs}`);
      myBets = Array.isArray(j?.bets) ? j.bets : [];
      listState.textContent = `loaded ${myBets.length}`;
      paintList(myBets);
      calcOpenStats(myBets);
    }catch(e){
      listState.textContent = (e.message||"failed").replace(/_/g," ");
      rows.innerHTML = `<tr><td colspan="7" class="err" style="padding:14px">${(e.message||"failed").replace(/_/g," ")}</td></tr>`;
    }
  }

  async function placeBet(){
    const game  = (bbGame.value||"").trim();
    const picks = (bbPicks.value||"").split(",").map(s=>s.trim()).filter(Boolean).map(label=>({ label }));
    const amount= asNum(bbStake.value||0);
    if (!game)  { bbState.textContent = "game required"; bbState.className="err"; return; }
    if (!amount || amount<=0){ bbState.textContent = "stake must be > 0"; bbState.className="err"; return; }
    if (!picks.length){ bbState.textContent = "enter at least one pick"; bbState.className="err"; return; }

    bbPlace.disabled = true; bbState.textContent="placing…"; bbState.className="muted";
    try{
      const j = await api.post("/api/bets/place", { game, picks, amount });
      // server should return { ok, bet, lbx } (new balance)
      window.dispatchEvent(new CustomEvent("wallet:update", { detail:{ lbx: j?.lbx } }));
      // soft reset builder
      bbStake.value = 1; bbPicks.value="";
      bbState.textContent="placed"; bbState.className="ok";
      // refresh list + stats
      await loadMyBets();
    }catch(e){
      bbState.textContent = (e.message||"failed").replace(/_/g," ");
      bbState.className="err";
    }finally{
      bbPlace.disabled = false;
    }
  }

  // events
  $("#refresh")?.addEventListener("click", loadMyBets);
  statusSel.addEventListener("change", loadMyBets);
  limitSel.addEventListener("change", loadMyBets);
  bbPlace.addEventListener("click", placeBet);

  // boot
  (async function boot(){
    await loadMyBets();
  })();
})();
</script>
</body>
</html>
