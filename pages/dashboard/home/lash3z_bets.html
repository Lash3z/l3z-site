<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bets — L3Z</title>
  <style>
    body{background:#0b0e13;color:#e8ecf3;font-family:Segoe UI,system-ui,Arial,sans-serif;margin:0}
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .pill{padding:6px 10px;border:1px solid rgba(0,255,255,.18);border-radius:999px;background:#0a1016}
    .panel{background:linear-gradient(180deg,#0e1319,#0b1016);border:1px solid rgba(0,255,255,.18);border-radius:14px}
    .slip{position:sticky;top:10px;display:flex;flex-direction:column}
    .btn{border:none;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer;background:linear-gradient(180deg,#f2b64a,#d49a2e);color:#1a1204}
    .msg{font-size:12px}.ok{color:#9ff1c7}.err{color:#ffb5be}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h1>Bets</h1>
      <div class="pill" id="who">Welcome</div>
      <div class="pill" id="bal">LBX 0</div>
    </header>

    <div style="display:grid;grid-template-columns:1fr 380px;gap:16px">
      <div class="panel" id="markets" style="min-height:240px;padding:12px">
        <!-- populate from localStorage 'sb:markets:unified' (unchanged) -->
        <div class="msg">Markets are published from the Admin Hub.</div>
      </div>

      <div class="panel slip" style="height:calc(100dvh - 110px)">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px">
          <div><b>Picks</b> <span class="pill" id="slipCount">0</span></div>
          <button id="clearSlip" class="btn" style="opacity:.8">Clear</button>
        </div>
        <div id="slipBody" style="flex:1;overflow:auto;padding:8px 12px"></div>
        <div style="padding:12px;display:grid;gap:8px">
          <label>Stake <input id="stake" type="number" min="1" max="100" step="1" value="10" style="width:110px"/></label>
          <div>Estimated Winnings: <b id="payout">0</b> LBX</div>
          <div id="warn" class="msg"></div>
          <button id="submit" class="btn" disabled>Place Bet</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";
  const $=(q,r)=> (r||document).querySelector(q);
  const $$=(q,r)=> Array.from((r||document).querySelectorAll(q));
  const esc=s=>String(s??'').replace(/[&<>\"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  const bux=n=> (Number(n)||0).toLocaleString(undefined,{maximumFractionDigits:0});
  const kid=(p='ID')=> p+Math.random().toString(36).slice(2,10).toUpperCase();

  let slip = []; // {marketId,label,odds,...}
  let slipMode = 'single';

  // Server wallet only
  async function api(path, opts){ const res = await fetch(path, { credentials:"include", cache:"no-store", ...(opts||{}) }); const j=await res.json(); if(!res.ok) throw j; return j; }
  async function refreshBal(){
    try{ const j=await api("/api/wallet/me"); $("#who").textContent = "Welcome, "+(j.username||"PLAYER"); $("#bal").textContent = "LBX "+bux(j.wallet?.balance||0); }
    catch(e){ console.warn("balance load failed", e); }
  }

  function addToSlip(item){ slip.push(item); updateSlipUI(); }
  function updateSlipUI(){
    $("#slipCount").textContent = slip.length;
    const body=$("#slipBody"); body.innerHTML='';
    slip.forEach((t,i)=>{
      const row=document.createElement('div'); row.style.border='1px solid rgba(0,255,255,.18)'; row.style.borderRadius='10px'; row.style.padding='8px 10px'; row.style.margin='6px 0';
      row.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${esc(t.label)}</b></div><a href="#" data-i="${i}">✖</a></div>`
                    + (t.odds ? `<div style="opacity:.8">Odds ${Number(t.odds).toFixed(2)}×</div>` : '');
      row.querySelector('a')?.addEventListener('click', (ev)=>{ ev.preventDefault(); slip.splice(i,1); updateSlipUI(); });
      body.appendChild(row);
    });
    updateTotals();
  }
  function updateTotals(){
    const stake = Number($("#stake")?.value||0) || 0;
    let est=0; if (slipMode==='single'){ est = slip.reduce((a,x)=> a + (stake * (x.odds||1)), 0); } else { est = stake * slip.reduce((p,x)=> p*(x.odds||1), 1); }
    $("#payout").textContent = bux(est);
    const totalStake = (slipMode==='single') ? stake * slip.length : stake;
    let warn='';
    if(!slip.length) warn='Add a selection.';
    else if(!stake) warn='Enter stake.';
    else if(totalStake>100) warn='Max 100 LBX.';
    $("#warn").textContent = warn; $("#warn").className='msg '+(warn?'err':'ok');
    $("#submit").disabled = !!warn;
  }

  $("#stake")?.addEventListener('input', updateTotals);
  $("#clearSlip")?.addEventListener('click', ()=>{ slip=[]; updateSlipUI(); });
  $("#submit")?.addEventListener('click', async ()=>{
    const stake = Number($("#stake")?.value||0) || 0;
    const totalStake = (slipMode==='single') ? stake * slip.length : stake;
    if(!slip.length || !stake || totalStake>100){ updateTotals(); return; }
    try{
      const resp = await api("/api/bets/place", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ mode: slipMode, stake, legs: slip })
      });
      $("#warn").textContent = `Bet placed. New balance: ${resp.balance} LBX`; $("#warn").className='msg ok';
      slip=[]; updateSlipUI(); await refreshBal();
    }catch(e){
      $("#warn").textContent = `Bet failed: ${e?.error || 'error'}`; $("#warn").className='msg err';
    }
  });

  // Boot
  refreshBal(); updateSlipUI();
})();
</script>
</body>
</html>
