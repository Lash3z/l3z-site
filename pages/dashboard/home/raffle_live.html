<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raffle Live</title>
<style>
  :root{ --bg:#0b0f10; --ink:#eaf7ff; --muted:#9bc; --panel:#0f1416; --ring:rgba(0,255,255,.22); --gold:#ffb42d; }
  *,*:before,*:after{box-sizing:border-box}
  html,body{margin:0;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:16px;padding:12px;background:rgba(0,0,0,.7);border-bottom:1px solid var(--ring)}
  .title{font-weight:900;letter-spacing:.4px;color:var(--gold);text-shadow:0 0 14px rgba(255,180,45,.35)}
  .grow{flex:1}
  .lbx-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:14px;border:1px solid rgba(0,255,255,.18);
    background:#0b1f21;color:#cfffff;font-weight:800;font-size:12px;box-shadow:0 0 12px rgba(0,255,255,.10)}
  .lbx-dot{width:8px;height:8px;border-radius:50%;background:#ffb42d;box-shadow:0 0 8px #ffb42d66}
  .wrap{max-width:1000px;margin:18px auto;padding:0 12px}
  .card{background:linear-gradient(180deg,#0f1416,#0a1113);border:1px solid var(--ring);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:16px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0b1f21;color:#cfffff;font-weight:800}
  input,button{height:42px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:var(--ink);padding:8px 12px;outline:none}
  button{cursor:pointer;font-weight:800}
  button.primary{background:linear-gradient(180deg,#0ef,#00dfc6);-webkit-background-clip:text;background-clip:text;color:transparent;border-color:#0ef}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .list{display:flex;flex-wrap:wrap;gap:8px}
  .entry{padding:6px 10px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:#0a1518;font-size:12px}
  .big{font-size:24px;font-weight:900;margin:0}
  .center{display:flex;justify-content:center;align-items:center}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.18s}
  .toast.on{opacity:1;transform:translateY(0)}
  html[data-auth="checking"] body { opacity: 0; transition: opacity .12s ease; }
</style>

<!-- AUTH GATE -->
<script>
(function(){
  "use strict";
  const LOGIN="/pages/dashboard/home/login.html";
  const SESSION_KEY="l3z:session", PROFILE_KEY="l3z:user", UNAME_KEY="user:username", LAST_KEY="lash3z_last_user";
  const WALLET = u=>`lbx:wallet:${(u||'').toUpperCase()}`, LEDGER=u=>`lbx:ledger:${(u||'').toUpperCase()}`;
  const now=()=>Date.now(); const up=s=>(s||"").toString().trim().toUpperCase();
  function sget(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch{ return null; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
  function ensureWallet(u){ let w=sget(WALLET(u)); if(!w){ w={balance:50,created:now(),lastDaily:0}; sset(WALLET(u),w);
    sset(LEDGER(u),[{ts:now(),delta:+50,reason:'WELCOME_BONUS',balance:50}]); } return w; }
  function badgeUpdate(u){ const w=ensureWallet(u); const t=document.getElementById('lbxAmt'); if(t) t.textContent=(+w.balance||0).toFixed(2); }
  function redirectToLogin(){ const back=encodeURIComponent(location.pathname+location.search+location.hash);
    location.replace(`${LOGIN}?redirect=${back}`); }

  document.documentElement.setAttribute("data-auth","checking");
  const sess=sget(SESSION_KEY);
  if(!sess || !sess.user || Number(sess.expiresAt)<=now()){ redirectToLogin(); throw new Error("no session"); }
  const USER=up(sess.user);
  localStorage.setItem(UNAME_KEY,USER); localStorage.setItem(LAST_KEY,USER); sset(PROFILE_KEY,{username:USER});
  window.__L3Z_USER__=USER; window.__L3Z_BALANCE__=()=>ensureWallet(USER).balance;

  window.addEventListener("DOMContentLoaded",()=>{
    const u = USER;
    const nameEl = document.getElementById("welcomeName"); if(nameEl) nameEl.textContent = u;
    badgeUpdate(u);
    const userInp = document.getElementById('user');
    if (userInp && !userInp.value) userInp.value = u;
    document.documentElement.removeAttribute("data-auth");
  });
})();
</script>
</head>
<script>
  window.API_BASE = (location.hostname==='127.0.0.1'||location.hostname==='localhost')
    ? 'http://localhost:3000' 
    : ''; // same-origin in production
</script>

<body>
  <div class="topbar">
    <div class="title">Raffle — Live</div>
    <div class="grow"></div>
    <div class="pill">Welcome, <span id="welcomeName">PLAYER</span></div>
    <div class="lbx-badge" id="lbxBadge"><span class="lbx-dot"></span><span id="lbxAmt">0</span><span class="muted">LBX</span></div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="muted">Raffle ID: <span id="rid">—</span></div>
        <div class="muted">Total Entries: <b id="count">0</b></div>
      </div>

      <div class="cols" style="margin-top:12px">
        <div>
          <h3 class="big">Participants</h3>
          <div id="list" class="list"></div>
        </div>
        <div class="center">
          <div style="text-align:center">
            <p class="muted">You can join this raffle once.</p>
            <form id="joinForm" class="row" style="justify-content:center" autocomplete="off" novalidate>
              <input id="user" placeholder="USERNAME" readonly style="width:220px" aria-label="Username"/>
              <button id="joinBtn" class="primary" type="submit">Join Raffle</button>
            </form>
            <div class="row" style="justify-content:center;margin-top:8px">
              <span id="status" class="pill" aria-live="polite">Checking…</span>
              <span id="stamp" class="pill" style="display:none"></span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="toast" class="toast">Saved.</div>

<script>
/* Live Server (5501) – route /api to local Node and include credentials */
(function(){
  var API_BASE = (location.port === '5501') ? 'http://127.0.0.1:3000' : '';
  var _fetch = window.fetch ? window.fetch.bind(window) : null;
  if (_fetch){
    window.fetch = function(input, init){
      init = init || {};
      if (typeof input === 'string' && input.indexOf('/api/') === 0){
        input = API_BASE + input;
        if (!init.credentials) init.credentials = 'include';
        if (!init.cache) init.cache = 'no-store';
      }
      return _fetch(input, init);
    };
  }
})();

(function(){
  "use strict";
  var $=function(s){ return document.querySelector(s); };
  var esc=function(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); };
  var up=function(s){ return String(s||'').trim().toUpperCase(); };
  var toast=$("#toast"); function toastMsg(t){ toast.textContent=t; toast.classList.add('on'); setTimeout(()=>toast.classList.remove('on'),1400); }

  // Raffle identity: ?id=... else daily default
  var qp = new URLSearchParams(location.search);
  var RID = qp.get("id") || ("raffle:"+new Date().toISOString().slice(0,10));
  var ridEl=$("#rid"); if(ridEl) ridEl.textContent = RID;

  var userEl=$("#user"), joinBtn=$("#joinBtn"), statusEl=$("#status"), countEl=$("#count"), listEl=$("#list"), joinForm=$("#joinForm"), stampEl=$("#stamp");

  // Local fallback storage
  var K_LOCAL = "raffle:entries:"+RID;
  function sget(k,def){ try{ var v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(_){ return def; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }

  function mergeUniqueUsers(list){
    var seen = new Set(); var out=[];
    for (var i=0;i<list.length;i++){
      var u = up(list[i] && list[i].user);
      if (!u || seen.has(u)) continue;
      seen.add(u); out.push({user:u});
    }
    // cap to keep local size bounded
    if (out.length>1000) out = out.slice(out.length-1000);
    return out;
  }

  async function getEntriesAPI(){
    var r = await fetch("/api/raffles/"+encodeURIComponent(RID)+"/entries", { credentials:"include", cache:"no-store" });
    if(!r.ok) throw new Error("HTTP "+r.status);
    var j = await r.json();
    return Array.isArray(j.entries)? j.entries.map(e=>({user:up(e.user)})) : [];
  }

  async function postEntryAPI(user){
    var r = await fetch("/api/raffles/"+encodeURIComponent(RID)+"/entries", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ user })
    });
    if(!r.ok) throw new Error("HTTP "+r.status);
    return r.json();
  }

  // Polling with overlap prevention
  var pollCtrl = null, pollTimer = null;
  async function paint(){
    try{
      // Fetch server entries
      if (pollCtrl) pollCtrl.abort();
      pollCtrl = ('AbortController' in window) ? new AbortController() : null;
      var opts = { cache:'no-store' }; if(pollCtrl) opts.signal = pollCtrl.signal;
      var server = await getEntriesAPI(opts).catch(()=>null);
      var local = sget(K_LOCAL, []);

      var combined = server ? mergeUniqueUsers(server.concat(local)) : mergeUniqueUsers(local);
      // If we got server data, refresh local mirror
      if (server) sset(K_LOCAL, combined);

      countEl.textContent = combined.length;
      listEl.innerHTML = combined.length
        ? combined.map(e=>`<span class="entry">${esc(e.user)}</span>`).join('')
        : `<span class="muted">No entries yet.</span>`;

      var u = up(userEl && userEl.value);
      var entered = !!combined.find(e=> e.user === u);
      statusEl.textContent = entered ? "You're in!" : "Not entered";
      joinBtn.disabled = entered;
    }catch(e){
      // Server unavailable: fall back to local
      var localOnly = mergeUniqueUsers(sget(K_LOCAL, []));
      countEl.textContent = localOnly.length;
      listEl.innerHTML = localOnly.length
        ? localOnly.map(e=>`<span class="entry">${esc(e.user)}</span>`).join('')
        : `<span class="muted">No entries yet (offline).</span>`;
      var u = up(userEl && userEl.value);
      var entered = !!localOnly.find(e=> e.user === u);
      statusEl.textContent = entered ? "You're in! (local)" : "Not entered (offline)";
      joinBtn.disabled = entered ? true : false;
    } finally {
      // schedule next poll (single timer)
      if (pollTimer) clearTimeout(pollTimer);
      pollTimer = setTimeout(paint, 4000);
    }
  }

  // Join flow with optimistic local write + rate limit
  var lastJoinTs = 0;
  async function handleJoin(e){
    e.preventDefault();
    var u = up(userEl && userEl.value);
    if(!u){ toastMsg('Not logged in'); return; }

    var now = Date.now();
    if (now - lastJoinTs < 8000){ toastMsg('Please wait…'); return; }
    lastJoinTs = now;

    joinBtn.disabled = true; statusEl.textContent = "Submitting…";
    // Optimistic: write to local immediately
    var local = sget(K_LOCAL, []);
    local.push({user:u});
    sset(K_LOCAL, mergeUniqueUsers(local));
    stampEl.style.display='inline-block'; stampEl.textContent='Last action @ '+new Date().toLocaleTimeString();
    await paint();

    // Try server write
    try{
      var j = await postEntryAPI(u);
      if (j && (j.ok || j.already)) toastMsg('Entry submitted');
      else toastMsg('Submitted');
    }catch(_e){
      // stays local; polling will reconcile if/when API returns
      toastMsg('Saved locally (offline mode)');
    }finally{
      await paint();
    }
  }

  function bootUsername(){
    // Prefer auth gate’s injected user
    var u = window.__L3Z_USER__ ? String(window.__L3Z_USER__) : '';
    if (!u){
      // fallback: cookie “viewer” set by login page
      var m = document.cookie.match(/(?:^|;\s*)viewer=([^;]*)/);
      u = m ? decodeURIComponent(m[1]||'') : '';
    }
    if (userEl && !userEl.value) userEl.value = up(u);
  }

  // Wire
  joinForm.addEventListener('submit', handleJoin);

  // Init
  bootUsername();
  paint();
  // Repaint when storage changes in other tabs/windows
  window.addEventListener('storage', function(e){
    if (e && e.key === K_LOCAL) paint();
  });
})();
</script>
</body>
</html>
