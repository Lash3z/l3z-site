<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raffles — L3Z</title>
<style>
  :root{ --bg:#0b0f10; --ink:#eaf7ff; --muted:#9bc; --ring:rgba(0,255,255,.22); --gold:#ffb42d; }
  *,*:before,*:after{box-sizing:border-box}
  html,body{margin:0;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:16px;padding:12px;background:rgba(0,0,0,.7);border-bottom:1px solid var(--ring)}
  .title{font-weight:900;letter-spacing:.4px;color:var(--gold)}
  .wrap{max-width:1000px;margin:18px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg,#0f1416,#0a1113);border:1px solid var(--ring);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:14px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0b1f21;color:#cfffff;font-weight:800}
  .btn{height:40px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:var(--ink);padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.ok{border-color:#0ef;background:linear-gradient(180deg,#0ef,#00dfc6);-webkit-background-clip:text;background-clip:text;color:transparent}
  .muted{color:var(--muted);font-size:13px}
  .list{display:flex;flex-wrap:wrap;gap:6px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.18s}
  .toast.on{opacity:1;transform:translateY(0)}
</style>

<script>
/* --- simple auth & helpers --- */
(function(){
  const now=()=>Date.now(), up=s=>(s||"").toString().trim().toUpperCase();
  function sget(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch{ return null; } }
  const sess = sget("l3z:session");
  if(!sess || !sess.user || Number(sess.expiresAt)<=now()){
    const back=encodeURIComponent(location.pathname+location.search+location.hash);
    location.replace(`/pages/dashboard/home/login.html?redirect=${back}`);
  } else {
    window.__L3Z_USER__ = up(sess.user);
  }
})();
</script>
</head>
<body>
  <div class="topbar">
    <div class="title">Raffles</div>
    <div style="margin-left:auto" class="pill">Welcome, <span id="welcome">PLAYER</span></div>
  </div>

  <div class="wrap">
    <div id="info" class="muted" style="margin-bottom:10px">Loading raffles…</div>
    <div id="raffleGrid" class="grid"></div>
  </div>

  <div id="toast" class="toast">Saved.</div>

<script>
(function(){
  "use strict";
  const USER = window.__L3Z_USER__;
  const $=s=>document.querySelector(s), grid=$("#raffleGrid"), info=$("#info"), toastEl=$("#toast");
  $("#welcome").textContent = USER;
  const up=s=>(s||"").toString().trim().toUpperCase();
  const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const toast=t=>{ toastEl.textContent=t; toastEl.classList.add("on"); setTimeout(()=>toastEl.classList.remove("on"),1600); };

  // local ledger hooks so profile shows a note
  const WALLET = u=>`lbx:wallet:${up(u)}`, LEDGER = u=>`lbx:ledger:${up(u)}`;
  function sget(k,def=null){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch{ return def; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
  function ensureWallet(u){ let w=sget(WALLET(u)); if(!w){ w={balance:50,created:Date.now(),lastDaily:0}; sset(WALLET(u),w); sset(LEDGER(u),[{ts:Date.now(),delta:+50,reason:'WELCOME_BONUS',balance:50}]); } return w; }
  function ledgerNote(u, text){ ensureWallet(u); const list=sget(LEDGER(u),[]); const w=sget(WALLET(u)); list.push({ts:Date.now(),delta:0,reason:text,balance:w?.balance||0}); sset(LEDGER(u), list.slice(-200)); }

  async function jget(u){ const r=await fetch(u,{credentials:"include",cache:"no-store"}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
  async function jpost(u,b){ const r=await fetch(u,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  async function loadRaffles(){
    try{
      const list = await jget("/api/raffles/list?open=0");
      if (Array.isArray(list) && list.length){ renderList(list); return; }
    }catch{}
    try{
      const pub = await jget("/api/raffles/public");
      if (pub && (pub.active || pub.id)){ renderList([{ id: pub.id, title: pub.title, open: !!pub.open, winner: pub.winner||null }]); return; }
    }catch{}
    grid.innerHTML = ""; info.textContent = "No raffles are live yet. Check back soon.";
  }

  function renderList(items){
    info.textContent = items.length===1 ? "1 raffle available." : `${items.length} raffles.`;
    grid.innerHTML = items.map(r => cardHTML(r)).join("");
    items.forEach(r=>{
      const enterBtn = document.querySelector(`[data-enter="${cssq(r.id)}"]`);
      const listBtn  = document.querySelector(`[data-list="${cssq(r.id)}"]`);
      if (enterBtn) enterBtn.addEventListener("click", ()=>enterRaffle(r));
      if (listBtn)  listBtn.addEventListener("click", ()=>loadEntries(r));
      loadEntries(r, true);
      loadWinner(r, true);
    });
  }
  function cssq(s){ return String(s).replace(/"/g,'&quot;'); }

  function cardHTML(r){
    return `
      <div class="card" id="card-${esc(r.id)}">
        <div class="row" style="justify-content:space-between">
          <div><b>${esc(r.title||r.id)}</b> <span class="pill">${esc(r.id)}</span></div>
          <div class="pill" id="state-${esc(r.id)}">${r.open ? "Open" : "Closed"}</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn ok" data-enter="${esc(r.id)}" ${r.open? "": "disabled"}>Enter</button>
          <span class="pill" id="me-${esc(r.id)}">Checking…</span>
          <span class="pill">Entries: <b id="cnt-${esc(r.id)}">0</b></span>
          <button class="btn" data-list="${esc(r.id)}">Refresh</button>
        </div>
        <div class="list" id="list-${esc(r.id)}" style="margin-top:8px"></div>
        <div class="row" style="margin-top:8px">
          <span class="pill">Winner:</span>
          <span class="pill" id="win-${esc(r.id)}">—</span>
          <span class="muted" id="winTs-${esc(r.id)}"></span>
        </div>
      </div>`;
  }

  async function loadEntries(r, quiet=false){
    const id = r.id;
    const listEl = $(`#list-${cssq(id)}`), cntEl = $(`#cnt-${cssq(id)}`), meEl = $(`#me-${cssq(id)}`);
    try{
      const data = await jget(`/api/raffles/${encodeURIComponent(id)}/entries`);
      const arr = Array.isArray(data.entries)? data.entries : [];
      cntEl.textContent = arr.length;
      // show the list but keep it compact
      listEl.innerHTML = arr.slice(-30).map(e=>`<span class="pill">${esc(e.user)}</span>`).join("") || `<span class="muted">No entries yet.</span>`;
      const me = arr.some(e => up(e.user)===up(USER));
      meEl.textContent = me ? "You're in!" : "Not entered";
      const btn = document.querySelector(`[data-enter="${cssq(id)}"]`);
      if (btn) btn.disabled = me || !r.open;
    }catch(e){
      if(!quiet) toast("Entries failed");
      listEl.innerHTML = `<span class="muted">Entries unavailable.</span>`;
    }
  }

  async function loadWinner(r, quiet=false){
    const id = r.id; const winEl = $(`#win-${cssq(id)}`), tsEl = $(`#winTs-${cssq(id)}`);
    try{
      const jw = await jget(`/api/raffles/${encodeURIComponent(id)}/winner`);
      const w = jw?.winner;
      if (w && w.user){ winEl.textContent = w.user; tsEl.textContent = w.ts ? new Date(w.ts).toLocaleString() : ""; }
      else { winEl.textContent = "—"; tsEl.textContent = ""; }
    }catch(e){ if(!quiet) toast("Winner load failed"); }
  }

  async function enterRaffle(r){
    const id = r.id;
    const btn = document.querySelector(`[data-enter="${cssq(id)}"]`);
    const meEl = $(`#me-${cssq(id)}`);
    btn.disabled = true;
    try{
      // Use the working legacy route you already expose
      const j = await jpost(`/api/raffles/${encodeURIComponent(id)}/entries`, { user: USER });
      meEl.textContent = "You're in!";
      toast("Entry submitted");
      // add ledger note so it shows on profile
      const title = r.title || id;
      ledgerNote(USER, `RAFFLE_ENTRY: ${title}`);
      // “entry disappears” UX: disable the button and refresh counts
      await loadEntries(r, true);
    }catch(e){
      btn.disabled = false;
      toast("Submit failed");
    }
  }

  ensureWallet(USER);
  loadRaffles();
  setInterval(loadRaffles, 7000);
})();
</script>
</body>
</html>
