<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raffles — L3Z</title>
<style>
  :root{ --bg:#0b0f10; --ink:#eaf7ff; --muted:#9bc; --ring:rgba(0,255,255,.22); --gold:#ffb42d; --ok:#00ffff; }
  *,*:before,*:after{box-sizing:border-box}
  html,body{margin:0;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:16px;padding:12px;background:rgba(0,0,0,.7);border-bottom:1px solid var(--ring)}
  .title{font-weight:900;letter-spacing:.4px;color:var(--gold)}
  .wrap{max-width:1000px;margin:18px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg,#0f1416,#0a1113);border:1px solid var(--ring);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:14px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0b1f21;color:#cfffff;font-weight:800}
  .btn{height:40px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:var(--ink);padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.ok{border-color:#0ef;background:linear-gradient(180deg,#0ef,#00dfc6);-webkit-background-clip:text;background-clip:text;color:transparent}
  .muted{color:var(--muted);font-size:13px}
  .list{display:flex;flex-wrap:wrap;gap:6px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.18s}
  .toast.on{opacity:1;transform:translateY(0)}
</style>

<script>
/* ---- Very light auth gate ---- */
(function(){
  const now=()=>Date.now(), up=s=>(s||"").toString().trim().toUpperCase();
  function sget(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch{ return null; } }
  const sess = sget("l3z:session");
  if(!sess || !sess.user || Number(sess.expiresAt)<=now()){
    const back=encodeURIComponent(location.pathname+location.search+location.hash);
    location.replace(`/pages/dashboard/home/login.html?redirect=${back}`);
  } else {
    window.__L3Z_USER__ = up(sess.user);
  }
})();
</script>
</head>
<body>
  <div class="topbar">
    <div class="title">Raffles</div>
    <div style="margin-left:auto" class="pill">Welcome, <span id="welcome">PLAYER</span></div>
  </div>

  <div class="wrap">
    <div id="info" class="muted" style="margin-bottom:10px">Loading raffles…</div>
    <div id="raffleGrid" class="grid"></div>
  </div>

  <div id="toast" class="toast">Saved.</div>

<script>
(function(){
  "use strict";
  const USER = window.__L3Z_USER__;
  const $=s=>document.querySelector(s), grid=$("#raffleGrid"), info=$("#info"), toastEl=$("#toast");
  $("#welcome").textContent = USER;

  const up=s=>(s||"").toString().trim().toUpperCase();
  const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const toast=t=>{ toastEl.textContent=t; toastEl.classList.add("on"); setTimeout(()=>toastEl.classList.remove("on"),1600); };

  async function jget(u){ const r=await fetch(u,{credentials:"include",cache:"no-store"}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
  async function jpost(u,b){ const r=await fetch(u,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
  async function jput(u,b){ const r=await fetch(u,{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

  /* ------------------------------
     Load list of raffles (multi -> single fallback)
     ------------------------------ */
  async function loadRaffles(){
    try{
      const list = await jget("/api/raffles/list?open=0"); // expects [{id,title,open,winner?},...]
      if (Array.isArray(list) && list.length){ renderList(list); return; }
    }catch{}
    try{
      const pub = await jget("/api/raffles/public");
      if (pub && (pub.active || pub.id)){
        renderList([{ id: pub.id, title: pub.title, open: !!pub.open, winner: pub.winner||null }]);
        return;
      }
    }catch{}
    grid.innerHTML = "";
    info.textContent = "No raffles are live yet. Check back soon.";
  }

  function renderList(items){
    info.textContent = items.length===1 ? "1 raffle available." : `${items.length} raffles.`;
    grid.innerHTML = items.map(r => cardHTML(r)).join("");
    items.forEach(r=>{
      const enterBtn = document.querySelector(`[data-enter="${cssq(r.id)}"]`);
      const listBtn  = document.querySelector(`[data-list="${cssq(r.id)}"]`);
      if (enterBtn) enterBtn.addEventListener("click", ()=>enterRaffle(r));
      if (listBtn)  listBtn.addEventListener("click", ()=>loadEntries(r));
      loadEntries(r, true);
      loadWinner(r, true);
    });
  }
  function cssq(s){ return String(s).replace(/"/g,'&quot;'); }

  function cardHTML(r){
    const openTxt = r.open ? "Open" : "Closed";
    return `
      <div class="card" id="card-${esc(r.id)}">
        <div class="row" style="justify-content:space-between">
          <div><b>${esc(r.title||r.id)}</b> <span class="pill">${esc(r.id)}</span></div>
          <div class="pill" id="state-${esc(r.id)}">${openTxt}</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn ok" data-enter="${esc(r.id)}" ${r.open? "": "disabled"}>Enter</button>
          <span class="pill" id="me-${esc(r.id)}">Checking…</span>
          <span class="pill">Entries: <b id="cnt-${esc(r.id)}">0</b></span>
          <button class="btn" data-list="${esc(r.id)}">Refresh list</button>
        </div>
        <div class="list" id="list-${esc(r.id)}" style="margin-top:8px"></div>
        <div class="row" style="margin-top:8px">
          <span class="pill">Winner:</span>
          <span class="pill" id="win-${esc(r.id)}">—</span>
          <span class="muted" id="winTs-${esc(r.id)}"></span>
        </div>
      </div>`;
  }

  /* ------------------------------
     Entries + Winner
     ------------------------------ */
  async function loadEntries(r, quiet=false){
    const id = r.id;
    const listEl = $(`#list-${cssq(id)}`), cntEl = $(`#cnt-${cssq(id)}`), meEl = $(`#me-${cssq(id)}`);
    try{
      // PRIMARY: your existing working route
      let data = await jget(`/api/raffles/${encodeURIComponent(id)}/entries`);
      const arr = Array.isArray(data.entries)? data.entries : [];
      cntEl.textContent = arr.length;
      listEl.innerHTML = arr.map(e=>`<span class="pill">${esc(e.user)}</span>`).join("") || `<span class="muted">No entries yet.</span>`;
      const me = arr.some(e => up(e.user)===up(USER));
      meEl.textContent = me ? "You're in!" : "Not entered";
    }catch(e){
      if(!quiet) toast("Entries failed: "+String(e.message||e));
      listEl.innerHTML = `<span class="muted">Entries unavailable.</span>`;
    }
  }

  async function loadWinner(r, quiet=false){
    const id = r.id;
    const winEl = $(`#win-${cssq(id)}`), tsEl = $(`#winTs-${cssq(id)}`);
    try{
      let w=null;
      // Try explicit winner endpoint
      try { const jw = await jget(`/api/raffles/${encodeURIComponent(id)}/winner`); w = jw?.winner||null; }
      catch {
        // fallback: if server exposes current with winner
        await jput("/api/raffles/current", { id });
        const pub = await jget("/api/raffles/public");
        w = pub?.winner || null;
      }
      if (w && w.user){
        winEl.textContent = w.user;
        tsEl.textContent = w.ts ? new Date(w.ts).toLocaleString() : "";
      } else {
        winEl.textContent = "—";
        tsEl.textContent = "";
      }
    }catch(e){
      if(!quiet) toast("Winner failed: "+String(e.message||e));
    }
  }

  /* ------------------------------
     Enter a raffle (fixed: legacy-first)
     ------------------------------ */
  async function enterRaffle(r){
    const id = r.id;
    const btn = document.querySelector(`[data-enter="${cssq(id)}"]`);
    const meEl = $(`#me-${cssq(id)}`);
    btn.disabled = true;
    try{
      // 1) Use your existing working route
      await jpost(`/api/raffles/${encodeURIComponent(id)}/entries`, { user: USER });

      meEl.textContent = "You're in!";
      toast("Entry submitted");
      loadEntries(r, true);
    }catch(e1){
      // 2) Fallbacks only if needed
      try{
        await jpost(`/api/raffles/${encodeURIComponent(id)}/enter`, { user: USER });
        meEl.textContent = "You're in!";
        toast("Entry submitted");
        loadEntries(r, true);
      }catch(e2){
        try{
          await jput("/api/raffles/current", { id });
          await jpost("/api/raffles/enter", { user: USER });
          meEl.textContent = "You're in!";
          toast("Entry submitted");
          loadEntries(r, true);
        }catch(e3){
          btn.disabled = false;
          toast("Submit failed: " + [e1?.message||"", e2?.message||"", e3?.message||""].filter(Boolean).join(" | "));
        }
      }
    }
  }

  loadRaffles();
  setInterval(loadRaffles, 6000);
})();
</script>
</body>
</html>
