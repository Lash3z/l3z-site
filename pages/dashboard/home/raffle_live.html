<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raffles — L3Z</title>
<style>
  :root{ --bg:#0b0f10; --ink:#eaf7ff; --muted:#9bc; --panel:#0f1416; --ring:rgba(0,255,255,.22); --ok:#12d48a; --bad:#e25a6f; }
  *{box-sizing:border-box}
  html,body{margin:0;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 12px}
  .card{background:linear-gradient(180deg,#0f1416,#0a1113);border:1px solid var(--ring);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0b1f21;color:#cfffff;font-weight:800}
  .btn{height:38px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:var(--ink);padding:6px 12px;font-weight:800;cursor:pointer}
  .btn.ok{border-color:#0ef;background:linear-gradient(180deg,#0ef,#00dfc6);-webkit-background-clip:text;background-clip:text;color:transparent}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .muted{color:var(--muted);font-size:13px}
  .raff{border:1px solid var(--ring);border-radius:12px;padding:12px;margin-bottom:12px;background:#0a1216}
  .right{margin-left:auto}
</style>

<script>
/* simple auth presence: reuse l3z:session (you already use this) */
(function(){
  const LOGIN="/pages/dashboard/home/login.html";
  const now=()=>Date.now();
  function sget(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch{ return null; } }
  const sess=sget("l3z:session");
  if(!sess || !sess.user || Number(sess.expiresAt)<=now()){
    const back=encodeURIComponent(location.pathname+location.search+location.hash);
    location.replace(`${LOGIN}?redirect=${back}`);
    throw new Error("no session");
  }
  window.__USER__ = String(sess.user||"").toUpperCase();
})();
</script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="pill">Raffles</div>
      <div class="pill">You are: <b id="me"></b></div>
    </div>
    <div class="muted" style="margin:8px 0">Open raffles can be entered once. Winners are announced here after draw.</div>
    <div id="list"></div>
  </div>
</div>

<script>
(function(){
  "use strict";
  const USER = window.__USER__;
  document.getElementById("me").textContent = USER;

  const $=s=>document.querySelector(s);
  const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const list=$("#list");

  async function jget(u){ const r=await fetch(u,{credentials:"include",cache:"no-store"}); if(!r.ok) throw new Error(r.status); return r.json(); }
  async function jpost(u,b){ const r=await fetch(u,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(r.status); return r.json(); }

  function block(r){
    const wrap=document.createElement("div");
    wrap.className="raff";
    wrap.innerHTML = `
      <div class="row">
        <span class="pill"><b>${esc(r.title)}</b></span>
        <span class="pill">${esc(r.rid)}</span>
        <span class="pill">${r.open?"OPEN":"CLOSED"}</span>
        <span class="right pill">Winner: ${r.winner?("<b>"+esc(r.winner)+"</b>"):"—"}</span>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ok" data-act="enter" ${(!r.open)?"disabled":""}>Enter</button>
        <span class="pill" data-id="status">Checking…</span>
        <span class="pill">Entries: <b data-id="count">0</b></span>
        <button class="btn" data-act="refresh">Refresh</button>
      </div>
    `;
    const status = wrap.querySelector('[data-id="status"]');
    const count  = wrap.querySelector('[data-id="count"]');
    async function refresh(){
      try{
        const j = await jget(`/api/raffles/${encodeURIComponent(r.rid)}/entries`);
        count.textContent = (j.entries||[]).length;
        const entered = !!(j.entries||[]).find(e=> String(e.user||"").toUpperCase()===USER );
        status.textContent = entered ? "You're in!" : (r.open ? "Not entered" : "Closed");
        wrap.querySelector('[data-act="enter"]').disabled = entered || !j.open;
        // show winner if any
        wrap.querySelector(".right").innerHTML = 'Winner: ' + (j.winner?("<b>"+esc(j.winner)+"</b>"):"—");
        r.open = j.open; // update local
      }catch{ status.textContent="Offline"; }
    }
    wrap.querySelector('[data-act="refresh"]').addEventListener("click", refresh);
    wrap.querySelector('[data-act="enter"]').addEventListener("click", async ()=>{
      try{
        await jpost(`/api/raffles/${encodeURIComponent(r.rid)}/enter`, { username: USER });
        await refresh();
      }catch{ status.textContent="Enter failed"; }
    });
    refresh();
    return wrap;
  }

  async function paint(){
    try{
      const j = await jget("/api/raffles");
      list.innerHTML="";
      (j.raffles||[]).forEach(r=> list.appendChild(block(r)) );
      if(!(j.raffles||[]).length) list.innerHTML='<div class="muted">No raffles right now.</div>';
    }catch{
      list.innerHTML='<div class="muted">Raffles are offline.</div>';
    }
  }

  paint();
  setInterval(paint, 5000);
})();
</script>
</body>
</html>
