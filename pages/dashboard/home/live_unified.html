<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Unified Live — BG / PVP / Bonus Hunt</title>
<style>
:root{--bg:#060b0d;--panel:#0b1417;--ink:#eaf7ff;--muted:#9fd0d6;--line:rgba(0,255,255,.18);--teal:#00ffff}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
h1{margin:16px 0 8px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
.wrap{max-width:1300px;margin:0 auto;padding:0 16px 48px}
.card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0f1720;color:#cfffff;cursor:pointer}
.tab.active{border-color:#00ffff88;box-shadow:0 0 14px #00ffff33}
.list{display:grid;gap:12px}
.item{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0c1216}
.sides{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
.slot{display:grid;grid-template-columns:48px 1fr;gap:8px;align-items:center}
.slot img{width:48px;height:48px;border-radius:10px;object-fit:cover;background:#071017;border:1px solid rgba(255,255,255,.06)}
.vs{opacity:.7}
.small{font-size:12px;color:#9fd0d6}
</style>
</head>
<body>
<script>
  window.API_BASE = (location.hostname==='127.0.0.1'||location.hostname==='localhost')
    ? 'http://localhost:3000'
    : ''; // same-origin in production
</script>

<div class="wrap">
  <div class="row">
    <h1>Unified Live</h1>
    <div class="tabs">
      <button class="tab" data-mode="bg">Battleground</button>
      <button class="tab" data-mode="pvp">PVP</button>
      <button class="tab" data-mode="bonus">Bonus Hunt</button>
    </div>
    <span id="badgeMode" class="pill">—</span>
    <span id="badgeTime" class="pill">Live @ —</span>
  </div>

  <div class="card">
    <div id="list" class="list">
      <div class="item small">No data yet.</div>
    </div>
  </div>
</div>

<script>
"use strict";
(function(){
  var $ = function(s){ return document.querySelector(s); };
  var $$ = function(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); };
  var up = function(s){ return String(s||"").trim().toUpperCase(); };
  var sget = function(k, d){
    if (d === void 0) d = null;
    try {
      var v = localStorage.getItem(k);
      return v ? JSON.parse(v) : d;
    } catch(_){ return d; }
  };

  function slotImgFrom(title){
    var DEF="/assets/slot_images/mateslots_logo.png";
    var special={"rip city":"rip_city","gates of olympus":"gates_of_olympus","gates":"gates_of_olympus","starlight princess":"starlight_princess"};
    if(!title) return DEF;
    var s=String(title).toLowerCase().trim();
    if(special[s]) s=special[s];
    s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/&/g,'and').replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
    return "/assets/slot_images/" + (s||"mateslots_logo") + ".png";
  }

  var mode='bg';
  var last=0;
  var painting = false; // prevent overlapping async paints

  async function readBG(){
    try{
      var r = await fetch(window.API_BASE + '/api/battleground/live',{credentials:'include',cache:'no-store'});
      if(r.ok){
        var j = await r.json();
        if(j && j.builder) return j.builder;
      }
    }catch(_){}
    return sget('bg:builder:battleground') || sget('battleground:live') || { matches:[], lastUpdated:0 };
  }
  function readPVP(){
    var d = sget('pvp:live') || { rounds:[], flat:[], lastUpdated:0, title:'PVP' };
    return d;
  }
  async function readBonus(){
    try{
      var r = await fetch(window.API_BASE + '/api/bonus-hunt/live',{credentials:'include',cache:'no-store'});
      if(r.ok){
        var j = await r.json();
        if(j && j.builder) return j.builder;
      }
    }catch(_){}
    return sget('bh:live') || sget('bonus:builder') || { games:[], lastUpdated:0 };
  }

  function setImage(img, manual, title){
    if(!img) return;
    img.onerror = null;
    img.src = manual || slotImgFrom(title);
    img.onerror = function(){ img.src='/assets/slot_images/mateslots_logo.png'; };
  }

  function safe(obj, path, fallback){
    try{
      var parts = path.split('.');
      var cur = obj;
      for(var i=0;i<parts.length;i++){
        cur = (cur && cur[parts[i]]!==undefined) ? cur[parts[i]] : undefined;
      }
      return (cur===undefined || cur===null) ? fallback : cur;
    }catch(_){ return fallback; }
  }

  function paintBG(list,data){
    var matches = Array.isArray(data.matches)?data.matches:[];
    if(!matches.length){ list.innerHTML='<div class="item small">No matchups yet.</div>'; return; }
    list.innerHTML='';
    matches.forEach(function(m){
      var leftTitle  = m.leftTitle || safe(m,'left.name','');
      var leftProv   = m.leftProv  || safe(m,'left.game','');
      var leftImg    = m.leftImg   || safe(m,'left.img','');

      var rightTitle = m.rightTitle || safe(m,'right.name','');
      var rightProv  = m.rightProv  || safe(m,'right.game','');
      var rightImg   = m.rightImg   || safe(m,'right.img','');

      var div=document.createElement('div'); div.className='item';
      div.innerHTML =
        '<div class="sides">'+
          '<div class="slot"><img alt=""><div><b>'+ up(leftTitle) +'</b><div class="small">'+ (leftProv||'') +'</div></div></div>'+
          '<div class="vs">VS</div>'+
          '<div class="slot"><img alt=""><div><b>'+ up(rightTitle) +'</b><div class="small">'+ (rightProv||'') +'</div></div></div>'+
        '</div>';

      var imgs=div.querySelectorAll('img');
      if(imgs[0]) setImage(imgs[0], leftImg,  leftTitle || leftProv);
      if(imgs[1]) setImage(imgs[1], rightImg, rightTitle || rightProv);
      list.appendChild(div);
    });
  }

  function paintPVP(list,data){
    var rounds = Array.isArray(data.rounds) ? data.rounds.slice() : [];
    var show = null;
    for(var i=rounds.length-1;i>=0;i--){
      if(rounds[i] && rounds[i].matches && rounds[i].matches.length){ show = rounds[i]; break; }
    }
    if(!show && rounds.length) show = rounds[0];

    var matches = (show && show.matches) ? show.matches : (Array.isArray(data.flat) ? data.flat : []);
    if(!matches.length){ list.innerHTML = '<div class="item small">No matchups yet.</div>'; return; }
    list.innerHTML='';

    matches.forEach(function(m){
      var lName = safe(m,'left.username', m.left) || '';
      var rName = safe(m,'right.username', m.right) || '';
      var lProv = safe(m,'left.game', m.leftProv) || '';
      var rProv = safe(m,'right.game', m.rightProv) || '';
      var lImg  = m.leftImg || safe(m,'left.img','');
      var rImg  = m.rightImg || safe(m,'right.img','');

      var winnerTxt = m.winner ? (' · Winner: ' + (m.winner==='L' ? 'LEFT' : 'RIGHT')) : '';
      var titleTxt  = (data.title || 'PVP') + (show && show.name ? (' — ' + show.name) : '') + winnerTxt;

      var div=document.createElement('div'); div.className='item';
      div.innerHTML =
        '<div class="sides">'+
          '<div class="slot"><img alt=""><div><b>'+ up(lName) +'</b><div class="small">'+ lProv +'</div></div></div>'+
          '<div class="vs">VS</div>'+
          '<div class="slot"><img alt=""><div><b>'+ up(rName) +'</b><div class="small">'+ rProv +'</div></div></div>'+
        '</div>'+
        '<div class="small">'+ titleTxt +'</div>';

      var imgs=div.querySelectorAll('img');
      if(imgs[0]) setImage(imgs[0], lImg, lProv || lName);
      if(imgs[1]) setImage(imgs[1], rImg, rProv || rName);
      list.appendChild(div);
    });
  }

  function paintBonus(list,data){
    var games = Array.isArray(data.games)?data.games:[];
    if(!games.length){ list.innerHTML='<div class="item small">No games yet.</div>'; return; }
    list.innerHTML='';
    games.forEach(function(g){
      var title = g.title || g.name || '';
      var prov  = g.provider || '';
      var imgSrc= g.img || g.logo || '';

      var div=document.createElement('div'); div.className='item';
      div.innerHTML =
        '<div class="sides">'+
          '<div class="slot"><img alt=""><div><b>'+ up(title) +'</b><div class="small">'+ prov +'</div></div></div>'+
          '<div></div><div></div>'+
        '</div>';
      var img=div.querySelector('img');
      if(img) setImage(img, imgSrc, title || prov);
      list.appendChild(div);
    });
  }

  async function paint(){
    if (painting) return; // skip if a previous paint is still running
    painting = true;

    try{
      var list=$("#list"), modeBadge=$("#badgeMode"), time=$("#badgeTime");
      if(mode==='bg'){
        modeBadge.textContent='BATTLEGROUND — BG';
        var d1=await readBG();
        last=d1.lastUpdated||0;
        time.textContent='Live @ ' + (last? new Date(last).toLocaleTimeString() : '—');
        paintBG(list,d1);
      } else if(mode==='pvp'){
        modeBadge.textContent='PVP — Knockout';
        var d2=readPVP();
        last=d2.lastUpdated||d2.ts||0;
        time.textContent='Live @ ' + (last? new Date(last).toLocaleTimeString() : '—');
        paintPVP(list,d2);
      } else {
        modeBadge.textContent='BONUS HUNT';
        var d3=await readBonus();
        last=d3.lastUpdated||d3.updated||0;
        time.textContent='Live @ ' + (last? new Date(last).toLocaleTimeString() : '—');
        paintBonus(list,d3);
      }
    } finally {
      painting = false;
    }
  }

  function setMode(m){
    mode=m;
    $$(".tab").forEach(function(t){ t.classList.toggle("active", t.getAttribute('data-mode')===m); });
    paint();
  }

  $$(".tab").forEach(function(t){
    t.addEventListener("click", function(){ setMode(t.getAttribute('data-mode')); });
  });

  window.addEventListener("storage", function(e){
    if(!e || !e.key) return;
    var rilevant =
      (mode==='pvp'   && e.key==='pvp:live') ||
      (mode==='bg'    && (e.key==='bg:builder:battleground' || e.key==='battleground:live')) ||
      (mode==='bonus' && (e.key==='bh:live' || e.key==='bonus:builder'));
    if(rilevant){ paint(); }
  });

  // gentle polling; protected by the 'painting' flag to avoid overlap
  setInterval(paint, 1500);

  setMode('bg');
})();
</script>
</body>
</html>
