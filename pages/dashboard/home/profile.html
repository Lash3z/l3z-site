<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Profile — L3Z</title>
<style>
  :root{
    --bg:#0b0f10; --ink:#eaf7ff; --muted:#9bc; --panel:#0f1416; --ring:rgba(0,255,255,.22);
    --gold:#ffb42d; --cyan:#00ffff; --ok:#12f3d6; --bad:#ff5a73;
  }
  *,*:before,*:after{box-sizing:border-box}
  html,body{margin:0;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  html[data-auth="checking"] body { opacity:0; transition:opacity .12s ease; }
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:16px;padding:12px;background:rgba(0,0,0,.7);border-bottom:1px solid var(--ring)}
  .title{font-weight:900;letter-spacing:.4px;color:var(--gold);text-shadow:0 0 14px rgba(255,180,45,.35)}
  .grow{flex:1}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0b1f21;color:#cfffff;font-weight:800}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:linear-gradient(180deg,#0f1416,#0a1113);border:1px solid var(--ring);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:16px}
  h2{margin:0 0 10px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .big{font-size:28px;font-weight:900;margin:0}
  .stat{display:flex;align-items:center;gap:10px;background:#0a1518;border:1px solid var(--ring);border-radius:12px;padding:10px 12px}
  .stat .val{font-size:22px;font-weight:900}
  .btn{height:42px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:var(--ink);padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.ok{border-color:#0ef;background:linear-gradient(180deg,#0ef,#00dfc6);-webkit-background-clip:text;background-clip:text;color:transparent}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
  th{color:#bfe}
  .right{text-align:right}
  input,select{height:40px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:#eaf7ff;padding:8px 12px;outline:none}
  .copy{cursor:pointer;border:1px dashed var(--ring);border-radius:8px;padding:6px 8px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.18s}
  .toast.on{opacity:1;transform:translateY(0)}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
</style>

<!-- AUTH GATE (server session required) -->
<script>
(function(){
  "use strict";
  const LOGIN="/pages/dashboard/home/login.html";
  const SESSION_KEY="l3z:session", PROFILE_KEY="l3z:user", UNAME_KEY="user:username", LAST_KEY="lash3z_last_user";
  const now=()=>Date.now(); const up=s=>(s||"").toString().trim().toUpperCase();

  function sget(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch{ return null; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
  function redirectToLogin(){ const back=encodeURIComponent(location.pathname+location.search+location.hash); location.replace(`${LOGIN}?redirect=${back}`); }

  document.documentElement.setAttribute("data-auth","checking");
  const sess=sget(SESSION_KEY);
  if(!sess || !sess.user || Number(sess.expiresAt)<=now()){ redirectToLogin(); throw new Error("no session"); }
  const USER=up(sess.user);
  localStorage.setItem(UNAME_KEY,USER); localStorage.setItem(LAST_KEY,USER); sset(PROFILE_KEY,{username:USER});
  window.__L3Z_USER__ = USER;

  window.addEventListener("DOMContentLoaded",()=> document.documentElement.removeAttribute("data-auth"));
})();
</script>
</head>
<body>
  <div class="topbar">
    <div class="title">My Profile</div>
    <div class="grow"></div>
    <div class="pill">Welcome, <span id="welcomeName">PLAYER</span></div>
  </div>

  <div class="wrap">
    <!-- LEFT: Overview + Daily + Giveaways + Ledger -->
    <div class="card">
      <h2>Overview</h2>
      <div class="row" style="margin-bottom:12px">
        <div class="stat"><div>Balance</div><div class="val" id="bal">0.00</div><div class="pill">LBX</div></div>
        <div class="stat"><div>Leaderboard</div><div class="val" id="rank">#—</div><div class="muted" id="rankSub">—</div></div>
      </div>

      <div class="cols">
        <div class="card" style="padding:12px">
          <h2 style="font-size:18px;margin:0 0 8px">Daily Reward</h2>
          <div class="muted" style="margin-bottom:8px">Claim <b>+5 LBX</b> once every 24 hours.</div>
          <div class="row">
            <button class="btn ok" id="claimBtn">Claim +5 LBX</button>
            <span id="claimStatus" class="pill">Ready</span>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <h2 style="font-size:18px;margin:0 0 8px">Giveaway</h2>
          <div class="muted" style="margin-bottom:8px">One click enters the **current** giveaway.</div>
          <div class="row">
            <button class="btn ok" id="enterGiveaway">Enter Giveaway</button>
            <span id="giveStatus" class="pill">Checking…</span>
          </div>
          <div class="muted" style="margin-top:8px">Giveaway ID: <b id="giveId">—</b> • Entries: <b id="giveCount">0</b></div>
          <div id="giveList" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Ledger</h2>
        <div class="muted" style="margin-bottom:8px">Server balance is the source of truth. (Local ledger shown if server ledger isn’t available.)</div>
        <table id="ledger">
          <thead><tr><th>When</th><th>Reason</th><th class="right">Δ LBX</th><th class="right">Balance</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: Top 10 + BUY LBX -->
    <div class="card">
      <h2>Top 10 Leaderboard</h2>
      <div class="muted" style="margin-bottom:8px">Local snapshot (server leaderboard can be wired later).</div>
      <table id="lbTable">
        <thead><tr><th>#</th><th>User</th><th class="right">LBX</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="card" style="margin-top:16px">
        <h2>Buy LBX</h2>
        <div class="muted" style="margin-bottom:8px">Max 30 LBX per 24 hours. Pick a package, choose a crypto, send funds, paste TXID, submit.</div>

        <div class="row" id="pkgRow" style="margin-bottom:8px"></div>

        <div class="row" style="margin-bottom:8px">
          <select id="assetSel">
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="USDT">USDT (TRC20)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="LTC">LTC (Litecoin)</option>
          </select>
          <input id="usdDue" type="text" placeholder="USD due" readonly style="width:130px"/>
        </div>

        <div class="muted">Send to this address:</div>
        <div class="row" style="margin:6px 0">
          <div id="addr" class="copy">—</div>
          <button class="btn" id="copyAddr">Copy</button>
        </div>

        <div class="muted">Reference code (put in TX memo/notes if your wallet supports it):</div>
        <div class="row" style="margin:6px 0">
          <div id="ref" class="copy">—</div>
          <button class="btn" id="copyRef">Copy</button>
        </div>

        <div class="row" style="margin:6px 0">
          <input id="txid" placeholder="Paste TXID / transaction hash"/>
        </div>

        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted" id="limitNote">You can buy up to 30 LBX today.</div>
          <button class="btn ok" id="submitOrder" disabled>Submit for Review</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved.</div>

<script>
(function(){
  "use strict";
  const USER = window.__L3Z_USER__;
  const $=s=>document.querySelector(s);
  const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const fmt=n=> (+n).toFixed(2);
  const up=s=>(s||'').toString().trim().toUpperCase();
  const now=()=>Date.now(); const DAY=86400000;

  const welcomeName=$("#welcomeName"), balEl=$("#bal"), rankEl=$("#rank"), rankSub=$("#rankSub");
  const claimBtn=$("#claimBtn"), claimStatus=$("#claimStatus");
  const ledgerBody=$("#ledger tbody"), lbTableBody=$("#lbTable tbody");
  const rewardsList=null; // (not used now — can add later)
  const toast=$("#toast");

  // Giveaway UI elems
  const enterBtn=$("#enterGiveaway"), giveStatus=$("#giveStatus"), giveIdEl=$("#giveId"), giveCount=$("#giveCount"), giveList=$("#giveList");

  // BUY LBX elems
  const pkgRow=$("#pkgRow"), assetSel=$("#assetSel"), usdDue=$("#usdDue");
  const addrEl=$("#addr"), refEl=$("#ref"), txidEl=$("#txid"), submitBtn=$("#submitOrder"), limitNote=$("#limitNote");

  // Replace with YOUR addresses
  const CRYPTO_ADDR = {
    "BTC":"bc1q0l428lsymjqrksxrnlx4m9jahzjjrnvns5a6ah",
    "ETH":"0xc59Ab6F4f71ba573F7435fA3fb730EdEdAF26884",
    "USDT":"TVfWLpQBG5m5Px7K7so3yqdiAC21o7cEub",
    "SOL":"tS4aS93waE4sPRjVVagkSaZ3wQyhfir3GzL1Lhm2eJ4",
    "LTC":"ltc1qn6klwjdalpfk8g252ypht03tktr4em7x367vm7"
  };
  const PRICE_USD = {5:2.50, 10:5.00, 15:7.00, 20:9.00, 25:10.50, 30:12.00};
  const PKGS=[5,10,15,20,25,30];
  let selectedPkg=0;

  /* -----------------------------
     SERVER HELPERS (real backend)
     ----------------------------- */
  async function apiGet(url){
    const r = await fetch(url,{credentials:"include",cache:"no-store"});
    if(!r.ok) throw new Error(r.status);
    return r.json();
  }
  async function apiPost(url, body){
    const r = await fetch(url,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})});
    if(!r.ok) throw new Error(r.status);
    return r.json();
  }

  /* -----------------------------
     WALLET (server source of truth)
     ----------------------------- */
  async function loadBalance(){
    try{
      const j = await apiGet(`/api/wallet/me?viewer=${encodeURIComponent(USER)}`);
      const bal = Number(j?.wallet?.balance||0);
      balEl.textContent = fmt(bal);
      return bal;
    }catch(e){
      // fallback: local
      const w = localGetWallet(USER);
      balEl.textContent = fmt(w.balance||0);
      return w.balance||0;
    }
  }
  async function adjustBalance(delta, reason){
    try{
      const j = await apiPost("/api/wallet/adjust",{ username: USER, delta:Number(delta||0), reason: String(reason||"ADJUST") });
      balEl.textContent = fmt(Number(j.balance||0));
      return true;
    }catch(e){
      // fallback local
      localPushLedger(USER, Number(delta||0), reason||"ADJUST");
      return false;
    }
  }

  /* -----------------------------
     GIVEAWAYS (current)
     ----------------------------- */
  async function loadGiveaway(){
    try{
      const j = await apiGet("/api/giveaways/entries");  // { ok, id, entries }
      giveIdEl.textContent = j.id || "GLOBAL";
      const arr = Array.isArray(j.entries) ? j.entries : [];
      giveCount.textContent = arr.length;
      giveList.innerHTML = arr.map(e=>`<span class="pill">${esc(e.user)}</span>`).join('') || `<span class="muted">No entries yet.</span>`;
      const entered = !!arr.find(e=> up(e.user) === up(USER) );
      giveStatus.textContent = entered ? "You're in!" : "Not entered";
      enterBtn.disabled = entered;
    }catch(e){
      giveStatus.textContent = "Giveaway offline";
    }
  }
  async function enterGiveaway(){
    enterBtn.disabled = true;
    try{
      await apiPost("/api/giveaways/enter",{ user: USER });
      giveStatus.textContent = "You're in!";
      await loadGiveaway();
    }catch(e){
      giveStatus.textContent = "Enter failed";
      enterBtn.disabled = false;
    }
  }

  /* -----------------------------
     DAILY (client-enforced cooldown)
     ----------------------------- */
  const DAILY_KEY = `lbx:daily:${USER}`;
  function nextDailyTs(){ const v=localStorage.getItem(DAILY_KEY); return v?Number(v):0; }
  function setDailyNow(){ localStorage.setItem(DAILY_KEY, String(now())); }
  function updateDailyUI(){
    const remain = (nextDailyTs()+DAY) - now();
    if(remain <= 0){ claimBtn.disabled=false; claimStatus.textContent="Ready"; }
    else{
      const h=Math.floor(remain/3600000), m=Math.floor((remain%3600000)/60000), s=Math.floor((remain%60000)/1000);
      claimBtn.disabled=true; claimStatus.textContent=`Next in ${h}h ${m}m ${s}s`;
    }
  }
  claimBtn.addEventListener('click', async ()=>{
    if((nextDailyTs()+DAY) > now()) return;
    const ok = await adjustBalance(+5, "DAILY_REWARD");
    setDailyNow(); updateDailyUI();
    toastMsg(ok?"+5 LBX claimed (server)":"+5 LBX claimed (local)");
    await loadBalance();
  });
  setInterval(updateDailyUI, 1000);

  /* -----------------------------
     LEDGER (local fallback view)
     ----------------------------- */
  const LEDGER = u=>`lbx:ledger:${up(u)}`;
  const WALLET = u=>`lbx:wallet:${up(u)}`;
  function sget(k,def=null){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch{ return def; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
  function localGetWallet(u){ return sget(WALLET(u)) || { balance:0, created:now(), lastDaily:0 }; }
  function localSetWallet(u,w){ sset(WALLET(u), w); }
  function localLedger(u){ return sget(LEDGER(u), []); }
  function localPushLedger(u,delta,reason){
    const w = localGetWallet(u);
    w.balance = Number(w.balance||0) + Number(delta||0);
    localSetWallet(u,w);
    const list = localLedger(u);
    list.push({ ts: now(), delta:+delta, reason:String(reason||'ADJUSTMENT'), balance:w.balance });
    sset(LEDGER(u), list.slice(-200));
    paintLedgerLocal(); paintLeaderLocal();
  }
  function paintLedgerLocal(){
    const L=(localLedger(USER)).slice(-50).reverse();
    ledgerBody.innerHTML = L.map(row=>`<tr><td>${new Date(row.ts).toLocaleString()}</td><td>${esc(row.reason||'')}</td><td class="right ${row.delta>=0?'':'bad'}">${row.delta>=0?'+':''}${fmt(row.delta||0)}</td><td class="right">${fmt(row.balance||0)}</td></tr>`).join('') || `<tr><td colspan="4" class="muted">No transactions yet.</td></tr>`;
  }

  /* -----------------------------
     LEADERBOARD (local snapshot)
     ----------------------------- */
  function collectWallets(){ const res=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith("lbx:wallet:")){ const u=k.split(":").pop(); const w=sget(k); if(w) res.push({user:u,balance:+(w.balance||0)}); } } return res; }
  function paintLeaderLocal(){
    const all=collectWallets().sort((a,b)=>b.balance-a.balance); const meIndex=all.findIndex(x=>x.user===up(USER));
    rankEl.textContent = "#"+(meIndex>=0?meIndex+1:"—"); rankSub.textContent = all.length?`of ${all.length}`:"—";
    const top=all.slice(0,10);
    lbTableBody.innerHTML = top.map((r,i)=>`<tr><td>${i+1}</td><td>${esc(r.user)} ${r.user===up(USER)?'<span class="pill">you</span>':''}</td><td class="right">${fmt(r.balance)}</td></tr>`).join('') || `<tr><td colspan="3" class="muted">No data yet.</td></tr>`;
  }

  /* -----------------------------
     BUY LBX (client form only)
     ----------------------------- */
  const ORDERS_KEY="lbx:orders";
  function toastMsg(t){ toast.textContent=t; toast.classList.add('on'); setTimeout(()=>toast.classList.remove('on'),1400); }
  function renderPkgs(){
    pkgRow.innerHTML = PKGS.map(n=>`<button class="btn" data-pkg="${n}">${n} LBX</button>`).join("");
    pkgRow.querySelectorAll("[data-pkg]").forEach(b=> b.addEventListener("click", ()=>{
      selectedPkg = +b.getAttribute("data-pkg");
      pkgRow.querySelectorAll("button").forEach(x=>x.classList.remove("ok")); b.classList.add("ok");
      usdDue.value = "$" + (PRICE_USD[selectedPkg] ? PRICE_USD[selectedPkg].toFixed(2) : "0.00");
      refreshAddrRef(); validateLimit();
    }));
  }
  function refreshAddrRef(){
    const asset = assetSel.value;
    addrEl.textContent = CRYPTO_ADDR[asset] || "—";
    const code = "L3Z-"+ up(USER) +"-"+ Math.random().toString(36).slice(2,8).toUpperCase();
    refEl.textContent = code;
  }
  function copy(el){ navigator.clipboard.writeText(el.textContent||"").then(()=>toastMsg("Copied")); }
  document.getElementById("copyAddr").addEventListener("click", ()=>copy(addrEl));
  document.getElementById("copyRef").addEventListener("click", ()=>copy(refEl));
  assetSel.addEventListener("change", ()=>refreshAddrRef());

  function sgetArr(k){ const v=sget(k,[]); return Array.isArray(v)?v:[]; }
  function lbxBoughtLast24h(){
    const orders = sgetArr(ORDERS_KEY).filter(o=> up(o.user)===up(USER) );
    const since = now()-DAY;
    return orders.filter(o=>Number(o.ts)>=since).reduce((a,o)=> a + (+o.amount||0), 0);
  }
  function validateLimit(){
    const used = lbxBoughtLast24h();
    const remain = Math.max(0, 30 - used);
    limitNote.textContent = `You can buy up to ${remain} LBX today.`;
    submitBtn.disabled = !(selectedPkg && remain >= selectedPkg && addrEl.textContent!=="—" && (txidEl.value||"").trim().length>=8);
  }
  txidEl.addEventListener("input", validateLimit);

  async function submitOrder(){
    const asset = assetSel.value;
    const o = {
      id: "ORD-" + Math.random().toString(36).slice(2,10).toUpperCase(),
      user: up(USER),
      amount: selectedPkg,
      usd: PRICE_USD[selectedPkg]||0,
      asset, address: addrEl.textContent, ref: refEl.textContent, txid: (txidEl.value||"").trim(),
      status: "pending", ts: now()
    };
    const all = sgetArr(ORDERS_KEY); all.push(o); localStorage.setItem(ORDERS_KEY, JSON.stringify(all));
    try{ await fetch("/api/lbx/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}); }catch{}
    toastMsg("Submitted for review."); txidEl.value=""; validateLimit();
  }
  submitBtn.addEventListener("click", submitOrder);

  /* -----------------------------
     BOOT
     ----------------------------- */
  welcomeName.textContent = USER;

  // Balance & leaderboard
  loadBalance();
  paintLeaderLocal();

  // Daily + Giveaway
  updateDailyUI();
  loadGiveaway();
  setInterval(loadGiveaway, 4000);

  // Packages UI
  renderPkgs(); refreshAddrRef(); validateLimit();

  // Ledger (local view only)
  paintLedgerLocal();

  // Giveaway button
  enterBtn.addEventListener("click", enterGiveaway);

  // Cross-tab updates
  window.addEventListener('storage', (e)=>{
    if(!e.key) return;
    if(e.key.startsWith("lbx:wallet:") || e.key.startsWith("lbx:ledger:")){ loadBalance(); paintLedgerLocal(); paintLeaderLocal(); }
    if(e.key===ORDERS_KEY){ validateLimit(); }
  });
})();
</script>
</body>
</html>
