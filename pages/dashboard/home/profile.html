<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Profile — L3Z</title>
<style>
  /* … your same styles, unchanged … */
</style>
</head>
<body>
  <!-- … your same HTML markup (overview, ledger, leaderboard, etc.) … -->

<script>
(function(){
  "use strict";
  const $  = (s, r) => (r || document).querySelector(s);
  const $$ = (s, r) => Array.from((r || document).querySelectorAll(s));
  const fmt = (n) => Number(n || 0).toFixed(2);
  const fmtTs = (ts) => {
    try { return new Date(ts).toLocaleString(); } catch { return "—"; }
  };

  const USER = (window.__L3Z__?.USER || "").toUpperCase();
  const balEl   = $("#bal");
  const tableEl = $("#ledger tbody");
  const welcomeName = $("#welcomeName");

  // fetch JSON with cookies
  async function api(path){
    const res = await fetch(path, { credentials:"include", cache:"no-store" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    return res.json();
  }

  // build rows with running balance
  function withRunningBalances(ledger, currentBalance){
    const rows = Array.isArray(ledger) ? [...ledger] : [];
    rows.sort((a,b)=> new Date(b.ts) - new Date(a.ts));
    let running = Number(currentBalance || 0);
    return rows.map(r => {
      const delta = Number(r.delta || 0);
      const row = {
        ts: r.ts,
        reason: String(r.reason || "").toUpperCase(),
        delta,
        balance: running
      };
      running -= delta;
      return row;
    });
  }

  function renderLedger(rows){
    if (!tableEl) return;
    if (!rows.length){
      tableEl.innerHTML = '<tr><td colspan="4" class="muted">No transactions yet.</td></tr>';
      return;
    }
    tableEl.innerHTML = rows.map(r => `
      <tr>
        <td>${fmtTs(r.ts)}</td>
        <td>${r.reason || "—"}</td>
        <td class="${r.delta >= 0 ? 'pos' : 'neg'}">${r.delta >= 0 ? '+' : ''}${fmt(r.delta)}</td>
        <td>${fmt(r.balance)}</td>
      </tr>
    `).join("");
  }

  async function loadWallet(){
    try {
      const j = await api("/api/wallet/me");
      const balance = Number(j?.wallet?.balance || 0);
      const ledger  = Array.isArray(j?.wallet?.ledger) ? j.wallet.ledger : [];

      if (welcomeName) welcomeName.textContent = USER || j.username || "PLAYER";
      if (balEl) balEl.textContent = fmt(balance);

      const rows = withRunningBalances(ledger, balance);
      renderLedger(rows);
    } catch (e) {
      console.error("Wallet load failed", e);
      if (tableEl){
        tableEl.innerHTML = '<tr><td colspan="4" class="muted">Failed to load wallet.</td></tr>';
      }
    }
  }

  // Kick off load on boot
  loadWallet();
  // Optional refresh every 30s
  // setInterval(loadWallet, 30000);
})();
</script>

<!-- viewer glue (unchanged) -->
<script id="viewer-glue">
  /* … your same viewer glue code … */
</script>
</body>
</html>
