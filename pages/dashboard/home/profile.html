<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Profile — L3Z</title>
<style>
  :root{
    --bg:#0b0f10; --ink:#eaf7ff; --muted:#9bc; --panel:#0f1416; --ring:rgba(0,255,255,.22);
    --gold:#ffb42d; --cyan:#00ffff; --ok:#12f3d6; --bad:#ff5a73;
  }
  *,*:before,*:after{box-sizing:border-box}
  html,body{
    margin:0;
    background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;
    color:var(--ink);
    font-family:Segoe UI,system-ui,Arial,sans-serif
  }
  html[data-auth="checking"] body { opacity:0; transition:opacity .12s ease; }

  .topbar{
    position:sticky;top:0;z-index:50;
    display:flex;align-items:center;gap:16px;
    padding:12px;background:rgba(0,0,0,.7);border-bottom:1px solid var(--ring)
  }
  .title{font-weight:900;letter-spacing:.4px;color:var(--gold);text-shadow:0 0 14px rgba(255,180,45,.35)}
  .grow{flex:1}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#0b1f21;color:#cfffff;font-weight:800}

  .wrap{
    max-width:1100px;margin:18px auto;padding:0 12px;
    display:grid;grid-template-columns:2fr 1fr;gap:16px
  }

  .card{
    background:linear-gradient(180deg,#0f1416,#0a1113);
    border:1px solid var(--ring);border-radius:14px;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    padding:16px; overflow:hidden;
  }
  h2{margin:0 0 10px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;min-width:0}
  .big{font-size:28px;font-weight:900;margin:0}
  .stat{display:flex;align-items:center;gap:10px;background:#0a1518;border:1px solid var(--ring);border-radius:12px;padding:10px 12px}
  .stat .val{font-size:22px;font-weight:900}
  .btn{height:42px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:var(--ink);padding:8px 12px;font-weight:800;cursor:pointer}
  .btn.ok{border-color:#0ef;background:linear-gradient(180deg,#0ef,#00dfc6);-webkit-background-clip:text;background-clip:text;color:transparent}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
  th{color:#bfe}
  .right{text-align:right}
  input,select{height:40px;border-radius:10px;border:1px solid var(--ring);background:#0a1719;color:#eaf7ff;padding:8px 12px;outline:none}
  .copy{cursor:pointer;border:1px dashed var(--ring);border-radius:8px;padding:6px 8px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.18s}
  .toast.on{opacity:1;transform:translateY(0)}

  @media (max-width:1100px){ .wrap{padding:0 10px;} }
  @media (max-width:980px){ .wrap{grid-template-columns:1fr} }
</style>

<!-- AUTH GATE (no optional chaining; tolerant if expiresAt is absent) -->
<script>
(function(){
  "use strict";
  var LOGIN="/pages/dashboard/home/login.html";
  var SESSION_KEY="l3z:session", PROFILE_KEY="l3z:user", UNAME_KEY="user:username", LAST_KEY="lash3z_last_user";
  var WALLET = function(u){ return "lbx:wallet:"+(String(u||"").toUpperCase()); };
  var LEDGER = function(u){ return "lbx:ledger:"+(String(u||"").toUpperCase()); };
  var now=function(){ return Date.now(); }; var DAY=86400000; var up=function(s){ return String(s||"").trim().toUpperCase(); };
  function sget(k){ try{var v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch(_){ return null; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  function redirectToLogin(){ var back=encodeURIComponent(location.pathname+location.search+location.hash); location.replace(LOGIN+"?redirect="+back); }

  document.documentElement.setAttribute("data-auth","checking");
  var sess=sget(SESSION_KEY);
  var expOk = sess && (sess.expiresAt==null || Number(sess.expiresAt)>now());
  if(!sess || !sess.user || !expOk){ redirectToLogin(); throw new Error("no session"); }
  var USER=up(sess.user);
  localStorage.setItem(UNAME_KEY,USER); localStorage.setItem(LAST_KEY,USER); sset(PROFILE_KEY,{username:USER});

  function ensureWallet(u){
    var w=sget(WALLET(u));
    if(!w){
      w={balance:50,created:now(),lastDaily:0};
      sset(WALLET(u),w);
      sset(LEDGER(u),[{ts:now(),delta:+50,reason:"WELCOME_BONUS",balance:50}]);
    }
    return w;
  }
  window.__L3Z__ = { USER:USER, WALLET:WALLET, LEDGER:LEDGER, ensureWallet:ensureWallet, now:now, DAY:DAY };
  window.addEventListener("DOMContentLoaded",function(){ document.documentElement.removeAttribute("data-auth"); });
})();
</script>
</head>
<script>
  window.API_BASE = (location.hostname==='127.0.0.1'||location.hostname==='localhost')
    ? 'http://localhost:3000' 
    : ''; // same-origin in production
</script>

<body>
  <div class="topbar">
    <div class="title">My Profile</div>
    <div class="grow"></div>
    <div class="pill">Welcome, <span id="welcomeName">PLAYER</span></div>
  </div>

  <div class="wrap">
    <!-- LEFT: Overview + Daily + Rewards + Ledger -->
    <div class="card">
      <h2>Overview</h2>
      <div class="row" style="margin-bottom:12px">
        <div class="stat"><div>Balance</div><div class="val" id="bal">0.00</div><div class="pill">LBX</div></div>
        <div class="stat"><div>Leaderboard</div><div class="val" id="rank">#—</div><div class="muted" id="rankSub">—</div></div>
      </div>

      <div class="cols">
        <div class="card" style="padding:12px">
          <h2 style="font-size:18px;margin:0 0 8px">Daily Reward</h2>
          <div class="muted" style="margin-bottom:8px">Claim <b>+5 LBX</b> once every 24 hours.</div>
          <div class="row">
            <button class="btn ok" id="claimBtn">Claim +5 LBX</button>
            <span id="claimStatus" class="pill">Ready</span>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <h2 style="font-size:18px;margin:0 0 8px">Unclaimed Rewards</h2>
          <div class="muted" style="margin-bottom:8px">Prizes pushed from Admin.</div>
          <div id="rewardsList" class="row"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Ledger</h2>
        <div class="muted" style="margin-bottom:8px">Your last 50 transactions.</div>
        <table id="ledger">
          <thead><tr><th>When</th><th>Reason</th><th class="right">Δ LBX</th><th class="right">Balance</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: Top 10 + BUY LBX -->
    <div class="card">
      <h2>Top 10 Leaderboard</h2>
      <div class="muted" style="margin-bottom:8px">Local wallets on this device (server leaderboard TBD).</div>
      <table id="lbTable">
        <thead><tr><th>#</th><th>User</th><th class="right">LBX</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="card" style="margin-top:16px">
        <h2>Buy LBX</h2>
        <div class="muted" style="margin-bottom:8px">Max 30 LBX per 24 hours. Pick a package, choose a crypto, send funds, paste TXID, submit.</div>

        <div class="row" id="pkgRow" style="margin-bottom:8px"></div>

        <div class="row" style="margin-bottom:8px">
          <select id="assetSel">
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="USDT">USDT (TRC20)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="LTC">LTC (Litecoin)</option>
          </select>
          <input id="usdDue" type="text" placeholder="USD due" readonly style="width:130px"/>
        </div>

        <div class="muted">Send to this address:</div>
        <div class="row" style="margin:6px 0">
          <div id="addr" class="copy">—</div>
          <button class="btn" id="copyAddr" type="button">Copy</button>
        </div>

        <div class="muted">Reference code (put in TX memo/notes if your wallet supports it):</div>
        <div class="row" style="margin:6px 0">
          <div id="ref" class="copy">—</div>
          <button class="btn" id="copyRef" type="button">Copy</button>
        </div>

        <div class="row" style="margin:6px 0">
          <input id="txid" placeholder="Paste TXID / transaction hash"/>
        </div>

        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted" id="limitNote">You can buy up to 30 LBX today.</div>
          <button class="btn ok" id="submitOrder" type="button" disabled>Submit for Review</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved.</div>

<script>
(function(){
  "use strict";
  var $=function(s){ return document.querySelector(s); };
  var esc=function(s){ s=(s==null?'':String(s)); return s.replace(/[&<>"']/g,function(m){return m==="&"?"&amp;":m==="<"?"&lt;":m===">"?"&gt;":m==='"'?"&quot;":"&#39;";}); };
  var fmt=function(n){ return (+n).toFixed(2); };
  var up=function(s){ return String(s||'').trim().toUpperCase(); };

  var USER = window.__L3Z__.USER, WALLET=window.__L3Z__.WALLET, LEDGER=window.__L3Z__.LEDGER, ensureWallet=window.__L3Z__.ensureWallet, now=window.__L3Z__.now, DAY=window.__L3Z__.DAY;

  var welcomeName=$("#welcomeName"), balEl=$("#bal"), rankEl=$("#rank"), rankSub=$("#rankSub");
  var claimBtn=$("#claimBtn"), claimStatus=$("#claimStatus");
  var ledgerBody=$("#ledger tbody"), lbTableBody=$("#lbTable tbody");
  var rewardsList=$("#rewardsList"), toast=$("#toast");

  // BUY LBX UI
  var pkgRow=$("#pkgRow"), assetSel=$("#assetSel"), usdDue=$("#usdDue");
  var addrEl=$("#addr"), refEl=$("#ref"), txidEl=$("#txid"), submitBtn=$("#submitOrder"), limitNote=$("#limitNote");

  var CRYPTO_ADDR = {
    "BTC":"bc1q0l428lsymjqrksxrnlx4m9jahzjjrnvns5a6ah",
    "ETH":"0xc59Ab6F4f71ba573F7435fA3fb730EdEdAF26884",
    "USDT":"TVfWLpQBG5m5Px7K7so3yqdiAC21o7cEub",
    "SOL":"tS4aS93waE4sPRjVVagkSaZ3wQyhfir3GzL1Lhm2eJ4",
    "LTC":"ltc1qn6klwjdalpfk8g252ypht03tktr4em7x367vm7"
  };

  var PRICE_USD = {5:2.50, 10:5.00, 15:7.00, 20:9.00, 25:10.50, 30:12.00};
  var PKGS=[5,10,15,20,25,30];
  var selectedPkg=0;

  var ORDERS_KEY="lbx:orders";
  function sget(k,def){ try{var v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(_){ return def; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  function toastMsg(t){ toast.textContent=t; toast.classList.add('on'); setTimeout(function(){ toast.classList.remove('on'); },1400); }

  function readWallet(u){ return ensureWallet(u); }
  function writeWallet(u,w){ sset(WALLET(u),w); }
  function readLedger(u){ return sget(LEDGER(u),[]) }
  function pushLedger(u,delta,reason){
    var w = readWallet(u);
    w.balance = +(w.balance||0) + (+delta||0);
    writeWallet(u,w);
    var list = readLedger(u);
    list.push({ ts: now(), delta:+delta, reason:String(reason||'ADJUSTMENT'), balance:w.balance });
    sset(LEDGER(u), list.slice(-200));
    paintWallet(); paintLedger(); paintLeaderboard();
  }

  /* Server sync (no optional chaining) */
  async function syncFromServer(){
    try{
      var r = await fetch("/api/wallet/me?viewer="+encodeURIComponent(USER), { credentials:"include" });
      if(!r.ok) return;
      var j = await r.json();
      var serverBal = (j && j.wallet && typeof j.wallet.balance === "number") ? Number(j.wallet.balance) : NaN;
      if (!isFinite(serverBal)) return;

      var w = readWallet(USER);
      var current = Number(w.balance||0);
      var delta = serverBal - current;

      if (Math.abs(delta) > 1e-9) {
        w.balance = serverBal;
        writeWallet(USER, w);
        var L = readLedger(USER);
        L.push({ ts: now(), delta: +delta, reason: "SERVER_SYNC", balance: serverBal });
        sset(LEDGER(USER), L.slice(-200));
      }
      paintWallet(); paintLedger(); paintLeaderboard();
    } catch(_e) {
      // ignore network issues
    }
  }

  function msToHMS(ms){
    if(ms<=0) return "ready";
    var h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000);
    return h+"h "+m+"m "+s+"s";
  }

  // Daily reward
  function updateDailyUI(){
    var w = readWallet(USER);
    var next = (w.lastDaily||0) + DAY;
    var remain = next - now();
    if(remain <= 0){ claimBtn.disabled=false; claimStatus.textContent="Ready"; }
    else{ claimBtn.disabled=true; claimStatus.textContent="Next in " + msToHMS(remain); }
  }
  claimBtn.addEventListener('click', function(){
    var w = readWallet(USER); var next=(w.lastDaily||0)+DAY;
    if(now() < next){ toastMsg("Too soon — come back later"); return; }
    w.lastDaily = now(); writeWallet(USER,w);
    pushLedger(USER, +5, "DAILY_REWARD"); toastMsg("+5 LBX claimed"); updateDailyUI();
  });
  setInterval(updateDailyUI, 1000);

  // Rewards (local awards scan)
  function listAwards(){
    var out=[];
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i);
      if(!k || k.indexOf("bux:awards:")!==0) continue;
      var arr=sget(k,[]);
      if(Array.isArray(arr)) for(var idx=0; idx<arr.length; idx++){
        var a=arr[idx];
        var uname=up((a && (a.userId||a.name))||'');
        if(uname===USER) out.push({id:k+"::"+idx, key:k, idx:idx, label:(a && a.label)||'Reward', amount:+((a && a.amount)||0)});
      }
    }
    return out;
  }
  function isClaimed(id){ return localStorage.getItem("lbx:award:claimed:"+id)==="1"; }
  function setClaimed(id){ localStorage.setItem("lbx:award:claimed:"+id,"1"); }
  function paintRewards(){
    var items=listAwards();
    if(!items.length){ rewardsList.innerHTML='<span class="muted">No rewards pending.</span>'; return; }
    rewardsList.innerHTML="";
    items.forEach(function(it){
      var wrap=document.createElement('div'); wrap.className="row"; wrap.style.marginBottom="6px";
      var claimed=isClaimed(it.id);
      wrap.innerHTML='<div class="pill">'+esc(it.label)+'</div><div class="pill">'+(claimed?'CLAIMED':('+'+fmt(it.amount)+' LBX'))+'</div><button class="btn" data-claim="'+it.id+'" '+(claimed?'disabled':'')+'>Claim</button>';
      rewardsList.appendChild(wrap);
    });
    rewardsList.querySelectorAll('[data-claim]').forEach(function(btn){
      btn.addEventListener('click',function(){
        var id=btn.getAttribute('data-claim');
        var found=listAwards().filter(function(x){ return x.id===id; })[0];
        if(!found||isClaimed(id)) return;
        pushLedger(USER, +found.amount, "AWARD:"+found.label);
        setClaimed(id); toastMsg('+'+fmt(found.amount)+' LBX added'); paintRewards();
      });
    });
  }

  // Leaderboard (local scan)
  function collectWallets(){
    var res=[];
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i);
      if(k && k.indexOf("lbx:wallet:")===0){
        var u=k.split(":").pop();
        var w=sget(k);
        if(w) res.push({user:u,balance:+(w.balance||0)});
      }
    }
    return res;
  }
  function paintLeaderboard(){
    var all=collectWallets().sort(function(a,b){ return b.balance-a.balance; });
    var meIndex=-1; for(var i=0;i<all.length;i++){ if(all[i].user===up(USER)){ meIndex=i; break; } }
    rankEl.textContent = "#"+(meIndex>=0?meIndex+1:"—");
    rankSub.textContent = all.length?("of "+all.length):"—";
    var top=all.slice(0,10);
    lbTableBody.innerHTML =
      (top.map(function(r,i){ return '<tr><td>'+(i+1)+'</td><td>'+esc(r.user)+' '+(r.user===up(USER)?'<span class="pill">you</span>':'')+'</td><td class="right">'+fmt(r.balance)+'</td></tr>'; }).join(''))
      || '<tr><td colspan="3" class="muted">No data yet.</td></tr>';
  }

  // Ledger + wallet painters
  function paintLedger(){
    var L=(sget(LEDGER(USER),[])).slice(-50).reverse();
    ledgerBody.innerHTML = (L.map(function(row){
      var sign = (row.delta>=0?'+':'');
      return '<tr><td>'+new Date(row.ts).toLocaleString()+'</td><td>'+esc(row.reason||'')+'</td><td class="right '+(row.delta>=0?'':'bad')+'">'+sign+fmt(row.delta||0)+'</td><td class="right">'+fmt(row.balance||0)+'</td></tr>';
    }).join('')) || '<tr><td colspan="4" class="muted">No transactions yet.</td></tr>';
  }
  function paintWallet(){ var w=sget(WALLET(USER)); welcomeName.textContent=USER; balEl.textContent=fmt((w&&w.balance)||0); }

  // Purchase UI
  function renderPkgs(){
    pkgRow.innerHTML = PKGS.map(function(n){ return '<button class="btn" data-pkg="'+n+'">'+n+' LBX</button>'; }).join("");
    pkgRow.querySelectorAll("[data-pkg]").forEach(function(b){
      b.addEventListener("click", function(){
        selectedPkg = +b.getAttribute("data-pkg");
        pkgRow.querySelectorAll("button").forEach(function(x){ x.classList.remove("ok"); }); b.classList.add("ok");
        usdDue.value = "$" + (PRICE_USD[selectedPkg] ? PRICE_USD[selectedPkg].toFixed(2) : "0.00");
        refreshAddrRef();
        validateLimit();
      });
    });
  }
  function refreshAddrRef(){
    var asset = assetSel.value;
    addrEl.textContent = CRYPTO_ADDR[asset] || "—";
    var code = "L3Z-"+ up(USER) +"-"+ Math.random().toString(36).slice(2,8).toUpperCase();
    refEl.textContent = code;
  }

  function copyTextFrom(el){
    var txt = (el && el.textContent) ? el.textContent : "";
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(function(){ toastMsg("Copied"); }, function(){ fallback(); });
      return;
    }
    fallback();
    function fallback(){
      var ta=document.createElement("textarea"); ta.value=txt; ta.style.position="fixed"; ta.style.opacity="0";
      document.body.appendChild(ta); ta.focus(); ta.select();
      try{ document.execCommand("copy"); }catch(_){}
      document.body.removeChild(ta); toastMsg("Copied");
    }
  }
  document.getElementById("copyAddr").addEventListener("click", function(){ copyTextFrom(addrEl); });
  document.getElementById("copyRef").addEventListener("click", function(){ copyTextFrom(refEl); });
  assetSel.addEventListener("change", function(){ refreshAddrRef(); });

  function lbxBoughtLast24h(){
    var orders = (sget(ORDERS_KEY,[])||[]).filter(function(o){ return up(o.user)===up(USER); });
    var since = now()-DAY;
    var sum=0; for(var i=0;i<orders.length;i++){ if(Number(orders[i].ts)>=since) sum += (+orders[i].amount||0); }
    return sum;
  }
  function validateLimit(){
    var used = lbxBoughtLast24h();
    var remain = Math.max(0, 30 - used);
    limitNote.textContent = "You can buy up to "+remain+" LBX today.";
    var txOk = (String(txidEl.value||"").trim().length>=8);
    submitBtn.disabled = !(selectedPkg && remain >= selectedPkg && addrEl.textContent!=="—" && txOk);
  }
  txidEl.addEventListener("input", validateLimit);

  async function submitOrder(){
    var asset = assetSel.value;
    var o = {
      id: "ORD-" + Math.random().toString(36).slice(2,10).toUpperCase(),
      user: up(USER),
      amount: selectedPkg,
      usd: PRICE_USD[selectedPkg]||0,
      asset: asset, address: addrEl.textContent, ref: refEl.textContent, txid: String(txidEl.value||"").trim(),
      status: "pending", ts: now()
    };
    var all = sget(ORDERS_KEY,[]); all.push(o); sset(ORDERS_KEY, all);
    try{
      await fetch("/api/lbx/orders", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(o) });
    }catch(_){ }
    toastMsg("Submitted for review. We'll approve after confirming on-chain.");
    txidEl.value=""; validateLimit();
  }
  submitBtn.addEventListener("click", submitOrder);

  // Boot
  ensureWallet(USER);
  renderPkgs(); refreshAddrRef(); validateLimit();
  paintWallet(); paintLedger(); paintLeaderboard(); paintRewards(); updateDailyUI();

  // Server sync (now & shortly after)
  syncFromServer();
  setTimeout(syncFromServer, 1000);

  // Cross-tab updates
  window.addEventListener('storage', function(e){
    if(!e.key) return;
    if(e.key.indexOf("lbx:wallet:")===0 || e.key.indexOf("lbx:ledger:")===0){ paintWallet(); paintLedger(); paintLeaderboard(); }
    if(e.key===ORDERS_KEY){ validateLimit(); }
    if(e.key.indexOf("bux:awards:")===0 || e.key.indexOf("lbx:award:claimed:")===0){ paintRewards(); }
  });
})();
</script>

<!-- viewer glue v2 (unchanged logic; no optional chaining) -->
<script id="viewer-glue">
(function(){
  var S = function(sel){ return document.querySelector(sel); };
  var SS = function(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); };
  var set = function(sel, val){ var n=S(sel); if(n){ n.textContent = val; n.title = val; } };

  function readCookie(name){
    var m = document.cookie.match(new RegExp('(?:^|; )'+name+'=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }

  async function loadMe(){
    var viewerCookie = readCookie('viewer');
    var me = { username: String(viewerCookie||'').toUpperCase(), wallet:{balance:0}, anon: !viewerCookie };
    try{
      var r = await fetch('/api/viewer/me', { credentials: 'include' });
      if(r.ok){ me = await r.json(); if(!me || typeof me !== 'object') throw 0; }
    }catch(_){}

    var user = String(me.username||'').toUpperCase();
    set('#helloName', user);
    set('#welcomeName', user);
    set('#usernameDisplay', user);
    set('#ubName', user);
    set('#playerName', user);
    set('#who', user);
    var g=S('#guestChipLabel'); if(g) g.textContent=user;

    var bal = (me.wallet && typeof me.wallet.balance==='number') ? me.wallet.balance : 0;
    if ((!bal || isNaN(bal)) && user){
      try{
        var wr = await fetch('/api/wallet/me?viewer='+encodeURIComponent(user), { credentials:'include' });
        if (wr.ok){ var wj = await wr.json(); bal = Number((wj.wallet&&wj.wallet.balance)||0) || 0; }
      }catch(_){}
    }
    var pretty = (Number(bal)||0).toFixed(0);
    set('#headerLbx', pretty+' LBX');
    set('#navLbx',    pretty);
    set('#ubBal',     pretty);
    set('#playerBalance', pretty);
    set('#walletBalance', pretty);
    set('#walletBalanceTop', pretty);

    var kill = ['#btnSwitch','.btnSwitchName','#switchName','.switch-name','.switchName']
      .map(S).filter(Boolean);
    kill.forEach(function(n){ n.style.display='none'; });
    SS('button').forEach(function(b){
      var t = (b.textContent||'').toLowerCase();
      if (t.indexOf('switch name')>=0) b.style.display='none';
    });

    SS('.lbx-pill,.lbx,.pill-lbx').forEach(function(n){
      var m = String(n.textContent||'').match(/\b(\d+)\b/);
      if (m) n.textContent = String(n.textContent||'').replace(m[1], pretty);
    });
  }
  loadMe();
  window.addEventListener('focus', loadMe);
  document.addEventListener('visibilitychange', function(){ if(!document.hidden) loadMe(); });
})();
</script>
</body>
</html>
