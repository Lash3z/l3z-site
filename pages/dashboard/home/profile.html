<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Profile — L3Z</title>
<link rel="icon" type="image/png" href="/assets/L3Z_logoMain.png">
<style>
  :root{--bg:#0b0e13;--panel:#0f141b;--ink:#e8ecf3;--muted:#94a3b8;--line:rgba(0,255,255,.18);--ok:#12d48a;--err:#ff7a8a;--chip:#0c141a}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  a{color:#9bd3ff;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0a1016;color:#cfe;font-weight:800}
  .card{background:linear-gradient(180deg,#0f131a,#0a0f15);border:1px solid var(--line);border-radius:14px;overflow:hidden;margin-bottom:14px}
  .head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .head h2{margin:0;font-size:14px;letter-spacing:.3px;color:#ffd78a}
  .body{padding:12px;display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  input,button{background:#0f141b;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px 12px;font-size:14px}
  input{min-width:180px} button{cursor:pointer;font-weight:800}
  .primary{background:linear-gradient(180deg,#f5c462,#d49a2e);color:#1a1204;border:none}
  .ghost{background:#111a22}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px}
</style>
</head>
<body data-login-url="/login.html">
<div class="wrap">
  <div class="top">
    <div class="row">
      <img src="/assets/l3z_logo.png" alt="" style="width:36px;height:36px;border-radius:10px;border:1px solid var(--line)">
      <div class="pill" id="titlePill">Profile</div>
    </div>
    <div class="row">
      <div class="pill">user: <b id="whoami">—</b></div>
      <div class="pill">balance: <b id="walletBalance">0 LBX</b></div>
      <button id="logout" class="ghost">Logout</button>
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <div class="head"><h2>Wallet</h2><div class="badge" id="viewBadge">LBX</div></div>
      <div class="body">
        <div class="row">
          <button id="refreshBal" class="ghost">Refresh Balance</button>
          <span id="balStatus" class="muted"></span>
        </div>
        <div class="row muted">Auto-updates on admin actions. Also refreshes every 10s.</div>
      </div>
    </section>

    <section class="card">
      <div class="head"><h2>Redeem Promo Code</h2><div class="badge">per-user</div></div>
      <div class="body">
        <div class="row">
          <input id="promoCode" placeholder="ENTER CODE"/>
          <button id="redeem" class="primary">Redeem</button>
          <span id="promoStatus" class="muted"></span>
        </div>
        <div class="row muted">Uses <code>/api/code/redeem</code>. Balance will update on success.</div>
      </div>
    </section>
  </div>

  <section class="card">
    <div class="head"><h2>Kick Account</h2><div class="badge" id="kickStatus">checking…</div></div>
    <div class="body"><div class="row"><button id="kickLink" class="primary">Link Kick</button><button id="kickUnlink" class="ghost">Unlink</button><span class="muted">Link your Kick account for drops, badges, and verified entries.</span></div></div>
  </section>

  <section class="card">
    <div class="head"><h2>Account</h2><div class="badge">basic</div></div>
    <div class="body">
      <div class="row">Username: <b data-bind="username"></b></div>
      <div class="row">Role: <b data-bind="role"></b></div>
      <div class="row">LBX: <b data-bind="lbx"></b></div>
      <div class="row muted" id="createdAtRow" style="display:none">Joined: <span id="createdAt"></span></div>
    </div>
  </section>
</div>

<script src="/assets/api-base.js?v=5"></script>
<script>
(() => {
  const $  = (s,r=document)=>r.querySelector(s);
  const say= (el,msg,ok)=>{ if(!el) return; el.textContent=msg||""; el.className=(ok===undefined)?"muted":(ok?"ok":"err"); };
  const qs = new URLSearchParams(location.search);
  const viewUser = (qs.get("user")||"").trim().toLowerCase(); // admin view-as

  const who = $("#whoami"), titlePill=$("#titlePill"), viewBadge=$("#viewBadge");
  const balEl = $("#walletBalance"), balStatus=$("#balStatus"), promoStatus=$("#promoStatus");
  const promoCode=$("#promoCode");
  let me = null;

  function setBalance(v){
    const n = Number(v||0);
    balEl.textContent = `${n.toLocaleString()} LBX`;
    const bind = document.querySelector('[data-bind="lbx"]'); if (bind) bind.textContent = n.toLocaleString();
  }

  async function fetchMyWallet(){
    const j = await api.get("/api/wallet");
    return Number(j?.lbx||0);
  }
  async function fetchUserWallet(u){
    const j = await api.get(`/api/admin/wallet/balance?user=${encodeURIComponent(u)}`);
    return Number(j?.balance||0);
  }

  async function loadMe(){
    const j = await api.get("/api/me");
    if (!j?.ok) throw new Error("not_logged_in");
    me = j.user;
    who.textContent = me.username;
    document.querySelector('[data-bind="username"]').textContent = me.username;
    document.querySelector('[data-bind="role"]').textContent = me.role||"user";
    if (me.createdAt){ $("#createdAt").textContent = new Date(me.createdAt).toLocaleString(); $("#createdAtRow").style.display=""; }
  }

  async function refreshWallet(){
    try{
      say(balStatus,"Refreshing…");
      let lbx;
      if (viewUser && me?.role === "admin"){
        lbx = await fetchUserWallet(viewUser);
        titlePill.textContent = `Profile — viewing ${viewUser}`;
        viewBadge.textContent = "ADMIN VIEW";
      } else {
        lbx = await fetchMyWallet();
        titlePill.textContent = "Profile";
        viewBadge.textContent = "LBX";
      }
      setBalance(lbx);
      say(balStatus,"Up to date.",true);
    }catch(e){
      say(balStatus,(e.message||"failed").replace(/_/g," "),false);
    }
  }

  // promo redeem
  $("#redeem")?.addEventListener("click", async ()=>{
    const code = (promoCode.value||"").trim().toUpperCase();
    if(!code) return say(promoStatus,"Enter a code.",false);
    $("#redeem").disabled=true; say(promoStatus,"Submitting…");
    try{
      const j = await api.post("/api/code/redeem",{ code });
      setBalance(j?.lbx || 0);
      say(promoStatus,`Success! New balance: ${Number(j?.lbx||0).toLocaleString()} LBX`,true);
      promoCode.value="";
    }catch(e){
      say(promoStatus,(e.message||"failed").replace(/_/g," "),false);
    }finally{ $("#redeem").disabled=false; }
  });

  // storage “poke” from Admin Hub (same origin)
  window.addEventListener("storage",(ev)=>{
    if (ev.key!=="l3z:wallet-poke") return;
    try{
      const data = JSON.parse(ev.newValue||"{}");
      if (!data?.u) return;
      const target = String(data.u).toLowerCase();
      if ((viewUser && target===viewUser) || (!viewUser && me && target===String(me.username).toLowerCase())){
        refreshWallet();
      }
    }catch{}
  });

  // manual refresh + poller
  $("#refreshBal")?.addEventListener("click", refreshWallet);
  setInterval(()=>{ if(!document.hidden) refreshWallet(); }, 10000);

  // logout
  $("#logout")?.addEventListener("click", async ()=>{ try{ await api.post("/api/auth/logout",{});}catch{} location.href="/login.html"; });

  (async function boot(){
    await loadMe();    // identify me + role
    await refreshWallet(); // initial balance for self OR viewed user
  })();
})();
</script>
</body>
</html>
