<!DOCTYPE html>
<html lang="en" data-admin="checking">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bets Admin — Unified (Simple: BG / Bonus / PVP)</title>
<style>
:root{--bg:#060b0d;--panel:#0b1417;--ink:#eaf7ff;--muted:#9fd0d6;--line:rgba(0,255,255,.18);--teal:#00ffff;--gold:#ffb42d;--bad:#e25a6f;--ok:#12d48a}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
html[data-admin="checking"] body{opacity:0;transition:opacity .12s ease}
.wrap{max-width:1400px;margin:0 auto;padding:16px 16px 64px}
h1{margin:0 0 12px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
.card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.btn{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#0f1720;color:#eaf7ff;font-weight:800;cursor:pointer}
.btn.ok{background:#103d30;border-color:#1fa37b}
.btn.danger{background:#2b1116;border-color:#7e2a3c}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
input,select{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:#eaf7ff;padding:10px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
.h2hList{display:flex;flex-direction:column;gap:12px}
.h2h{border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
.side{border:1px solid var(--line);border-radius:12px;background:#0c1519;padding:10px;display:grid;grid-template-columns:80px 1fr;gap:10px;align-items:center}
.thumb{width:80px;height:108px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#000}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.title{font-weight:900}
.prov{font-size:12px;color:#9fd0d6}
.oddBox{margin-top:8px}
.small{font-size:12px;color:#9fd0d6}
.head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#081318;color:#bfe}
.sectionTitle{font-weight:900;margin-bottom:8px}
.mkts{display:flex;flex-direction:column;gap:12px}
.mkt{border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:12px}
.mTop{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.selRow{display:grid;grid-template-columns:1fr 110px auto;gap:8px;margin:6px 0}
.lineRow{display:flex;align-items:center;gap:8px;margin:4px 0}
.del{border:1px solid var(--line);border-radius:10px;background:#2b1116;color:#ffd0d6;padding:8px 10px;cursor:pointer}
.kv{display:flex;gap:8px;align-items:center}
.kv b{color:var(--muted)}
.hr{height:1px;background:var(--line);margin:10px 0}
.toggleRow{display:flex;gap:12px;align-items:center}
.toggleRow label{display:flex;gap:6px;align-items:center}
.subtle{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<!-- AdminGate (server cookie) -->
<script>
(function(){
  "use strict";
  const ADMIN_CHECK="/api/admin/gate/check", ADMIN_LOGIN="/pages/dashboard/admin/admin_login.html", DASH="/index.html";
  const H=document.documentElement; H.setAttribute("data-admin","checking");
  function lock(){
    H.removeAttribute("data-admin");
    const s=document.createElement("style");
    s.textContent=".lockwrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f12;color:#eaf7ff;font-family:Segoe UI,system-ui,Arial,sans-serif}.lockcard{max-width:640px;margin:24px;padding:24px;border:1px solid rgba(0,255,255,.2);border-radius:14px;background:rgba(0,0,0,.75)}.lockcard h1{margin:0 0 10px;color:#cfe}.lockcard a{color:#7ad7ff;text-decoration:underline}";
    document.head.appendChild(s);
    document.body.innerHTML='<div class="lockwrap"><div class="lockcard"><h1>Administration Locked</h1><div>You must unlock admin on the <a href="'+ADMIN_LOGIN+'">Admin Login</a> first.</div><div style="margin-top:8px;opacity:.8">If you already logged in, your session may have expired.</div><div style="margin-top:14px"><a href="'+DASH+'">Back to Dashboard</a></div></div></div>';
  }
  fetch(ADMIN_CHECK,{credentials:"include",cache:"no-store"}).then(r=>r.ok?r.json():null).then(j=>{ if(j&&j.admin){ H.removeAttribute("data-admin"); }else{ lock(); } }).catch(lock);
})();
</script>

<div class="wrap">
  <h1>Bets Admin — Unified (Simple)</h1>

  <div class="card row" style="justify-content:space-between">
    <div class="row">
      <button id="btnSave" class="btn">Save</button>
      <button id="btnPublish" class="btn ok">Publish to Players</button>
      <button id="btnOpenAll" class="btn">Open All</button>
      <button id="btnLockAll" class="btn">Lock All</button>
      <button id="btnDelete" class="btn danger">Delete All</button>
    </div>
    <div class="row">
      <span id="stamp" class="pill">Not published</span>
      <span id="msg" class="pill">Ready</span>
    </div>
  </div>

  <div class="card toggleRow">
    <label><input id="enBG" type="checkbox"> <b>Battleground</b></label>
    <label><input id="enBONUS" type="checkbox"> <b>Bonus Hunt</b></label>
    <label><input id="enPVP" type="checkbox"> <b>PVP Predictions</b></label>
    <span class="subtle">Toggle sections on/off. Each section lets you add markets and lines.</span>
  </div>

  <div class="grid">
    <div id="secBG" class="card" style="display:none">
      <div class="head">
        <div class="sectionTitle">Battleground</div>
        <div class="badge" id="statusBG">OPEN</div>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <button class="btn" id="bgAddOU">+ Over/Under</button>
          <button class="btn" id="bgAddMR">+ Multi-Range</button>
          <button class="btn" id="bgAddYN">+ Yes/No</button>
          <button class="btn" id="bgAddCU">+ Custom</button>
          <button class="btn" id="bgAddCS">+ Which Matchup Clean Sweep?</button>
        </div>
        <div class="row">
          <button class="btn" id="bgImport">Import Matchups</button>
          <button class="btn" id="bgBuild">Build/Refresh H2H</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="sectionTitle">Head-to-Head</div>
      <div id="bgH2H" class="h2hList"></div>
      <div class="kv"><b>Debug:</b> Last Import → <span id="dbgImport">none</span></div>
      <div class="hr"></div>
      <div class="sectionTitle">Overall Markets</div>
      <div id="bgMkts" class="mkts"></div>
    </div>

    <div id="secBONUS" class="card" style="display:none">
      <div class="head">
        <div class="sectionTitle">Bonus Hunt</div>
        <div class="badge" id="statusBONUS">OPEN</div>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <button class="btn" id="boAddOU">+ Over/Under</button>
          <button class="btn" id="boAddMR">+ Multi-Range</button>
          <button class="btn" id="boAddYN">+ Yes/No</button>
          <button class="btn" id="boAddCU">+ Custom</button>
          <button class="btn" id="boAddGB">+ Guess the Balance</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="boMkts" class="mkts"></div>
    </div>

    <div id="secPVP" class="card" style="display:none">
      <div class="head">
        <div class="sectionTitle">PVP Predictions</div>
        <div class="badge" id="statusPVP">OPEN</div>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <button class="btn" id="pvAddOU">+ Over/Under</button>
          <button class="btn" id="pvAddMR">+ Multi-Range</button>
          <button class="btn" id="pvAddYN">+ Yes/No</button>
          <button class="btn" id="pvAddCU">+ Custom</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="pvMkts" class="mkts"></div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  // helpers
  const els=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const el=(s,r=document)=>r.querySelector(s);
  function sget(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null;}catch{ return null; } }
  function sset(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
  function esc(s){ s=String(s??''); return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function kid(p){ return (p||'ID')+Math.random().toString(36).slice(2,10).toUpperCase(); }
  function toast(t,ok){ el('#msg').textContent=t; el('#msg').style.color = ok===false ? '#ff9aa7' : '#baffea'; setTimeout(()=>{ el('#msg').textContent='Ready'; el('#msg').style.color=''; }, 1800); }

  // keys
  const K_UNIFIED='sb:markets:unified';           // this admin's save
  const K_BG_BUILDER='bg:builder:battleground';   // canonical source of games/matches

  // title normalizer + resolvers
  const normTitle=s=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
  function mapById(games){ const m=new Map(); (games||[]).forEach(g=>m.set(g.id,g)); return m; }
  function mapByTitle(games){ const m=new Map(); (games||[]).forEach(g=>m.set(normTitle(g.title),g)); return m; }
  function resolveSide(mxSideTitle, mxSideImg, mxSideId, byId, byTitle){
    const fromId = mxSideId && byId.get(mxSideId);
    const fromTitle = byTitle.get(normTitle(mxSideTitle||'')) || null;
    const img = mxSideImg || (fromId&& (fromId.imageUrl||fromId.image)) || (fromTitle && (fromTitle.imageUrl||fromTitle.image)) || '';
    const prov = (fromId&&fromId.provider) || (fromTitle&&fromTitle.provider) || '';
    return {img,prov};
  }

  // state
  let state = sget(K_UNIFIED) || {
    status:'open', lastUpdated:0,
    sections:{
      battleground:{enabled:false,h2h:[],overall:[]},
      bonus:{enabled:false,overall:[]},
      pvp:{enabled:false,overall:[]}
    }
  };

  // toggles
  function syncToggles(){
    el('#enBG').checked=!!state.sections.battleground.enabled;
    el('#enBONUS').checked=!!state.sections.bonus.enabled;
    el('#enPVP').checked=!!state.sections.pvp.enabled;
    el('#secBG').style.display=state.sections.battleground.enabled?'':'none';
    el('#secBONUS').style.display=state.sections.bonus.enabled?'':'none';
    el('#secPVP').style.display=state.sections.pvp.enabled?'':'none';
    const s=(state.status||'open').toUpperCase();
    el('#statusBG').textContent=s; el('#statusBONUS').textContent=s; el('#statusPVP').textContent=s;
  }
  el('#enBG').addEventListener('change',()=>{ state.sections.battleground.enabled=el('#enBG').checked; save(); syncToggles(); paintAll(); });
  el('#enBONUS').addEventListener('change',()=>{ state.sections.bonus.enabled=el('#enBONUS').checked; save(); syncToggles(); paintAll(); });
  el('#enPVP').addEventListener('change',()=>{ state.sections.pvp.enabled=el('#enPVP').checked; save(); syncToggles(); paintAll(); });

  // paint
  function paintAll(){ paintH2H(); paintMkts('battleground','#bgMkts'); paintMkts('bonus','#boMkts'); paintMkts('pvp','#pvMkts'); }
  function paintH2H(){
    const sec=state.sections.battleground, box=el('#bgH2H'); box.innerHTML='';
    if(!sec.h2h.length){ box.innerHTML='<div class="pill">No H2H yet. Import → Build/Refresh.</div>'; return; }
    sec.h2h.forEach((h,idx)=>{
      const L='<div class="side"><div class="thumb">'+(h.leftImg?('<img src="'+esc(h.leftImg)+'" alt="">'):'')+'</div><div><div class="title">'+esc(h.leftTitle||'LEFT')+'</div><div class="prov">'+esc(h.leftProv||'')+'</div><div class="oddBox"><span class="small">Odds</span> <input data-k="l'+idx+'" type="number" step="0.01" value="'+esc(h.leftOdds||1.84)+'" style="width:110px"></div></div></div>';
      const R='<div class="side"><div class="thumb">'+(h.rightImg?('<img src="'+esc(h.rightImg)+'" alt="">'):'')+'</div><div><div class="title">'+esc(h.rightTitle||'RIGHT')+'</div><div class="prov">'+esc(h.rightProv||'')+'</div><div class="oddBox"><span class="small">Odds</span> <input data-k="r'+idx+'" type="number" step="0.01" value="'+esc(h.rightOdds||1.84)+'" style="width:110px"></div></div></div>';
      const row=document.createElement('div'); row.className='h2h'; row.innerHTML=L+R;
      row.querySelector('[data-k="l'+idx+'"]').addEventListener('change',e=>{ sec.h2h[idx].leftOdds=+e.target.value||1; save(); });
      row.querySelector('[data-k="r'+idx+'"]').addEventListener('change',e=>{ sec.h2h[idx].rightOdds=+e.target.value||1; save(); });
      box.appendChild(row);
    });
  }
  function paintMkts(section, mount){
    const sec=state.sections[section]; const host=el(mount); host.innerHTML='';
    if(!sec.overall.length){ host.innerHTML='<div class="pill">No markets yet. Use the buttons above.</div>'; return; }
    sec.overall.forEach((m,mi)=>{
      const box=document.createElement('div'); box.className='mkt';
      const top='<div class="mTop">'+
        '<select data-x="type"><option '+(m.type==='OVER_UNDER'?'selected':'')+'>OVER_UNDER</option><option '+(m.type==='MULTI_RANGE'?'selected':'')+'>MULTI_RANGE</option><option '+(m.type==='YES_NO'?'selected':'')+'>YES_NO</option><option '+(m.type==='CUSTOM'?'selected':'')+'>CUSTOM</option><option '+(m.type==='NUMERIC_GUESS'?'selected':'')+'>NUMERIC_GUESS</option></select>'+
        '<input data-x="label" placeholder="Market label" value="'+esc(m.label||'')+'" style="min-width:260px">'+
        '<select data-x="status"><option '+(m.status!=='locked'?'selected':'')+'>OPEN</option><option '+(m.status==='locked'?'selected':'')+'>LOCKED</option></select>'+
        '<button class="del" data-act="del">Delete</button></div>';
      const extraOU=(m.type==='OVER_UNDER')?('<div class="lineRow"><span class="pill">LINE</span> <input data-x="line" type="number" step="0.01" value="'+(m.line!=null?m.line:'')+'" style="width:140px"></div>'):'';      
      const extraNG=(m.type==='NUMERIC_GUESS')?(
        '<div class="lineRow">'+
        '<span class="pill">Start</span><input data-x="start" type="number" step="0.01" value="'+(m.start??'')+'" style="width:120px">'+
        '<span class="pill">Min</span><input data-x="min" type="number" step="0.01" value="'+(m.min??'')+'" style="width:110px">'+
        '<span class="pill">Max</span><input data-x="max" type="number" step="0.01" value="'+(m.max??'')+'" style="width:110px">'+
        '<span class="pill">Step</span><input data-x="step" type="number" step="0.01" value="'+(m.step??1)+'" style="width:90px">'+
        '<span class="pill">Unit</span><input data-x="unit" placeholder="$" value="'+(m.unit||'$')+'" style="width:70px">'+
        '<span class="pill">Prize</span><input data-x="prize" type="number" step="1" value="'+(m.prize||0)+'" style="width:90px"></div>'+
        '<div class="lineRow"><span class="pill">Final</span><input data-x="final" type="number" step="0.01" value="'+(m.final??'')+'" style="width:120px">'+
        '<button class="btn" data-act="settleNG">Auto-Settle</button><button class="btn" data-act="award">Award BUX</button>'+
        '<span class="small">Entries: <b data-x="entries">0</b> &nbsp; Winners: <b>'+(m.winners?m.winners.length:0)+'</b></span></div>'
      ):'';      
      const sels=(m.selections||[]).map((s,si)=>'<div class="selRow"><input data-sel="'+si+'" data-x="slabel" placeholder="Selection" value="'+esc(s.label||'')+'"><input data-sel="'+si+'" data-x="sodds" type="number" step="0.01" value="'+esc(s.odds||1.84)+'"><button class="del" data-act="sdel" data-sel="'+si+'">×</button></div>').join('');
      const addBtn=(m.type==='NUMERIC_GUESS')?'':'<div><button class="btn" data-act="addSel">+ Add Line</button></div>';
      box.innerHTML=top+extraOU+extraNG+sels+addBtn;

      box.querySelector('[data-x="type"]').addEventListener('change',e=>{ sec.overall[mi].type=e.target.value; save(); paintMkts(section,mount); });
      box.querySelector('[data-x="label"]').addEventListener('change',e=>{ sec.overall[mi].label=e.target.value; save(); });
      box.querySelector('[data-x="status"]').addEventListener('change',e=>{ sec.overall[mi].status=(e.target.value||'OPEN').toLowerCase()==='locked'?'locked':'open'; save(); });
      const lineEl=box.querySelector('[data-x="line"]'); if(lineEl){ lineEl.addEventListener('change',e=>{ const v=+e.target.value; sec.overall[mi].line=v; if(sec.overall[mi].selections?.length>=2){ sec.overall[mi].selections[0].label='Over '+v; sec.overall[mi].selections[1].label='Under '+v; } save(); paintMkts(section,mount); }); }
      const W=['start','min','max','step','unit','prize','final']; W.forEach(w=>{ const n=box.querySelector('[data-x="'+w+'"]'); if(n) n.addEventListener('change',e=>{ sec.overall[mi][w]= (w==='unit')? e.target.value : +e.target.value; save(); }); });
      const ent=box.querySelector('[data-x="entries"]'); if(ent){ ent.textContent=getEntries(section,sec.overall[mi].id).length; }
      box.querySelectorAll('[data-x="slabel"]').forEach(n=> n.addEventListener('change',function(){ sec.overall[mi].selections[+this.dataset.sel].label=this.value; save(); }));
      box.querySelectorAll('[data-x="sodds"]').forEach(n=> n.addEventListener('change',function(){ sec.overall[mi].selections[+this.dataset.sel].odds=+this.value||1; save(); }));
      box.querySelectorAll('[data-act="sdel"]').forEach(b=> b.addEventListener('click',function(){ sec.overall[mi].selections.splice(+this.dataset.sel,1); save(); paintMkts(section,mount); }));
      const addSelBtn=box.querySelector('[data-act="addSel"]'); if(addSelBtn){ addSelBtn.addEventListener('click',()=>{ sec.overall[mi].selections.push({id:kid('SEL'),label:'',odds:1.84}); save(); paintMkts(section,mount); }); }
      const settleBtn=box.querySelector('[data-act="settleNG"]'); if(settleBtn){ settleBtn.addEventListener('click',()=>{ settleNumericGuess(section, mi); }); }
      const awardBtn=box.querySelector('[data-act="award"]'); if(awardBtn){ awardBtn.addEventListener('click',()=>{ awardBux(section, mi); }); }

      host.appendChild(box);
    });
  }

  // creators
  function addOU(sec){ sec.overall.push({id:kid('OU'),type:'OVER_UNDER',label:'Over / Under',status:'open',line:65.5,selections:[{id:kid('SEL'),label:'Over 65.5',odds:1.84},{id:kid('SEL'),label:'Under 65.5',odds:1.84}]}); save(); paintAll(); }
  function addMR(sec){ sec.overall.push({id:kid('MR'),type:'MULTI_RANGE',label:'Total Games Played',status:'open',selections:[{id:kid('SEL'),label:'48–55.5',odds:17},{id:kid('SEL'),label:'56–63.5',odds:3.4},{id:kid('SEL'),label:'64–71.5',odds:1.7},{id:kid('SEL'),label:'72–80',odds:4.25}]}); save(); paintAll(); }
  function addYN(sec){ sec.overall.push({id:kid('YN'),type:'YES_NO',label:'Yes / No',status:'open',selections:[{id:kid('SEL'),label:'Yes',odds:1.84},{id:kid('SEL'),label:'No',odds:1.84}]}); save(); paintAll(); }
  function addCU(sec){ sec.overall.push({id:kid('CU'),type:'CUSTOM',label:'Custom Market',status:'open',selections:[]}); save(); paintAll(); }
  function addCS(sec){
    if(!state.sections.battleground.h2h.length){ toast('Build H2H first',false); return; }
    const m={id:kid('CS'),type:'CUSTOM',label:'Which matchup clean sweep?',status:'open',selections:[]};
    state.sections.battleground.h2h.forEach(h=>{ m.selections.push({id:kid('SEL'),label:h.leftTitle+' 3–0',odds:3.0}); m.selections.push({id:kid('SEL'),label:h.rightTitle+' 3–0',odds:3.0}); });
    sec.overall.push(m); save(); paintAll();
  }
  function addGB(sec){ sec.overall.push({id:kid('GB'),type:'NUMERIC_GUESS',label:'Guess the Final Balance',status:'open',start:0,min:0,max:1000,step:1,unit:'$',prize:0,final:null,winners:[]}); save(); paintAll(); }

  // entries / settling
  function entriesKey(section, marketId){ return 'sb:entries:'+section+':'+marketId; }
  function getEntries(section, marketId){ return sget(entriesKey(section, marketId)) || []; }
  function settleNumericGuess(section, mi){
    const sec=state.sections[section]; const m=sec.overall[mi];
    const entries=getEntries(section, m.id);
    if(!entries.length){ toast('No entries to settle', false); return; }
    if(m.final==null || isNaN(m.final)){ toast('Enter final balance first', false); return; }
    let best=Infinity, winners=[];
    entries.forEach(e=>{ const d=Math.abs((+e.guess)-(+m.final)); if(d<best){best=d; winners=[e];} else if(d===best){ winners.push(e); } });
    m.winners = winners.map(w=>({userId:w.userId||w.name||'anon', name:w.name||('User'+(w.userId||'')), guess:+w.guess, diff:Math.abs((+w.guess)-(+m.final))}));
    save(); paintAll(); toast('Settled: '+m.winners.length+' winner'+(m.winners.length!==1?'s':''));    
  }
  function awardBux(section, mi){
    const sec=state.sections[section], m=sec.overall[mi];
    if(!m.winners || !m.winners.length){ toast('Settle first', false); return; }
    const awards=m.winners.map(w=>({userId:w.userId, name:w.name, amount:m.prize||0, marketId:m.id, label:m.label}));
    sset('bux:awards:'+section+':'+m.id, awards);
    toast('Awards prepared ('+awards.length+')');
  }

  // import from BG Admin — keeps games and resolves images by id/title when needed
  async function importBG(){
    let used=''; const builder=sget(K_BG_BUILDER);
    if(builder && Array.isArray(builder.matches) && builder.matches.length){
      used='local:'+K_BG_BUILDER;
      return acceptMatches(builder.matches, builder.games||[], used, true);
    }
    // legacy mirrors if present
    const games=sget('bg:games')||[];
    const matches=sget('bg:matches')||[];
    if(matches.length){ used='local:bg:games/bg:matches'; return acceptMatches(matches,games,used,true); }
    el('#dbgImport').textContent='none'; toast('No matchups found (Builder/local empty)',false);
  }

  function acceptMatches(arr, games, used, alreadyNorm){
    // persist games alongside matches so Build step can resolve
    const b = sget(K_BG_BUILDER)||{games:[],matches:[]};
    b.games = Array.isArray(games) ? games : (b.games||[]);
    b.matches = (alreadyNorm ? arr : arr.map((mx,i)=>({
      id: mx.id||mx.matchId||('M'+i),
      leftId: mx.leftId||mx.AId||mx.aId||mx.left?.id||null,
      rightId: mx.rightId||mx.BId||mx.bId||mx.right?.id||null,
      leftTitle: mx.leftTitle||mx.aName||mx.A||mx.left?.title||'LEFT',
      rightTitle: mx.rightTitle||mx.bName||mx.B||mx.right?.title||'RIGHT',
      leftImg: mx.leftImg||mx.aImage||mx.imgA||mx.imageA||mx.left?.img||'',
      rightImg: mx.rightImg||mx.bImage||mx.imgB||mx.imageB||mx.right?.img||''
    })));
    sset(K_BG_BUILDER, b);
    el('#dbgImport').textContent = used+' ('+b.matches.length+')';
    toast('Imported '+b.matches.length+' matchups',true);
  }

  function buildH2H(){
    const builder=sget(K_BG_BUILDER);
    if(!builder || !Array.isArray(builder.matches) || !builder.matches.length){ toast('No matches to build',false); return; }

    const byId=mapById(builder.games||[]);
    const byTitle=mapByTitle(builder.games||[]);

    const prev={}; (state.sections.battleground.h2h||[]).forEach(o=>prev[o.matchId]=o);

    state.sections.battleground.h2h = builder.matches.map(mx=>{
      const leftTitle = mx.leftTitle || (byId.get(mx.leftId)?.title) || 'LEFT';
      const rightTitle = mx.rightTitle || (byId.get(mx.rightId)?.title) || 'RIGHT';

      const L=resolveSide(leftTitle, mx.leftImg, mx.leftId, byId, byTitle);
      const R=resolveSide(rightTitle, mx.rightImg, mx.rightId, byId, byTitle);

      return {
        matchId: mx.id,
        leftId: mx.leftId||null, rightId: mx.rightId||null,
        leftTitle, rightTitle,
        leftImg: L.img, rightImg: R.img,
        leftProv: L.prov||'', rightProv: R.prov||'',
        leftOdds: (prev[mx.id]?.leftOdds)||1.84, rightOdds:(prev[mx.id]?.rightOdds)||1.84
      };
    });
    save(); paintH2H(); toast('H2H built (images resolved)');
  }

  // save/publish
  function save(){ sset(K_UNIFIED,state); }
  function publish(){ state.lastUpdated=Date.now(); save(); el('#stamp').textContent='Last publish @ '+new Date(state.lastUpdated).toLocaleTimeString(); toast('Published to players'); }

  // wire
  el('#btnSave').addEventListener('click',()=>{ save(); toast('Saved'); });
  el('#btnPublish').addEventListener('click',publish);
  el('#btnOpenAll').addEventListener('click',()=>{ state.status='open'; save(); syncToggles(); });
  el('#btnLockAll').addEventListener('click',()=>{ state.status='locked'; save(); syncToggles(); });
  el('#btnDelete').addEventListener('click',()=>{ if(confirm('Delete ALL markets?')){ state={status:'open',lastUpdated:0,sections:{battleground:{enabled:false,h2h:[],overall:[]},bonus:{enabled:false,overall:[]},pvp:{enabled:false,overall:[]}}}; save(); syncToggles(); paintAll(); } });

  el('#bgAddOU').addEventListener('click',()=>addOU(state.sections.battleground));
  el('#bgAddMR').addEventListener('click',()=>addMR(state.sections.battleground));
  el('#bgAddYN').addEventListener('click',()=>addYN(state.sections.battleground));
  el('#bgAddCU').addEventListener('click',()=>addCU(state.sections.battleground));
  el('#bgAddCS').addEventListener('click',()=>addCS(state.sections.battleground));
  el('#bgImport').addEventListener('click',importBG);
  el('#bgBuild').addEventListener('click',buildH2H);

  el('#boAddOU').addEventListener('click',()=>addOU(state.sections.bonus));
  el('#boAddMR').addEventListener('click',()=>addMR(state.sections.bonus));
  el('#boAddYN').addEventListener('click',()=>addYN(state.sections.bonus));
  el('#boAddCU').addEventListener('click',()=>addCU(state.sections.bonus));
  el('#boAddGB').addEventListener('click',()=>addGB(state.sections.bonus));

  el('#pvAddOU').addEventListener('click',()=>addOU(state.sections.pvp));
  el('#pvAddMR').addEventListener('click',()=>addMR(state.sections.pvp));
  el('#pvAddYN').addEventListener('click',()=>addYN(state.sections.pvp));
  el('#pvAddCU').addEventListener('click',()=>addCU(state.sections.pvp));

  // boot
  syncToggles(); paintAll(); if(state.lastUpdated){ el('#stamp').textContent='Last publish @ '+new Date(state.lastUpdated).toLocaleTimeString(); }
})();
</script>
</body>
</html>
