<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>L3Z — Bets Admin (Unified)</title>
<meta http-equiv="Cache-Control" content="no-store"/>
<style>
  :root{
    --bg:#060b0d; --panel:#0b1417; --ink:#eaf7ff; --muted:#9fd0d6;
    --line:rgba(0,255,255,.18); --teal:#00ffff; --gold:#ffb42d;
    --ok:#12d48a; --bad:#e25a6f; --ink2:#cfffff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:#000 url("/assets/BG_page.png") center/cover fixed no-repeat;color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 16px 80px}
  .top{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
  h1{margin:0;color:var(--teal);text-shadow:0 0 14px #00ffff55}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:var(--ink2)}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 8px}
  .tab{appearance:none;border:1px solid var(--line);border-radius:999px;background:#0a1116;color:#cfe;padding:8px 12px;font-weight:800;cursor:pointer}
  .tab.on{background:rgba(0,255,255,.08);border-color:var(--teal);box-shadow:0 0 0 1px rgba(0,255,255,.1) inset}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,textarea,select{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:var(--ink);padding:8px}
  textarea{width:100%;min-height:80px}
  .btn{border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#0f1720;color:var(--ink);font-weight:800;cursor:pointer}
  .btn.ok{background:#103d30;border-color:#1fa37b}
  .btn.warn{background:#231b0f;border-color:#8c6926}
  .btn.danger{background:#2b1116;border-color:#7e2a3c}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl th,.tbl td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px;text-align:left;font-size:13px}
  .tbl th{color:var(--muted)}
  .right{margin-left:auto}
  .muted{color:var(--muted);font-size:12px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1f21;border:1px solid var(--line);border-radius:10px;padding:10px 12px;opacity:0;transform:translateY(8px);transition:.2s;pointer-events:none;z-index:9999}
  .toast.on{opacity:1;transform:translateY(0)}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>

<!-- DEV KILL SWITCH: keeps admin open while you build -->
<script src="/assets/js/admin-dev-open.js"></script>

<!-- Minimal API helper (uses global api if already present) -->
<script>
(function(){
  if (window.api && typeof window.api.get==="function") return;
  function isJson(r){return (r.headers.get("content-type")||"").indexOf("application/json")>-1;}
  function core(p,o){o=o||{};return fetch(p,{credentials:"include",cache:"no-store",headers:o.headers||{},method:o.method||"GET",body:o.body}).then(function(r){
    return (isJson(r)?r.json():r.text()).catch(function(){return null;}).then(function(b){
      if(!r.ok||(b&&b.ok===false)){var e=new Error((b&&b.error)||("HTTP "+r.status));e.status=r.status;e.body=b;throw e;}
      return b==null?{ok:true}:b;
    });
  });}
  window.api={
    get:function(p,o){return core(p,o||{});},
    post:function(p,b,o){o=o||{};o.method="POST";o.headers=Object.assign({"Content-Type":"application/json"},o.headers||{});o.body=JSON.stringify(b||{});return core(p,o);}
  };
})();
</script>

<div class="wrap">
  <div class="top">
    <h1>Bets Admin</h1>
    <span class="pill" id="env">—</span>
    <span class="muted">Create events and publish to players.</span>
    <button id="btnPublishAll" class="btn ok right">Publish All Drafts</button>
  </div>

  <div class="tabs" role="tablist" aria-label="Event kind">
    <button class="tab on"  data-kind="battleground" role="tab" aria-selected="true">Battleground</button>
    <button class="tab"      data-kind="bonus"        role="tab" aria-selected="false">Bonus Hunt</button>
    <button class="tab"      data-kind="pvp"          role="tab" aria-selected="false">PVP</button>
  </div>

  <div class="grid">
    <!-- EDITOR -->
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input id="evTitle" placeholder="Event title (e.g., Battleground — Custom Markets)" style="flex:1;min-width:220px">
        <input id="evId" placeholder="Event ID (optional)" style="width:220px">
        <select id="evKind" style="width:160px">
          <option value="battleground">Battleground</option>
          <option value="bonus">Bonus Hunt</option>
          <option value="pvp">PVP</option>
        </select>
      </div>

      <table class="tbl" id="pickTable">
        <thead>
          <tr><th style="width:34%">Left</th><th style="width:34%">Right</th><th>Pick Name</th><th style="width:90px"></th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="row" style="margin-top:10px">
        <button id="btnAddRow" class="btn">+ Add Pick</button>
        <button id="btnClear" class="btn warn">Clear Editor</button>
        <span class="muted">Each row becomes one pick players can choose from.</span>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="btnSaveDraft" class="btn ok">Save Draft</button>
        <button id="btnPublishOne" class="btn">Publish This Event</button>
        <span id="editMsg" class="pill">Ready</span>
      </div>
    </div>

    <!-- DRAFTS LIST -->
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <div style="font-weight:900">Drafts</div>
        <button id="btnRefresh" class="btn right">Refresh</button>
      </div>
      <div style="max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:10px">
        <table class="tbl" id="draftTbl">
          <thead><tr><th>Kind</th><th>Title</th><th>ID</th><th>Created</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:6px">Click “Load” to bring a draft back into the editor.</div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Saved.</div>

<script>
(function(){
  "use strict";
  if (window.__BETS_ADMIN__) return; window.__BETS_ADMIN__ = true;

  // ===== Helpers
  var $ = function(s,r){ return (r||document).querySelector(s); };
  var $$ = function(s,r){ return Array.from((r||document).querySelectorAll(s)); };
  var env = $("#env"); try{ env.textContent = location.origin; }catch(_){}
  var toast = $("#toast"); function showToast(t){ toast.textContent=t||"Saved."; toast.classList.add("on"); setTimeout(function(){ toast.classList.remove("on"); }, 1400); }
  function up(s){ return String(s||"").trim().toUpperCase(); }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, function(m){ return m==="&"?"&amp;":m==="<"?"&lt;":m===">"?"&gt;":"&quot;"; }); }

  // ===== Elements
  var evTitle=$("#evTitle"), evId=$("#evId"), evKind=$("#evKind");
  var pickTbody=$("#pickTable tbody");
  var btnAddRow=$("#btnAddRow"), btnSaveDraft=$("#btnSaveDraft"), btnPublishOne=$("#btnPublishOne");
  var btnPublishAll=$("#btnPublishAll"), btnRefresh=$("#btnRefresh"), btnClear=$("#btnClear");
  var editMsg=$("#editMsg"), draftTbody=$("#draftTbl tbody");

  // ===== Tabs (kind)
  var activeKind="battleground";
  $$(".tab").forEach(function(b){
    b.addEventListener("click", function(){
      $$(".tab").forEach(function(x){ x.classList.remove("on"); x.setAttribute("aria-selected","false"); });
      b.classList.add("on"); b.setAttribute("aria-selected","true");
      activeKind = b.getAttribute("data-kind");
      evKind.value = activeKind;
      refreshDrafts();
    });
  });

  // ===== Row management
  function addRow(p){
    var tr=document.createElement("tr");
    tr.innerHTML = '<td><input placeholder="Left" value="'+esc(p&&p.left||'')+'"></td>'
                 + '<td><input placeholder="Right" value="'+esc(p&&p.right||'')+'"></td>'
                 + '<td><input placeholder="Pick name" value="'+esc(p&&p.pickName||'')+'"></td>'
                 + '<td><button type="button" class="btn danger btnDel">Del</button></td>';
    pickTbody.appendChild(tr);
    tr.querySelector(".btnDel").addEventListener("click", function(){ tr.remove(); });
  }
  btnAddRow.addEventListener("click", function(){ addRow(); });
  btnClear.addEventListener("click", function(){
    evTitle.value=""; evId.value=""; pickTbody.innerHTML=""; addRow();
    editMsg.textContent="Cleared";
  });

  // start with one row
  addRow();

  // ===== Serialize editor
  function readEditor(){
    var picks = $$("#pickTable tbody tr").map(function(tr){
      var tds = tr.querySelectorAll("td");
      return {
        left: (tds[0].querySelector("input").value||"").trim(),
        right:(tds[1].querySelector("input").value||"").trim(),
        pickName:(tds[2].querySelector("input").value||"").trim()
      };
    }).filter(function(p){ return p.left || p.right || p.pickName; });

    return {
      kind: evKind.value || activeKind,
      eventTitle: (evTitle.value||"").trim() || "Untitled Event",
      eventId: (evId.value||"").trim() || ("EVT-"+Math.random().toString(36).slice(2,8).toUpperCase()),
      picks: picks,
      ts: Date.now()
    };
  }

  // ===== Backend routes + local fallback
  var LS_KEY="adm:bets"; // local fallback cache for dev
  function lsRead(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]")||[]; }catch(_){ return []; } }
  function lsWrite(arr){ try{ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }catch(_){} }

  function saveDraft(body){
    // Try server first
    return api.post("/api/admin/bets", body).catch(function(e){
      // Fallback: local
      var arr = lsRead(); body.id = body.id || ("DRAFT-"+Math.random().toString(36).slice(2,10).toUpperCase());
      arr.push(body); lsWrite(arr);
      return { ok:true, id: body.id, local:true };
    });
  }

  function listDrafts(kind){
    return api.get("/api/admin/bets?status=draft&kind="+encodeURIComponent(kind)).catch(function(){
      var arr = lsRead().filter(function(x){ return x && x.kind===kind; });
      return { ok:true, items: arr, local:true };
    });
  }

  function publishEvent(eventId){
    return api.post("/api/admin/bets/publish", { id:eventId }).catch(function(){
      // local: just remove from LS
      var arr = lsRead().filter(function(x){ return (x.eventId||x.id)!==eventId; });
      lsWrite(arr);
      return { ok:true, local:true };
    });
  }

  function publishAllDrafts(){
    return api.post("/api/admin/bets/publish", { all:true, kind:activeKind }).catch(function(){
      var arr = lsRead().filter(function(x){ return x.kind!==activeKind; });
      lsWrite(arr);
      return { ok:true, local:true };
    });
  }

  // ===== Draft list render
  function refreshDrafts(){
    draftTbody.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
    listDrafts(activeKind).then(function(j){
      var items = (j.items||[]).slice().sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
      if(!items.length){ draftTbody.innerHTML = '<tr><td colspan="5" class="muted">No drafts</td></tr>'; return; }
      draftTbody.innerHTML = items.map(function(d){
        var created = new Date(d.ts||Date.now()).toLocaleString();
        return '<tr>'
          + '<td>'+esc(d.kind)+'</td>'
          + '<td>'+esc(d.eventTitle||"")+'</td>'
          + '<td>'+esc(d.eventId||d.id||"")+'</td>'
          + '<td>'+esc(created)+'</td>'
          + '<td>'
            + '<button type="button" class="btn btnLoad" data-id="'+esc(d.eventId||d.id)+'">Load</button> '
            + '<button type="button" class="btn ok btnPub" data-id="'+esc(d.eventId||d.id)+'">Publish</button>'
          + '</td>'
        +'</tr>';
      }).join("");

      // wire actions
      $$(".btnLoad", draftTbody).forEach(function(b){
        b.addEventListener("click", function(){
          var id = b.getAttribute("data-id");
          var found = (j.items||[]).find(function(x){ return (x.eventId||x.id)===id; });
          if(!found) return;
          evTitle.value = found.eventTitle||"";
          evId.value = found.eventId||found.id||"";
          evKind.value = found.kind||activeKind;
          pickTbody.innerHTML = "";
          (found.picks||[]).forEach(addRow);
          if(!found.picks || !found.picks.length) addRow();
          showToast("Draft loaded");
        });
      });
      $$(".btnPub", draftTbody).forEach(function(b){
        b.addEventListener("click", function(){
          var id = b.getAttribute("data-id");
          editMsg.textContent="Publishing…";
          publishEvent(id).then(function(){
            showToast("Published"); refreshDrafts();
            editMsg.textContent="Published";
          }).catch(function(){ editMsg.textContent="Publish failed"; });
        });
      });
    }).catch(function(){
      draftTbody.innerHTML = '<tr><td colspan="5" class="muted">Failed to load drafts</td></tr>';
    });
  }

  // ===== Buttons
  btnSaveDraft.addEventListener("click", function(){
    var body = readEditor();
    if(!body.picks.length){ editMsg.textContent="Add at least one pick"; return; }
    editMsg.textContent = "Saving…";
    saveDraft(body).then(function(r){
      editMsg.textContent = r.local ? "Saved (local)" : "Saved";
      showToast("Draft saved");
      refreshDrafts();
    }).catch(function(e){
      editMsg.textContent = (e.body&&e.body.error)||"Save failed";
    });
  });

  btnPublishOne.addEventListener("click", function(){
    var body = readEditor();
    if(!body.picks.length){ editMsg.textContent="Add at least one pick"; return; }
    // Save, then publish that ID
    editMsg.textContent="Saving…";
    saveDraft(body).then(function(r){
      var id = body.eventId;
      editMsg.textContent="Publishing…";
      return publishEvent(id);
    }).then(function(){
      showToast("Published");
      refreshDrafts();
      editMsg.textContent="Published";
    }).catch(function(e){
      editMsg.textContent = (e.body&&e.body.error)||"Publish failed";
    });
  });

  btnPublishAll.addEventListener("click", function(){
    btnPublishAll.disabled = true;
    publishAllDrafts().then(function(){
      showToast("All drafts published");
      refreshDrafts();
    }).finally(function(){ btnPublishAll.disabled=false; });
  });

  btnRefresh.addEventListener("click", refreshDrafts);

  // initial load
  refreshDrafts();
})();
</script>
</body>
</html>
