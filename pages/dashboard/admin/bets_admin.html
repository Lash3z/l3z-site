<!DOCTYPE html>
<html lang="en" data-admin="checking">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bets Admin — Unified (BG / Bonus / PVP)</title>
<style>
:root{
  --bg:#060b0d;--panel:#0b1417;--ink:#eaf7ff;--muted:#9fd0d6;
  --line:rgba(0,255,255,.18);--teal:#00ffff;--gold:#ffb42d;--bad:#e25a6f;--ok:#12d48a
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Segoe UI",system-ui,Arial,sans-serif}
html[data-admin="checking"] body{opacity:0;transition:opacity .12s ease}

.wrap{max-width:1400px;margin:0 auto;padding:16px 16px 64px}
h1{margin:0 0 12px;color:var(--teal);text-shadow:0 0 14px rgba(0,255,255,.33)}
.card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.btn{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#0f1720;color:#eaf7ff;font-weight:800;cursor:pointer}
.btn.ok{background:#103d30;border-color:#1fa37b}
.btn.danger{background:#2b1116;border-color:#7e2a3c}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
input,select{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:#eaf7ff;padding:10px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
.h2hList{display:flex;flex-direction:column;gap:12px}
.h2h{border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
.side{border:1px solid var(--line);border-radius:12px;background:#0c1519;padding:10px;display:grid;grid-template-columns:80px 1fr;gap:10px;align-items:center}
.thumb{width:80px;height:108px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#000}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.title{font-weight:900}
.prov{font-size:12px;color:#9fd0d6}
.oddBox{margin-top:8px}
.small{font-size:12px;color:#9fd0d6}
.head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#081318;color:#bfe}
.badge.lock{background:#231519;color:#ffc0cc;border-color:#7e2a3c}
.sectionTitle{font-weight:900;margin-bottom:8px}
.mkts{display:flex;flex-direction:column;gap:12px}
.mkt{border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:12px}
.mTop{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.selRow{display:grid;grid-template-columns:1fr 110px auto;gap:8px;margin:6px 0}
.lineRow{display:flex;align-items:center;gap:8px;margin:4px 0}
.del{border:1px solid var(--line);border-radius:10px;background:#2b1116;color:#ffd0d6;padding:8px 10px;cursor:pointer}
.kv{display:flex;gap:8px;align-items:center}
.kv b{color:var(--muted)}
.hr{height:1px;background:var(--line);margin:10px 0}
.toggleRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.toggleRow label{display:flex;gap:6px;align-items:center}
.subtle{font-size:12px;color:var(--muted)}
.badline{border:1px dashed #7e2a3c;padding:6px;border-radius:8px}
.goodline{border:1px dashed #1fa37b;padding:6px;border-radius:8px}
</style>
</head>
<body>

<script>
(function(){
  "use strict";
  const ADMIN_CHECK="/api/admin/gate/check", ADMIN_LOGIN="/pages/dashboard/admin/admin_login.html", DASH="/index.html";
  const H=document.documentElement; H.setAttribute("data-admin","checking");
  function unlock(){ H.removeAttribute("data-admin"); }
  function lock(){
    unlock();
    const s=document.createElement("style");
    s.textContent=".lockwrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f12;color:#eaf7ff;font-family:Segoe UI,system-ui,Arial,sans-serif}.lockcard{max-width:640px;margin:24px;padding:24px;border:1px solid rgba(0,255,255,.2);border-radius:14px;background:rgba(0,0,0,.75)}.lockcard h1{margin:0 0 10px;color:#cfe}.lockcard a{color:#7ad7ff;text-decoration:underline}";
    document.head.appendChild(s);
    document.body.innerHTML='<div class="lockwrap"><div class="lockcard"><h1>Administration Locked</h1><div>You must unlock admin on the <a href="'+ADMIN_LOGIN+'">Admin Login</a> first.</div><div style="margin-top:8px;opacity:.85">If you just logged in elsewhere, your unlock may have expired.</div><div style="margin-top:14px"><a href="'+DASH+'">Back to Dashboard</a></div></div></div>';
  }
  fetch(ADMIN_CHECK,{credentials:"include",cache:"no-store"})
    .then(r=>r.ok?r.json():null)
    .then(j=>{ if(j && (j.admin||j.isAdmin)) unlock(); else lock(); })
    .catch(lock);
})();
</script>

<div class="wrap">
  <h1>Bets Admin — Unified</h1>

  <div class="card row" style="justify-content:space-between">
    <div class="row">
      <button id="btnSave" class="btn">Save</button>
      <button id="btnPublish" class="btn ok">Publish to Players</button>
      <button id="btnOpenAll" class="btn">Open All</button>
      <button id="btnLockAll" class="btn">Lock All</button>
      <button id="btnDelete" class="btn danger">Delete All</button>
    </div>
    <div class="row">
      <span id="stamp" class="pill">Not published</span>
      <span id="msg" class="pill">Ready</span>
    </div>
  </div>

  <div class="card toggleRow">
    <label><input id="enBG" type="checkbox"> <b>Battleground</b></label>
    <label><input id="enBONUS" type="checkbox"> <b>Bonus Hunt</b></label>
    <label><input id="enPVP" type="checkbox"> <b>PVP Predictions</b></label>
    <span class="subtle">Bonus Hunt is <b>fixed</b>: six predictions auto-created & auto-settled from the Bonus Hunt page. You only set Stake/Prize.</span>
  </div>

  <div class="grid">
    <!-- Battleground -->
    <div id="secBG" class="card" style="display:none">
      <div class="head">
        <div class="sectionTitle">Battleground</div>
        <div class="badge" id="statusBG">OPEN</div>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <button class="btn" id="bgAddOU">+ Over/Under</button>
          <button class="btn" id="bgAddMR">+ Multi-Range</button>
          <button class="btn" id="bgAddYN">+ Yes/No</button>
          <button class="btn" id="bgAddCU">+ Custom</button>
          <button class="btn" id="bgAddCS">+ Which Matchup Clean Sweep?</button>
        </div>
        <div class="row">
          <button class="btn" id="bgImport">Import Matchups</button>
          <button class="btn" id="bgBuild">Build/Refresh H2H</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="sectionTitle">Head-to-Head</div>
      <div id="bgH2H" class="h2hList"></div>
      <div class="kv"><b>Debug:</b> Last Import → <span id="dbgImport">none</span></div>
      <div class="hr"></div>
      <div class="sectionTitle">Overall Markets</div>
      <div id="bgMkts" class="mkts"></div>
    </div>

    <!-- Bonus Hunt -->
    <div id="secBONUS" class="card" style="display:none">
      <div class="head" style="gap:8px">
        <div class="sectionTitle">Bonus Hunt</div>
        <div class="badge" id="statusBONUS">OPEN</div>
        <span class="pill">Reads <code>bh:live</code> → falls back to <code>bh:draft</code></span>
        <button class="btn" id="boSettle">Settle from Bonus Hunt</button>
      </div>
      <div class="subtle">No setup fields. These six are prefilled & settled from the Bonus Hunt Admin data. You only tweak <b>Stake</b> (and optional <b>Prize</b>).</div>
      <div class="hr"></div>
      <div id="boMkts" class="mkts"></div>
    </div>

    <!-- PVP -->
    <div id="secPVP" class="card" style="display:none">
      <div class="head">
        <div class="sectionTitle">PVP Predictions</div>
        <div class="badge" id="statusPVP">OPEN</div>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <button class="btn" id="pvAddOU">+ Over/Under</button>
          <button class="btn" id="pvAddMR">+ Multi-Range</button>
          <button class="btn" id="pvAddYN">+ Yes/No</button>
          <button class="btn" id="pvAddCU">+ Custom</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="pvMkts" class="mkts"></div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  // helpers
  const els = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const el  = (s,r=document)=>r.querySelector(s);
  const sget=(k)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):null}catch{ return null }};
  const sset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const esc =(s)=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const kid =(p='ID')=>p+Math.random().toString(36).slice(2,10).toUpperCase();
  const toast=(t,ok)=>{ const m=el('#msg'); if(!m) return; m.textContent=t; m.style.color = ok===false ? '#ff9aa7' : '#baffea'; setTimeout(()=>{ m.textContent=''; }, 2200); };
  const slug=(s)=>String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

  // Normalize any path to absolute /assets/slot_images/…
  const absPath=(p)=>{
    if(!p) return '';
    let x=String(p).trim();
    x=x.replace(/\\/g,'/').replace(/slot images\//gi,'slot_images/');
    x=x.replace(/^\.?\//,''); // drop leading ./ or /
    if(!/^assets\//i.test(x)) return '/'+x; // if already like images/foo keep absolute
    return '/'+x; // /assets/...
  };

  // keys
  const K_UNIFIED='sb:markets:unified';
  const K_BG_BUILDER='bg:builder:battleground';
  const K_BH_LIVE='bh:live';
  const K_BH_DRAFT='bh:draft';

  // state
  let state = sget(K_UNIFIED) || {
    status:'open', lastUpdated:0,
    sections:{
      battleground:{enabled:false,h2h:[],overall:[]},
      bonus:{enabled:false,overall:[]},
      pvp:{enabled:false,overall:[]}
    }
  };

  // ---------- safety: normalize BG builder images on boot ----------
  function normalizeBGBuilder(){
    const b=sget(K_BG_BUILDER);
    if(!b) return;
    let changed=false;

    if(Array.isArray(b.games)){
      b.games.forEach(g=>{
        const before=g.imageUrl||g.image;
        const after = absPath(before||'');
        if(before!==after){ g.imageUrl=after; changed=true; }
      });
    }
    if(Array.isArray(b.matches)){
      b.matches.forEach(m=>{
        const L = absPath(m.leftImg || '');
        const R = absPath(m.rightImg|| '');
        if(m.leftImg!==L){ m.leftImg=L; changed=true; }
        if(m.rightImg!==R){ m.rightImg=R; changed=true; }
      });
    }
    if(changed) sset(K_BG_BUILDER,b);
  }

  // ---------- toggles & paint ----------
  function setupBonusDefaults(){
    const b=state.sections.bonus;
    if(!b.overall.length){
      b.overall=[
        {id:kid('GBAL'),code:'BAL',type:'NUMERIC_GUESS',fixed:true,label:'Guess the Final Balance',stake:10,prize:0,final:null,winners:[]},
        {id:kid('HPG'), code:'HIGH_PAY',type:'TEXT_GUESS',fixed:true,label:'Which game pays the MOST money?',stake:10,prize:0,finalText:'',winners:[]},
        {id:kid('LPG'), code:'LOW_PAY', type:'TEXT_GUESS',fixed:true,label:'Which game pays the LEAST money?',stake:10,prize:0,finalText:'',winners:[]},
        {id:kid('HX'),  code:'HIGH_X',  type:'NUMERIC_GUESS',fixed:true,label:'Highest X payout',stake:10,prize:0,final:null,winners:[]},
        {id:kid('LX'),  code:'LOW_X',   type:'NUMERIC_GUESS',fixed:true,label:'Lowest X payout',stake:10,prize:0,final:null,winners:[]},
        {id:kid('C100'),code:'CNT_100X',type:'NUMERIC_GUESS',fixed:true,label:'How many 100x wins?',stake:10,prize:0,final:null,winners:[]}
      ];
      save();
    }
  }

  function syncToggles(){
    const s=state.sections;
    el('#enBG').checked   = !!s.battleground.enabled;
    el('#enBONUS').checked= !!s.bonus.enabled;
    el('#enPVP').checked  = !!s.pvp.enabled;

    el('#secBG').style.display   = s.battleground.enabled ? '' : 'none';
    el('#secBONUS').style.display= s.bonus.enabled ? '' : 'none';
    el('#secPVP').style.display  = s.pvp.enabled ? '' : 'none';

    const status=(state.status||'open').toUpperCase();
    el('#statusBG').textContent=status;
    el('#statusBONUS').textContent=status;
    el('#statusPVP').textContent=status;

    if(s.bonus.enabled){ setupBonusDefaults(); autoSettleFromBH(); }
  }

  ['#enBG','#enBONUS','#enPVP'].forEach(sel=>{
    const n=el(sel);
    if(!n) return;
    n.addEventListener('change',()=>{
      if(sel==='#enBG')   state.sections.battleground.enabled=n.checked;
      if(sel==='#enBONUS')state.sections.bonus.enabled=n.checked;
      if(sel==='#enPVP')  state.sections.pvp.enabled=n.checked;
      save(); syncToggles(); paintAll();
    });
  });

  function paintAll(){ paintH2H(); paintMkts('battleground','#bgMkts'); paintMkts('bonus','#boMkts'); paintMkts('pvp','#pvMkts'); }

  function paintH2H(){
    const sec=state.sections.battleground;
    const box=el('#bgH2H'); box.innerHTML='';
    if(!sec.h2h.length){ box.innerHTML='<div class="pill">No H2H yet. Import → Build/Refresh.</div>'; return; }
    sec.h2h.forEach((h,idx)=>{
      const Limg=h.leftImg?`<img src="${esc(absPath(h.leftImg))}" alt="">`:''; 
      const Rimg=h.rightImg?`<img src="${esc(absPath(h.rightImg))}" alt="">`:'';
      const L='<div class="side"><div class="thumb">'+Limg+'</div><div><div class="title">'+esc(h.leftTitle||'LEFT')+'</div><div class="prov">'+esc(h.leftProv||'')+'</div><div class="oddBox"><span class="small">Odds</span> <input data-k="l'+idx+'" type="number" step="0.01" value="'+esc(h.leftOdds||1.84)+'" style="width:110px"></div></div></div>';
      const R='<div class="side"><div class="thumb">'+Rimg+'</div><div><div class="title">'+esc(h.rightTitle||'RIGHT')+'</div><div class="prov">'+esc(h.rightProv||'')+'</div><div class="oddBox"><span class="small">Odds</span> <input data-k="r'+idx+'" type="number" step="0.01" value="'+esc(h.rightOdds||1.84)+'" style="width:110px"></div></div></div>';
      const row=document.createElement('div'); row.className='h2h'; row.innerHTML=L+R;
      row.querySelector('[data-k="l'+idx+'"]')?.addEventListener('change',e=>{ sec.h2h[idx].leftOdds=+e.target.value||1; save(); });
      row.querySelector('[data-k="r'+idx+'"]')?.addEventListener('change',e=>{ sec.h2h[idx].rightOdds=+e.target.value||1; save(); });
      box.appendChild(row);
    });
  }

  function paintMkts(section, mount){
    const sec=state.sections[section];
    const host=el(mount); host.innerHTML='';
    if(!sec.overall.length){ host.innerHTML='<div class="pill">No markets yet.</div>'; return; }

    sec.overall.forEach((m,mi)=>{
      const box=document.createElement('div'); box.className='mkt';

      const typePart = m.fixed ? '<span class="pill">'+(m.type.replace('_',' '))+'</span>' : (
        '<select data-x="type">'+
          '<option '+(m.type==='OVER_UNDER'?'selected':'')+'>OVER_UNDER</option>'+
          '<option '+(m.type==='MULTI_RANGE'?'selected':'')+'>MULTI_RANGE</option>'+
          '<option '+(m.type==='YES_NO'?'selected':'')+'>YES_NO</option>'+
          '<option '+(m.type==='CUSTOM'?'selected':'')+'>CUSTOM</option>'+
          '<option '+(m.type==='NUMERIC_GUESS'?'selected':'')+'>NUMERIC_GUESS</option>'+
          '<option '+(m.type==='TEXT_GUESS'?'selected':'')+'>TEXT_GUESS</option>'+
        '</select>'
      );

      const top='<div class="mTop">'+
        typePart+
        '<input data-x="label" '+(m.fixed?'disabled':'')+' placeholder="Market label" value="'+esc(m.label||'')+'" style="min-width:260px">'+
        '<span class="pill">Stake</span><input data-x="stake" type="number" step="1" value="'+(m.stake!=null?m.stake:10)+'" style="width:110px">'+
        '<span class="pill">Prize</span><input data-x="prize" type="number" step="1" value="'+(m.prize||0)+'" style="width:110px">'+
        '<select data-x="status"><option '+(m.status!=='locked'?'selected':'')+'>OPEN</option><option '+(m.status==='locked'?'selected':'')+'>LOCKED</option></select>'+
        (m.fixed?'':'<button class="del" data-act="del">Delete</button>')+
      '</div>';

      const extraFixed = (section==='bonus' && m.fixed)
        ? ('<div class="lineRow '+(m.type==='TEXT_GUESS'?'goodline':'badline')+'">'+
           '<span class="pill">Result from Bonus Hunt</span>'+
           (m.type==='TEXT_GUESS'?('<b>'+esc(m.finalText||'—')+'</b>'):('<b>'+(m.final!=null?m.final:'—')+'</b>'))+
           '<span class="small">Entries: <b data-x="entries">'+(getEntries(section,m.id).length)+'</b> · Winners: <b>'+(m.winners?m.winners.length:0)+'</b></span></div>')
        : '';

      const extraOU = (!m.fixed && m.type==='OVER_UNDER')
        ? ('<div class="lineRow"><span class="pill">LINE</span> <input data-x="line" type="number" step="0.01" value="'+(m.line!=null?m.line:'')+'" style="width:140px"></div>')
        : '';

      const sels = (!m.fixed ? (m.selections||[]).map((s,si)=> '<div class="selRow">'+
            '<input data-sel="'+si+'" data-x="slabel" placeholder="Selection" value="'+esc(s.label||'')+'">'+
            '<input data-sel="'+si+'" data-x="sodds" type="number" step="0.01" value="'+esc(s.odds||1.84)+'">'+
            '<button class="del" data-act="sdel" data-sel="'+si+'">×</button>'+ '</div>' ).join('') : '' );

      const addBtn = (!m.fixed ? '<div><button class="btn" data-act="addSel">+ Add Line</button></div>' : '');

      box.innerHTML = top + extraFixed + extraOU + sels + addBtn;

      box.querySelector('[data-x="type"]')?.addEventListener('change',e=>{ sec.overall[mi].type=e.target.value; save(); paintMkts(section,mount); });
      box.querySelector('[data-x="label"]')?.addEventListener('change',e=>{ sec.overall[mi].label=e.target.value; save(); });
      box.querySelector('[data-x="stake"]')?.addEventListener('change',e=>{ sec.overall[mi].stake=+e.target.value||0; save(); });
      box.querySelector('[data-x="prize"]')?.addEventListener('change',e=>{ sec.overall[mi].prize=+e.target.value||0; save(); });
      box.querySelector('[data-x="status"]')?.addEventListener('change',e=>{ sec.overall[mi].status=(e.target.value||'OPEN').toLowerCase()==='locked'?'locked':'open'; save(); });
      box.querySelector('[data-x="line"]')?.addEventListener('change',e=>{ const v=+e.target.value; sec.overall[mi].line=v; if(sec.overall[mi].selections?.length>=2){ sec.overall[mi].selections[0].label='Over '+v; sec.overall[mi].selections[1].label='Under '+v; } save(); paintMkts(section,mount); });

      host.appendChild(box);
    });
  }

  // quick creators
  function addOU(sec){ sec.overall.push({id:kid('OU'),type:'OVER_UNDER',label:'Over / Under',status:'open',stake:10,selections:[{id:kid('SEL'),label:'Over 65.5',odds:1.84},{id:kid('SEL'),label:'Under 65.5',odds:1.84}]}); save(); paintAll(); }
  function addMR(sec){ sec.overall.push({id:kid('MR'),type:'MULTI_RANGE',label:'Total Games Played',status:'open',stake:10,selections:[{id:kid('SEL'),label:'48–55.5',odds:17},{id:kid('SEL'),label:'56–63.5',odds:3.4},{id:kid('SEL'),label:'64–71.5',odds:1.7},{id:kid('SEL'),label:'72–80',odds:4.25}]}); save(); paintAll(); }
  function addYN(sec){ sec.overall.push({id:kid('YN'),type:'YES_NO',label:'Yes / No',status:'open',stake:10,selections:[{id:kid('SEL'),label:'Yes',odds:1.84},{id:kid('SEL'),label:'No',odds:1.84}]}); save(); paintAll(); }
  function addCU(sec){ sec.overall.push({id:kid('CU'),type:'CUSTOM',label:'Custom Market',status:'open',stake:10,selections:[]}); save(); paintAll(); }
  function addCS(sec){
    if(!state.sections.battleground.h2h.length){ toast('Build H2H first',false); return; }
    const m={id:kid('CS'),type:'CUSTOM',label:'Which matchup clean sweep?',status:'open',stake:10,selections:[]};
    state.sections.battleground.h2h.forEach(h=>{
      m.selections.push({id:kid('SEL'),label:(h.leftTitle||'LEFT')+' 3-0',odds:3.0});
      m.selections.push({id:kid('SEL'),label:(h.rightTitle||'RIGHT')+' 3-0',odds:3.0});
    });
    sec.overall.push(m); save(); paintAll();
  }

  // entries/settle (unchanged)
  const entriesKey=(section,mid)=>'sb:entries:'+section+':'+mid;
  const getEntries=(section,mid)=>sget(entriesKey(section,mid))||[];
  function settleNumericGuess(section,m){ const entries=getEntries(section,m.id); if(!entries.length||m.final==null||isNaN(m.final)){m.winners=[];return;} let best=Infinity,win=[]; entries.forEach(e=>{const d=Math.abs((+e.guess)-(+m.final)); if(d<best){best=d;win=[e]} else if(d===best){win.push(e)} }); m.winners=win.map(w=>({userId:w.userId||w.name||'anon',name:w.name||('User'+(w.userId||'')),guess:+w.guess,diff:Math.abs((+w.guess)-(+m.final))})); }
  function settleTextGuess(section,m){ const entries=getEntries(section,m.id); const final=(m.finalText||'').trim(); if(!entries.length||!final){m.winners=[];return;} const f=slug(final); const win=entries.filter(e=>slug(e.guess)===f); m.winners=win.map(w=>({userId:w.userId||w.name||'anon',name:w.name||('User'+(w.userId||'')),guess:String(w.guess)})); }
  const readBH=()=>sget(K_BH_LIVE)||sget(K_BH_DRAFT);
  function autoSettleFromBH(){
    const src=readBH(),b=state.sections.bonus; if(!b.enabled) return;
    if(!src||!Array.isArray(src.entries)){ toast('Bonus Hunt data not found (bh:live / bh:draft).',false); return; }
    const opened=src.entries.filter(e=>e && (e.done||Number(e.payout||0)>0));
    const start=Number(src.start||0);
    const sum=(arr,fn)=>arr.reduce((a,x)=>a+Number(fn(x)||0),0);
    const finalBalance=+(start - sum(opened,e=>e.bet) + sum(opened,e=>e.payout)).toFixed(2);
    const byPay=opened.slice().sort((a,b)=>Number(b.payout||0)-Number(a.payout||0));
    const byXH=opened.slice().sort((a,b)=>Number(b.x||0)-Number(a.x||0));
    const byXL=opened.slice().sort((a,b)=>Number(a.x||0)-Number(b.x||0));
    const highestGame=byPay[0]?.slot||'', lowestGame=opened.slice().sort((a,b)=>Number(a.payout||0)-Number(b.payout||0))[0]?.slot||'';
    const highX=byXH[0]?.x!=null?Number(byXH[0].x).toFixed(2):null; const lowX=byXL[0]?.x!=null?Number(byXL[0].x).toFixed(2):null;
    const cnt100=opened.filter(e=>Number(e.x||0)>=100).length;

    const set=(code,f)=>{const m=b.overall.find(x=>x.code===code); if(m) f(m);};
    set('BAL',m=>{m.final=finalBalance; settleNumericGuess('bonus',m);});
    set('HIGH_PAY',m=>{m.finalText=highestGame; settleTextGuess('bonus',m);});
    set('LOW_PAY',m=>{m.finalText=lowestGame;  settleTextGuess('bonus',m);});
    set('HIGH_X',m=>{m.final=highX!=null?Number(highX):null; settleNumericGuess('bonus',m);});
    set('LOW_X', m=>{m.final=lowX!=null?Number(lowX):null;  settleNumericGuess('bonus',m);});
    set('CNT_100X',m=>{m.final=cnt100; settleNumericGuess('bonus',m);});
    save(); paintMkts('bonus','#boMkts'); toast('Bonus Hunt results synced.');
  }

  // BG import/build
  async function importBG(){
    let used='';
    const prefer=sget(K_BG_BUILDER);
    if(prefer && Array.isArray(prefer.matches) && prefer.matches.length){
      used='local:'+K_BG_BUILDER;
      acceptMatches(prefer.matches,used,true);
      return;
    }
    const scan=['BG_MATCHUPS','BATTLEGROUND_MATCHUPS','BATTLEGROUND_SELECTED','BG_SELECTED_GAMES','battleground:matches','battleground:admin:matches','bg:admin:matches','bg:matchups'];
    for(const k of scan){
      const v=sget(k);
      if(Array.isArray(v)&&v.length){
        used='local:'+k;
        const norm=v.map((m,i)=>({
          id:m.id||m.matchId||('M'+i),
          leftId:m.leftId||m.AId||m.aId||m.left?.id||m.A?.id||null,
          rightId:m.rightId||m.BId||m.bId||m.right?.id||m.B?.id||null,
          leftTitle:m.leftTitle||m.aName||m.A||m.left?.title||m.left?.name||'LEFT',
          rightTitle:m.rightTitle||m.bName||m.B||m.right?.title||m.right?.name||'RIGHT',
          leftImg:absPath(m.leftImg||m.left?.image||m.left?.img||''),
          rightImg:absPath(m.rightImg||m.right?.image||m.right?.img||'')
        }));
        acceptMatches(norm,used,true);
        return;
      }
    }
    try{
      for(const url of ['/api/battleground/matchups','/api/bg/matchups']){
        const r=await fetch(url,{cache:'no-store'});
        if(r.ok){
          const arr=await r.json();
          if(Array.isArray(arr)&&arr.length){
            used='api:'+url;
            acceptMatches(arr,used,false);
            return;
          }
        }
      }
    }catch{}
    el('#dbgImport').textContent='none';
    toast('No matchups found (Admin/local/API empty)',false);
  }

  function acceptMatches(arr,used,alreadyNorm){
    const matches=arr.map((mx,i)=> alreadyNorm ? mx : ({
      id: mx.id||mx.matchId||('M'+i),
      leftId: mx.leftId||mx.AId||mx.aId||null,
      rightId: mx.rightId||mx.BId||mx.bId||null,
      leftTitle: mx.leftTitle||mx.aName||mx.A||'LEFT',
      rightTitle: mx.rightTitle||mx.bName||mx.B||'RIGHT',
      leftImg: absPath(mx.leftImg||mx.aImage||mx.imgA||mx.imageA||''),
      rightImg: absPath(mx.rightImg||mx.bImage||mx.imgB||mx.imageB||'')
    }));
    const builder=sget(K_BG_BUILDER)||{games:[],matches:[]};
    builder.matches=matches; sset(K_BG_BUILDER,builder);
    el('#dbgImport').textContent = used+' ('+matches.length+')';
    toast('Imported '+matches.length+' matchups',true);
  }

  function buildH2H(){
    const builder=sget(K_BG_BUILDER);
    if(!builder || !Array.isArray(builder.matches) || !builder.matches.length){ toast('No matches to build',false); return; }

    // Build a map of games to backfill images/providers if match lacks them
    const gMap = new Map((builder.games||[]).map(g=>[g.id,g]));
    state.sections.battleground.h2h = builder.matches.map(mx=>{
      const GL=gMap.get(mx.leftId)||{}, GR=gMap.get(mx.rightId)||{};
      const leftImg  = absPath(mx.leftImg || GL.imageUrl || GL.image || '');
      const rightImg = absPath(mx.rightImg|| GR.imageUrl || GR.image || '');
      return {
        matchId: mx.id,
        leftId: mx.leftId||null, rightId: mx.rightId||null,
        leftTitle: mx.leftTitle||GL.title||'LEFT',
        rightTitle: mx.rightTitle||GR.title||'RIGHT',
        leftImg, rightImg,
        leftProv: GL.provider||'', rightProv: GR.provider||'',
        leftOdds: 1.84, rightOdds: 1.84
      };
    });
    save(); paintH2H(); toast('H2H built');
  }

  // save/publish
  const save = ()=>sset(K_UNIFIED,state);
  function publish(){
    state.lastUpdated=Date.now(); save();
    const d=new Date(state.lastUpdated); el('#stamp').textContent='Last publish @ '+d.toLocaleString();
    toast('Published to players');
  }

  // wire
  el('#btnSave')?.addEventListener('click',()=>{ save(); toast('Saved'); });
  el('#btnPublish')?.addEventListener('click',publish);
  el('#btnOpenAll')?.addEventListener('click',()=>{ state.status='open'; save(); syncToggles(); });
  el('#btnLockAll')?.addEventListener('click',()=>{ state.status='locked'; save(); syncToggles(); });
  el('#btnDelete')?.addEventListener('click',()=>{ if(confirm('Delete ALL markets?')){ state={status:'open',lastUpdated:0,sections:{battleground:{enabled:false,h2h:[],overall:[]},bonus:{enabled:false,overall:[]},pvp:{enabled:false,overall:[]}}}; save(); syncToggles(); paintAll(); } });

  el('#bgAddOU')?.addEventListener('click',()=>addOU(state.sections.battleground));
  el('#bgAddMR')?.addEventListener('click',()=>addMR(state.sections.battleground));
  el('#bgAddYN')?.addEventListener('click',()=>addYN(state.sections.battleground));
  el('#bgAddCU')?.addEventListener('click',()=>addCU(state.sections.battleground));
  el('#bgAddCS')?.addEventListener('click',()=>addCS(state.sections.battleground));
  el('#bgImport')?.addEventListener('click',importBG);
  el('#bgBuild') ?.addEventListener('click',buildH2H);

  el('#boSettle')?.addEventListener('click',autoSettleFromBH);
  el('#pvAddOU')?.addEventListener('click',()=>addOU(state.sections.pvp));
  el('#pvAddMR')?.addEventListener('click',()=>addMR(state.sections.pvp));
  el('#pvAddYN')?.addEventListener('click',()=>addYN(state.sections.pvp));
  el('#pvAddCU')?.addEventListener('click',()=>addCU(state.sections.pvp));

  // boot
  normalizeBGBuilder();       // NEW: fix stored image paths from BG Admin
  syncToggles(); paintAll();
  if(state.lastUpdated) el('#stamp').textContent='Last publish @ '+new Date(state.lastUpdated).toLocaleString();
})();
</script>
</body>
</html>
