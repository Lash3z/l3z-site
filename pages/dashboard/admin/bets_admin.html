<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bets Admin — Unified (Simple)</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#11161d;--ink:#e9f1ff;--line:rgba(0,255,255,.18);
    --accent:#16e1ff;--gold:#ffcc66;--red:#ff7a7a;--muted:#9fb1c7;
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial,sans-serif}
  h2,h3{margin:0 0 8px}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .btn{border:1px solid var(--line);background:#0e151b;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#20e0ff,#00b9e8);color:#00121b;border:0;font-weight:800}
  .btn.warn{background:#1a1010;border-color:#492626;color:#ffdfe1}
  .btn.danger{background:#220f0f;color:#ffcaca;border-color:#3b1717}
  .panel{background:linear-gradient(180deg,#0f141a,#0c1116);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:12px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="number"],input[type="text"],select,textarea{
    background:#0e141a;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px
  }
  .small{font-size:12px;color:var(--muted)}
  .list{max-height:480px;overflow:auto;border:1px dashed var(--line);border-radius:12px;padding:8px}
  .card{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:8px;background:#0e141a}
  .pill{padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0a1116;color:#9feaff;font-size:12px}
  .right{margin-left:auto}
  .soft{color:#9fb1c7}
  .odd{width:80px}
  .line{width:120px}
  .w100{width:100%}
  .title{font-weight:900;color:#ffdb8b}
  .good{color:#9ff5c9}
  .bad{color:#ffb5be}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .hint{padding:8px 10px;border-left:3px solid #224b55;background:#0d171c;border-radius:8px;color:#cfe8ff}
  details{border:1px solid var(--line);border-radius:14px;padding:8px;margin:12px 0;background:#0e1416}
  details>summary{cursor:pointer;list-style:none;font-weight:900;color:#ffdb8b}
  details>summary::-webkit-details-marker{display:none}
</style>
</head>
<body>
<div class="wrap">

  <!-- Global actions -->
  <div class="bar">
    <button class="btn primary" id="btnPublish">Publish to Players</button>
    <button class="btn" id="btnOpenAll">Open All</button>
    <button class="btn warn" id="btnLockAll">Lock All</button>
    <button class="btn danger" id="btnDeleteAll">Delete All</button>
    <span class="right small">Last publish: <span id="lastPub" class="soft">never</span></span>
  </div>

  <!-- ========= Battleground ========= -->
  <details open>
    <summary>Battleground <span class="pill" id="bgState">OPEN</span></summary>
    <div class="panel" style="margin-top:8px">

      <div class="bar">
        <button class="btn" id="bgRefresh">Refresh from Builder</button>
        <button class="btn" id="bgBuild">Build/Refresh H2H</button>
        <button class="btn warn" id="bgToggle">Toggle OPEN/LOCKED</button>
      </div>

      <div class="card" style="flex-direction:column;align-items:stretch">
        <div class="row" style="justify-content:space-between">
          <div class="title">Matchups & Odds</div>
          <div class="small">Source: <code>bg:admin:matches</code> • Total: <span id="bgMCount">0</span></div>
        </div>
        <div id="bgMatches" class="list"></div>
        <div class="hint">Set **odds only**. Scores are read from the builder and the **winner is computed automatically**.</div>
      </div>

      <div class="hr"></div>

      <h3>Overall Markets</h3>
      <div class="hint" id="bgOUHint" style="display:none"></div>

      <div class="card">
        <div class="title" style="min-width:140px">OVER / UNDER</div>
        <label>Line <input id="bgOuLine" type="number" step="0.5" class="line"/></label>
        <label class="row">Over odds <input id="bgOuOver" type="number" step="0.01" class="odd"/></label>
        <label class="row">Under odds <input id="bgOuUnder" type="number" step="0.01" class="odd"/></label>
        <select id="bgOuStatus"><option value="open">OPEN</option><option value="locked">LOCKED</option></select>
        <button class="btn right" id="bgSaveOU">Save</button>
      </div>

      <div class="card" style="flex-direction:column;align-items:stretch">
        <div class="row" style="justify-content:space-between">
          <div class="title">Total Games Played — Multi Range</div>
          <div class="row">
            <label class="row">Status
              <select id="bgMrStatus"><option value="open">OPEN</option><option value="locked">LOCKED</option></select>
            </label>
            <button class="btn" id="bgAutoRanges">Auto ranges</button>
            <button class="btn" id="bgSaveMR">Save</button>
          </div>
        </div>
        <div id="bgRanges" class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:10px"></div>
        <div class="small soft" style="margin-top:8px">“Auto ranges” proposes four buckets around the expected total games.</div>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <div class="card">
          <div class="title">Expected per match</div>
          <div class="small soft">Driving OU + ranges.</div>
          <div class="row" style="margin-top:6px">
            <input id="bgPerMatch" type="number" class="line" step="1" value="1"/>
          </div>
        </div>
        <div class="card">
          <div class="title">Computed totals</div>
          <div class="small">Matchups: <span id="bgCM" class="good">0</span></div>
          <div class="small">Expected total games: <span id="bgCT" class="good">0</span></div>
        </div>
        <div class="card">
          <div class="title">Section state</div>
          <div class="small">Battleground: <span id="bgSecState" class="soft">OPEN</span></div>
        </div>
      </div>

    </div>
  </details>

  <!-- ========= Bonus Hunt ========= -->
  <details>
    <summary>Bonus Hunt <span class="pill" id="bhState">OPEN</span></summary>
    <div class="panel" style="margin-top:8px">
      <div class="bar">
        <button class="btn" id="bhSeed6">Enable 6 fixed markets</button>
        <button class="btn" id="bhSaveOdds">Save fixed odds</button>
        <button class="btn warn" id="bhToggle">Toggle OPEN/LOCKED</button>
      </div>

      <div class="card" style="flex-direction:column;align-items:stretch">
        <div class="title">Fixed markets (TEXT_GUESS)</div>
        <div class="small soft">Players type or click a slot name. Odds apply per-market.</div>
        <div id="bhFixedWrap" class="grid" style="grid-template-columns:1fr 1fr;margin-top:8px"></div>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div class="card" style="flex-direction:column;align-items:stretch">
          <div class="title">Import slot list → Draft</div>
          <div class="small soft">Paste lines like: <i>Slot Name | Provider</i></div>
          <textarea id="bhPaste" placeholder="Big Bass Bonanza | Pragmatic&#10;Crystal Robot | Hacksaw" style="width:100%;min-height:140px;resize:vertical"></textarea>
          <div class="row">
            <button class="btn" id="bhParse">Parse to Draft</button>
            <span class="small">Draft count: <span id="bhDraftCount">0</span></span>
          </div>
        </div>
        <div class="card" style="flex-direction:column;align-items:stretch">
          <div class="title">Draft → Live</div>
          <div class="small soft">Publish for player chips/search on the Bonus Hunt tab.</div>
          <div class="row" style="margin-top:6px">
            <button class="btn primary" id="bhPublishList">Publish Draft to Live</button>
            <span class="small">Live count: <span id="bhLiveCount">0</span></span>
          </div>
          <div class="hint" style="margin-top:8px">Player page reads <code>bh:live</code> (or falls back to <code>bh:draft</code>).</div>
        </div>
      </div>
    </div>
  </details>

  <!-- ========= PVP ========= -->
  <details>
    <summary>PVP <span class="pill" id="pvpState">OPEN</span></summary>
    <div class="panel" style="margin-top:8px">
      <div class="bar">
        <button class="btn" id="pvpSeedFighters">Seed Fighters</button>
        <button class="btn" id="pvpBuild">Build/Refresh H2H</button>
        <button class="btn warn" id="pvpToggle">Toggle OPEN/LOCKED</button>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <h3>Fighters</h3>
          <div class="small soft">Click two → “Add Match”.</div>
          <div class="row" style="margin:6px 0 10px">
            <input id="pvpNew" class="w100" placeholder="Add fighter name"/>
            <button class="btn" id="pvpAddF">Add</button>
            <button class="btn" id="pvpAddPair">+ Add Match (pair selected)</button>
          </div>
          <div id="pvpFList" class="list"></div>
        </div>
        <div>
          <div class="row" style="justify-content:space-between">
            <h3>Matchups</h3>
            <div class="small">Total: <span id="pvpMCount">0</span></div>
          </div>
          <div id="pvpMatches" class="list"></div>
        </div>
      </div>
    </div>
  </details>

</div>

<script>
(function(){
  "use strict";

  // ===== storage keys =====
  const K_UNIFIED="sb:markets:unified";
  const K_LAST_PUB="sb:lastPublishTs";

  // battleground admin (builder) store — single source of truth for H2H + scores
  const K_BG_MATCHES="bg:admin:matches";

  // bonus hunt lists
  const K_BH_DRAFT="bh:draft";
  const K_BH_LIVE="bh:live";

  // pvp scratch
  const K_PVP_F="pvp:fighters";
  const K_PVP_MATCHES="pvp:admin:matches";
  const K_PVP_SELECTED="pvp:selected";

  // helpers
  const $=(q,r)=> (r||document).querySelector(q);
  const $all=(q,r)=> Array.from((r||document).querySelectorAll(q));
  const sget=k=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):null;}catch{return null;}};
  const sset=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const clamp2=x=> Math.max(1,Math.round(Number(x||1.84)*100)/100);

  let unified = sget(K_UNIFIED) || {
    sections:{
      battleground:{status:"open",overall:[],h2h:[]},
      bonus:{status:"open",overall:[]},
      pvp:{status:"open",overall:[],h2h:[]}
    }
  };

  // GLOBAL
  function paintGlobal(){
    $("#lastPub").textContent = sget(K_LAST_PUB)? new Date(sget(K_LAST_PUB)).toLocaleString() : "never";
  }
  $("#btnPublish").addEventListener("click", ()=>{
    // always rebuild H2H from builder matches before publishing
    buildBattlegroundH2H();
    sset(K_UNIFIED,unified);
    sset(K_LAST_PUB,Date.now());
    paintGlobal();
    alert("Published to players.");
  });
  $("#btnOpenAll").addEventListener("click", ()=>{
    Object.values(unified.sections).forEach(sec=>{
      (sec.overall||[]).forEach(m=> m.status="open");
      (sec.h2h||[]).forEach(m=> m.status="open");
      sec.status="open";
    });
    sset(K_UNIFIED,unified); paintAllStates();
  });
  $("#btnLockAll").addEventListener("click", ()=>{
    Object.values(unified.sections).forEach(sec=>{
      (sec.overall||[]).forEach(m=> m.status="locked");
      (sec.h2h||[]).forEach(m=> m.status="locked");
      sec.status="locked";
    });
    sset(K_UNIFIED,unified); paintAllStates();
  });
  $("#btnDeleteAll").addEventListener("click", ()=>{
    if(!confirm("Delete ALL markets across all sections?")) return;
    Object.values(unified.sections).forEach(sec=>{sec.overall=[];sec.h2h=[];});
    sset(K_UNIFIED,unified); paintAllStates();
  });
  function paintAllStates(){
    const bg=unified.sections.battleground||{};
    $("#bgState").textContent=(bg.status||"open").toUpperCase();
    $("#bgSecState").textContent=(bg.status||"open").toUpperCase();
    $("#bhState").textContent=(unified.sections.bonus.status||"open").toUpperCase();
    $("#pvpState").textContent=(unified.sections.pvp.status||"open").toUpperCase();
  }

  // ===== Battleground (auto from builder)
  const bg=()=> (unified.sections.battleground ||= {status:"open",overall:[],h2h:[]});
  const bgMatches=()=> sget(K_BG_MATCHES)||[];

  function winnerFrom(m){
    const a = Number(m.scoreA); const b = Number(m.scoreB);
    if(Number.isFinite(a) && Number.isFinite(b)){
      if(a>b) return "A";
      if(b>a) return "B";
      return "DRAW";
    }
    return null;
  }

  function paintBGMatches(){
    const ms = bgMatches();
    const box=$("#bgMatches"); box.innerHTML="";
    $("#bgMCount").textContent = ms.length;

    ms.forEach((m,i)=>{
      const w = winnerFrom(m);
      const row=document.createElement("div"); row.className="card"; row.style.flexDirection="column";
      row.innerHTML = `
        <div class="row" style="justify-content:space-between;width:100%">
          <div class="row" style="gap:8px">
            <div class="pill">${i+1}</div>
            <div><strong>${m.a}</strong> <span class="soft">vs</span> <strong>${m.b}</strong></div>
          </div>
          <div class="row">
            <div class="pill">Score: ${Number(m.scoreA ?? 0)}–${Number(m.scoreB ?? 0)}</div>
            <div class="pill ${w==="A"||w==="B"?"good":""}">${w? ("Winner: "+(w==="A"?m.a:w==="B"?m.b:"DRAW")) : "Winner: —"}</div>
          </div>
        </div>
        <div class="row" style="gap:12px;margin-top:6px">
          <label>A odds <input data-a class="odd" type="number" step="0.01" value="${m.oddsA??1.84}"/></label>
          <label>B odds <input data-b class="odd" type="number" step="0.01" value="${m.oddsB??1.84}"/></label>
          <button class="btn" data-save>Save odds</button>
        </div>`;
      row.querySelector("[data-save]").addEventListener("click",()=>{
        const cur = bgMatches();
        cur[i].oddsA = clamp2(row.querySelector("[data-a]").value);
        cur[i].oddsB = clamp2(row.querySelector("[data-b]").value);
        sset(K_BG_MATCHES, cur);
        alert("Saved.");
      });
      box.appendChild(row);
    });

    recalcExpectations();
  }

  function recalcExpectations(){
    const per=Number($("#bgPerMatch").value||1);
    const ms=bgMatches().length;
    const total=ms*per;
    $("#bgCM").textContent=ms;
    $("#bgCT").textContent=total;
    const line=$("#bgOuLine");
    if(!line.value) line.value = per===1 ? (ms-0.5) : (total-0.5);
    const hint=$("#bgOUHint"); hint.style.display=""; hint.textContent = `Expected total = ${ms} × ${per} = ${total}. Proposed OU line ${line.value}.`;
  }

  function propRanges(){
    const per=Number($("#bgPerMatch").value||1), ms=bgMatches().length, base=ms*per;
    return [
      {label:`${Math.max(0,Math.floor(base-2))}–${Math.floor(base-1)}.5`,odds:1.70},
      {label:`${Math.floor(base-1)}–${Math.floor(base)}.5`,odds:1.40},
      {label:`${Math.floor(base)}–${Math.floor(base+1)}.5`,odds:2.25},
      {label:`${Math.floor(base+1)}+`,odds:3.14},
    ];
  }

  function paintRangeEditor(ranges){
    const wrap=$("#bgRanges"); wrap.innerHTML="";
    ranges.forEach(r=>{
      const row=document.createElement("div"); row.className="card";
      row.innerHTML=`<label>Range <input class="line" type="text" value="${r.label}"/></label>
                     <label>Odds <input class="odd" type="number" step="0.01" value="${r.odds||1.84}"/></label>
                     <button class="btn danger" data-x>✕</button>`;
      row.querySelector("[data-x]").addEventListener("click",()=>row.remove());
      wrap.appendChild(row);
    });
    const add=document.createElement("button"); add.className="btn"; add.textContent="+ Add Line";
    add.addEventListener("click",()=>{
      const r=document.createElement("div"); r.className="card";
      r.innerHTML=`<label>Range <input class="line" type="text" placeholder="26–27.5"/></label>
                   <label>Odds <input class="odd" type="number" step="0.01" value="1.84"/></label>
                   <button class="btn danger" data-x>✕</button>`;
      r.querySelector("[data-x]").addEventListener("click",()=>r.remove());
      $("#bgRanges").appendChild(r);
    });
    wrap.appendChild(add);
  }

  function loadOverallToUI(){
    const sec=bg();
    const ou=(sec.overall||[]).find(m=>m.type==="OVER_UNDER");
    if(ou){
      $("#bgOuLine").value=ou.line??"";
      $("#bgOuOver").value=ou.selections?.[0]?.odds??1.84;
      $("#bgOuUnder").value=ou.selections?.[1]?.odds??1.84;
      $("#bgOuStatus").value=ou.status||"open";
    }
    const mr=(sec.overall||[]).find(m=>m.type==="MULTI_RANGE");
    if(mr){
      $("#bgMrStatus").value=mr.status||"open";
      const ranges=(mr.selections||[]).map(s=>({label:s.label||s.range||"",odds:s.odds||1.84}));
      if(ranges.length) paintRangeEditor(ranges);
    }
  }

  function saveOU(){
    const sec=bg(); const idx=(sec.overall||[]).findIndex(m=>m.type==="OVER_UNDER");
    const line=Number($("#bgOuLine").value||0);
    const m={id:"OU_BG",type:"OVER_UNDER",label:"Over / Under",status:$("#bgOuStatus").value,line,
      selections:[{label:`Over ${line}`,odds:clamp2($("#bgOuOver").value)},{label:`Under ${line}`,odds:clamp2($("#bgOuUnder").value)}]};
    if(idx<0) (sec.overall||=[]).push(m); else sec.overall[idx]=m; sset(K_UNIFIED,unified);
  }
  function saveMR(){
    const sec=bg(); const idx=(sec.overall||[]).findIndex(m=>m.type==="MULTI_RANGE"); const sels=[];
    $all("#bgRanges .card").forEach(row=>{
      const range=row.querySelector("input[type=text]").value.trim();
      const odds=clamp2(row.querySelector("input[type=number]").value);
      if(range) sels.push({label:range,odds});
    });
    if(!sels.length) return alert("Add at least one range.");
    const m={id:"MR_BG",type:"MULTI_RANGE",label:"Total Games Played",status:$("#bgMrStatus").value,selections:sels};
    if(idx<0) (sec.overall||=[]).push(m); else sec.overall[idx]=m; sset(K_UNIFIED,unified);
  }

  // Build H2H for players directly from builder matches + stored odds
  function buildBattlegroundH2H(){
    const ms = bgMatches();
    const h2h = ms.map((m,i)=>({
      id:`BG_H2H_${i+1}`,
      type:"CUSTOM",
      label:`${m.a} vs ${m.b}`,
      status:(bg().status||"open"),
      selections:[
        {label:m.a,odds:clamp2(m.oddsA||1.84)},
        {label:m.b,odds:clamp2(m.oddsB||1.84)}
      ],
      // optional live/result metadata for dashboards
      live:{a:Number(m.scoreA||0), b:Number(m.scoreB||0)},
      winner: winnerFrom(m) // "A" | "B" | "DRAW" | null
    }));
    bg().h2h = h2h;
    sset(K_UNIFIED, unified);
  }

  // events
  $("#bgRefresh").addEventListener("click", ()=> paintBGMatches());
  $("#bgBuild").addEventListener("click", ()=>{ buildBattlegroundH2H(); alert("Battleground H2H built from builder matches."); });
  $("#bgPerMatch").addEventListener("input",recalcExpectations);
  $("#bgAutoRanges").addEventListener("click",()=>paintRangeEditor(propRanges()));
  $("#bgSaveOU").addEventListener("click",saveOU);
  $("#bgSaveMR").addEventListener("click",saveMR);
  $("#bgToggle").addEventListener("click",()=>{ bg().status=bg().status==="open"?"locked":"open"; sset(K_UNIFIED,unified); paintAllStates(); });

  // keep in sync if builder updates scores in another tab
  window.addEventListener("storage",(e)=>{
    if(e.key===K_BG_MATCHES){ paintBGMatches(); buildBattlegroundH2H(); }
  });

  // init BG
  $("#bgState").textContent=(bg().status||"open").toUpperCase();
  $("#bgSecState").textContent=(bg().status||"open").toUpperCase();
  paintBGMatches(); loadOverallToUI(); if(!$("#bgRanges").children.length) paintRangeEditor(propRanges()); recalcExpectations();

  // ===== Bonus Hunt (unchanged)
  const bh=()=> (unified.sections.bonus ||= {status:"open",overall:[]});
  function bhFixedDefs(){ return [
    {id:"BH_FIRST", label:"First Bonus Triggered", fixedOdds:1.84},
    {id:"BH_LAST",  label:"Last Bonus Triggered",  fixedOdds:1.84},
    {id:"BH_BIG",   label:"Biggest Win (slot)",    fixedOdds:2.25},
    {id:"BH_SMALL", label:"Smallest Win (slot)",   fixedOdds:3.10},
    {id:"BH_MOST",  label:"Most Bonuses (slot)",   fixedOdds:2.50},
    {id:"BH_HOT",   label:"Hot Slot (stream pick)",fixedOdds:2.00},
  ];}
  function bhSeedSix(){
    const sec=bh(); const ds=bhFixedDefs();
    ds.forEach(d=>{
      const i=(sec.overall||[]).findIndex(m=>m.id===d.id);
      const m={id:d.id,type:"TEXT_GUESS",label:d.label,status:"open",fixedOdds:d.fixedOdds};
      if(i<0) sec.overall.push(m); else sec.overall[i]=m;
    });
    sset(K_UNIFIED,unified); bhPaintFixed();
  }
  function bhPaintFixed(){
    const wrap=$("#bhFixedWrap"); wrap.innerHTML="";
    const sec=bh(); const ds=bhFixedDefs();
    ds.forEach(d=>{
      const m=(sec.overall||[]).find(x=>x.id===d.id) || {fixedOdds:d.fixedOdds,status:"open"};
      const row=document.createElement("div"); row.className="card";
      row.innerHTML=`<div class="w100">${d.label}</div>
        <label>Odds <input class="odd" data-id="${d.id}" type="number" step="0.01" value="${m.fixedOdds??d.fixedOdds}"/></label>
        <select data-s="${d.id}"><option value="open"${(m.status||"open")==="open"?" selected":""}>OPEN</option><option value="locked"${(m.status||"open")==="locked"?" selected":""}>LOCKED</option></select>`;
      wrap.appendChild(row);
    });
  }
  function bhSaveOdds(){
    const sec=bh();
    bhFixedDefs().forEach(d=>{
      const i=(sec.overall||[]).findIndex(m=>m.id===d.id);
      if(i>=0){
        const odd=clamp2($(`[data-id="${d.id}"]`).value); const st=$(`[data-s="${d.id}"]`).value;
        sec.overall[i].fixedOdds=odd; sec.overall[i].status=st;
      }
    });
    sset(K_UNIFIED,unified);
  }
  function bhParsePaste(){
    const txt=$("#bhPaste").value||""; const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const entries=[]; lines.forEach(line=>{ const m=line.split("|"); const name=(m[0]||"").trim(); const provider=(m[1]||"").trim(); if(name) entries.push({slot:name,provider}); });
    sset(K_BH_DRAFT,{entries,ts:Date.now()}); $("#bhDraftCount").textContent=entries.length;
  }
  function bhRefreshCounts(){
    $("#bhDraftCount").textContent = (sget(K_BH_DRAFT)?.entries||[]).length;
    $("#bhLiveCount").textContent  = (sget(K_BH_LIVE)?.entries||[]).length;
  }
  $("#bhSeed6").addEventListener("click",()=>{ bhSeedSix(); alert("Six fixed Bonus Hunt markets enabled."); });
  $("#bhSaveOdds").addEventListener("click",bhSaveOdds);
  $("#bhToggle").addEventListener("click",()=>{ bh().status=bh().status==="open"?"locked":"open"; sset(K_UNIFIED,unified); paintAllStates(); });
  $("#bhParse").addEventListener("click",bhParsePaste);
  $("#bhPublishList").addEventListener("click",()=>{ const d=sget(K_BH_DRAFT)||{entries:[]}; sset(K_BH_LIVE,d); bhRefreshCounts(); alert("Published slot list to Live."); });
  $("#bhState").textContent=(bh().status||"open").toUpperCase(); bhPaintFixed(); bhRefreshCounts();

  // ===== PVP (unchanged from your last build)
  const pvp=()=> (unified.sections.pvp ||= {status:"open",overall:[],h2h:[]});
  const pvpF=()=> sget(K_PVP_F)||[];
  const pvpSel=()=> new Set(sget(K_PVP_SELECTED)||[]);
  const pvpMatches=()=> sget(K_PVP_MATCHES)||[];
  function pvpPaintF(){
    const list=$("#pvpFList"); list.innerHTML=""; const sel=pvpSel();
    pvpF().forEach(n=>{
      const row=document.createElement("div"); row.className="card"; row.style.cursor="pointer";
      const picked=sel.has(n);
      row.innerHTML=`<div class="w100">${n}</div><div class="pill ${picked?"good":""}">${picked?"Selected":"Select"}</div>`;
      row.addEventListener("click",()=>{ const c=pvpSel(); if(c.has(n)) c.delete(n); else c.add(n); sset(K_PVP_SELECTED,[...c]); pvpPaintF(); });
      list.appendChild(row);
    });
  }
  function pvpPaintMatches(){
    const ms=pvpMatches(); $("#pvpMatches").innerHTML=""; $("#pvpMCount").textContent=ms.length;
    const list=$("#pvpMatches");
    ms.forEach((m,i)=>{
      const row=document.createElement("div"); row.className="card"; row.style.flexDirection="column";
      row.innerHTML=`<div class="row" style="justify-content:space-between;width:100%">
        <div class="row"><div class="pill">${i+1}</div><div><strong>${m.a}</strong> <span class="soft">vs</span> <strong>${m.b}</strong></div></div>
        <button class="btn danger" data-del>Delete</button></div>
        <div class="row" style="gap:12px;margin-top:6px">
          <label>A odds <input data-a class="odd" type="number" step="0.01" value="${m.oddsA??1.84}"/></label>
          <label>B odds <input data-b class="odd" type="number" step="0.01" value="${m.oddsB??1.84}"/></label>
          <button class="btn" data-save>Save</button></div>`;
      row.querySelector("[data-save]").addEventListener("click",()=>{ const cur=pvpMatches(); cur[i].oddsA=clamp2(row.querySelector("[data-a]").value); cur[i].oddsB=clamp2(row.querySelector("[data-b]").value); sset(K_PVP_MATCHES,cur); });
      row.querySelector("[data-del]").addEventListener("click",()=>{ const cur=pvpMatches(); cur.splice(i,1); sset(K_PVP_MATCHES,cur); pvpPaintMatches();});
      list.appendChild(row);
    });
  }
  $("#pvpSeedFighters").addEventListener("click",()=>{ if(!pvpF().length) sset(K_PVP_F,["LASH3Z","PLAYER_2","PLAYER_3","PLAYER_4"]); pvpPaintF(); });
  $("#pvpAddF").addEventListener("click",()=>{ const n=$("#pvpNew").value.trim(); if(!n) return; const cur=pvpF(); if(!cur.includes(n)) cur.push(n); sset(K_PVP_F,cur); $("#pvpNew").value=""; pvpPaintF(); });
  $("#pvpAddPair").addEventListener("click",()=>{ const sel=[...pvpSel()]; if(sel.length<2) return alert("Select two fighters."); const cur=pvpMatches(); cur.push({a:sel[0],b:sel[1],oddsA:1.84,oddsB:1.84}); sset(K_PVP_MATCHES,cur); sset(K_PVP_SELECTED,[]); pvpPaintF(); pvpPaintMatches(); });
  $("#pvpBuild").addEventListener("click",()=>{ const h2h=pvpMatches().map((m,i)=>({id:`PVP_${i+1}`,type:"CUSTOM",label:`${m.a} vs ${m.b}`,status:"open",selections:[{label:m.a,odds:clamp2(m.oddsA||1.84)},{label:m.b,odds:clamp2(m.oddsB||1.84)}]})); pvp().h2h=h2h; sset(K_UNIFIED,unified); alert("PVP H2H built."); });
  $("#pvpToggle").addEventListener("click",()=>{ pvp().status=pvp().status==="open"?"locked":"open"; sset(K_UNIFIED,unified); paintAllStates(); });
  $("#pvpState").textContent=(pvp().status||"open").toUpperCase(); pvpPaintF(); pvpPaintMatches();

  // finish
  paintGlobal(); paintAllStates();
})();
</script>
</body>
</html>
