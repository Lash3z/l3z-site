<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bets Admin — Unified (Simple)</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#11161d;--ink:#e9f1ff;--line:rgba(0,255,255,.18);
    --accent:#16e1ff;--gold:#ffcc66;--red:#ff7a7a;--muted:#9fb1c7;
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial,sans-serif}
  h2,h3{margin:0 0 8px}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .btn{border:1px solid var(--line);background:#0e151b;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#20e0ff,#00b9e8);color:#00121b;border:0;font-weight:800}
  .btn.warn{background:#1a1010;border-color:#492626;color:#ffdfe1}
  .btn.danger{background:#220f0f;color:#ffcaca;border-color:#3b1717}
  .panel{background:linear-gradient(180deg,#0f141a,#0c1116);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:12px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr 1fr}
  .row{display:flex;gap:8px;align-items:center}
  input[type="number"],input[type="text"],select,textarea{
    background:#0e141a;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px
  }
  .small{font-size:12px;color:var(--muted)}
  .list{max-height:420px;overflow:auto;border:1px dashed var(--line);border-radius:12px;padding:8px}
  .card{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:8px;background:#0e141a}
  .pill{padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0a1116;color:#9feaff;font-size:12px}
  .right{margin-left:auto}
  .soft{color:var(--muted)}
  .odd{width:70px}
  .line{width:100px}
  .range{width:120px}
  .w100{width:100%}
  .title{font-weight:900;color:#ffdb8b}
  .good{color:#9ff5c9}
  .bad{color:#ffb5be}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .hint{padding:8px 10px;border-left:3px solid #224b55;background:#0d171c;border-radius:8px;color:#cfe8ff}
</style>
</head>
<body>
<div class="wrap">

  <div class="bar">
    <button class="btn primary" id="btnPublish">Publish to Players</button>
    <button class="btn" id="btnOpenAll">Open All</button>
    <button class="btn warn" id="btnLockAll">Lock All</button>
    <button class="btn danger" id="btnDeleteAll">Delete All</button>
    <span class="right small">Last publish: <span id="lastPub" class="soft">never</span></span>
  </div>

  <div class="panel">
    <div class="bar">
      <span class="title">Battleground</span>
      <span class="pill" id="secStatus">OPEN</span>
      <button class="btn" id="btnImport">Import Matchups</button>
      <button class="btn" id="btnBuild">Build/Refresh H2H</button>
    </div>

    <div class="grid g2">
      <!-- Left: games library & selected -->
      <div>
        <h3>Games</h3>
        <div class="small soft">Select two → “Add Match” to create H2H.</div>
        <div class="row" style="margin:6px 0 10px">
          <input id="gameSearch" class="w100" placeholder="Search by name or provider"/>
          <button class="btn" id="addPair" title="Add Match from the two blue selected cards">+ Add Match (pair selected)</button>
        </div>
        <div id="gamesList" class="list"></div>
      </div>

      <!-- Right: current matchups & live -->
      <div>
        <div class="row" style="justify-content:space-between">
          <h3>Matchups & Live Scores</h3>
          <div class="small">Total: <span id="mCount">0</span></div>
        </div>
        <div id="matchList" class="list"></div>
      </div>
    </div>

    <div class="hr"></div>

    <h3>Overall Markets</h3>
    <div class="hint" id="ouHint" style="display:none"></div>

    <!-- Over/Under -->
    <div class="card">
      <div class="title" style="min-width:140px">OVER / UNDER</div>
      <label>Line <input id="ouLine" type="number" step="0.5" class="line"/></label>
      <label class="row">Over odds <input id="ouOver" type="number" step="0.01" class="odd"/></label>
      <label class="row">Under odds <input id="ouUnder" type="number" step="0.01" class="odd"/></label>
      <select id="ouStatus">
        <option value="open">OPEN</option>
        <option value="locked">LOCKED</option>
      </select>
      <button class="btn right" id="saveOU">Save</button>
    </div>

    <!-- Total Games Played (multi-range) -->
    <div class="card" style="flex-direction:column;align-items:stretch">
      <div class="row" style="justify-content:space-between">
        <div class="title">Total Games Played — Multi Range</div>
        <div class="row">
          <label class="row">Status
            <select id="mrStatus">
              <option value="open">OPEN</option>
              <option value="locked">LOCKED</option>
            </select>
          </label>
          <button class="btn" id="autoRanges">Auto ranges</button>
          <button class="btn" id="saveMR">Save</button>
        </div>
      </div>
      <div id="rangesWrap" class="grid g3" style="margin-top:10px"></div>
      <div class="small soft" style="margin-top:8px">Tip: “Auto ranges” proposes four buckets centered around the expected total games (see below). You can tweak numbers/odds before saving.</div>
    </div>

    <div class="hr"></div>
    <div class="grid g3">
      <div class="card">
        <div class="title">Expected per match</div>
        <div class="small soft">Used for Over/Under + multi-range proposals.</div>
        <div class="row" style="margin-top:6px">
          <input id="expectedPerMatch" type="number" class="line" step="1" value="1"/>
          <span class="small soft">e.g. 1 = each matchup counts as “one game”</span>
        </div>
      </div>
      <div class="card">
        <div class="title">Computed totals</div>
        <div class="small">Matchups: <span id="cMatches" class="good">0</span></div>
        <div class="small">Expected total games: <span id="cTotal" class="good">0</span></div>
      </div>
      <div class="card">
        <div class="title">Section state</div>
        <div class="small">Battleground: <span id="cSectionState" class="soft">OPEN</span></div>
        <button class="btn warn" id="btnToggleSection" style="margin-top:6px">Toggle OPEN/LOCKED</button>
      </div>
    </div>

  </div><!--/panel-->

</div><!--/wrap-->

<script>
(function(){
  "use strict";

  // ======= storage keys (match your player page) =======
  const K_UNIFIED = "sb:markets:unified";
  // admin scratchpads
  const K_BG_GAMES = "bg:games";                // [{name,provider,img}] – put your game library here (or import)
  const K_BG_MATCHES = "bg:admin:matches";      // [{a,b,oddsA,oddsB,scoreA,scoreB}]
  const K_BG_SELECTED = "bg:selected";          // [name,...] – for pairing convenience
  const K_LAST_PUB = "sb:lastPublishTs";

  // ======= helpers =======
  const $ = (q,r)=> (r||document).querySelector(q);
  const $all = (q,r)=> Array.from((r||document).querySelectorAll(q));
  const sget = k => { try{ const v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch{ return null; } };
  const sset = (k,v) => localStorage.setItem(k, JSON.stringify(v));
  const nowISO = ()=> new Date().toLocaleString();
  const clamp2 = x => Math.max(1, Math.round(x*100)/100);

  // ======= state =======
  let unified = sget(K_UNIFIED) || { sections:{ battleground:{ status:"open", overall:[], h2h:[] }, bonus:{status:"open",overall:[]}, pvp:{status:"open",overall:[]} } };
  const BG = ()=> (unified.sections.battleground ||= {status:"open", overall:[], h2h:[]});
  const games = ()=> sget(K_BG_GAMES) || [];           // should be pre-populated somewhere else (or import JSON once then sset)
  const matches = ()=> sget(K_BG_MATCHES) || [];
  const selected = ()=> sget(K_BG_SELECTED) || [];

  // ======= UI paint =======
  function paintHeader(){
    $("#secStatus").textContent = (BG().status||"open").toUpperCase();
    $("#cSectionState").textContent = (BG().status||"open").toUpperCase();
    $("#lastPub").textContent = sget(K_LAST_PUB) ? new Date(sget(K_LAST_PUB)).toLocaleString() : "never";
  }

  function paintGames(){
    const list = $("#gamesList");
    const q = ($("#gameSearch").value||"").toLowerCase();
    const sel = new Set(selected());
    list.innerHTML = "";
    games()
      .filter(g => !q || (g.name||"").toLowerCase().includes(q) || (g.provider||"").toLowerCase().includes(q))
      .forEach(g=>{
        const card = document.createElement("div");
        card.className = "card";
        card.style.cursor = "pointer";
        card.innerHTML = `<div class="pill">${(g.provider||"").toUpperCase()}</div>
                          <div class="w100">${g.name}</div>
                          <div class="pill ${sel.has(g.name)?"good":""}">${sel.has(g.name)?"Selected":"Select"}</div>`;
        card.addEventListener("click", ()=>{
          const cur = new Set(selected());
          if(cur.has(g.name)) cur.delete(g.name); else cur.add(g.name);
          sset(K_BG_SELECTED, [...cur]); paintGames();
        });
        list.appendChild(card);
      });
  }

  function paintMatches(){
    const list = $("#matchList");
    const ms = matches();
    list.innerHTML = "";
    $("#mCount").textContent = ms.length;

    ms.forEach((m,idx)=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.flexDirection = "column";
      card.innerHTML = `
        <div class="row" style="gap:14px;align-items:center;justify-content:space-between;width:100%">
          <div class="row" style="gap:10px;align-items:center">
            <div class="pill">${idx+1}</div>
            <div><strong>${m.a}</strong> <span class="soft">vs</span> <strong>${m.b}</strong></div>
          </div>
          <button class="btn danger" data-del>Delete</button>
        </div>
        <div class="row" style="gap:14px;flex-wrap:wrap;margin-top:8px">
          <label class="row">A odds <input class="odd" type="number" step="0.01" data-a value="${m.oddsA??1.84}"/></label>
          <label class="row">B odds <input class="odd" type="number" step="0.01" data-b value="${m.oddsB??1.84}"/></label>
          <label class="row">A score <input class="line" type="number" step="1" data-sa value="${m.scoreA??0}"/></label>
          <label class="row">B score <input class="line" type="number" step="1" data-sb value="${m.scoreB??0}"/></label>
          <button class="btn" data-save>Save</button>
        </div>`;
      card.querySelector("[data-del]").addEventListener("click", ()=>{
        const cur = matches(); cur.splice(idx,1); sset(K_BG_MATCHES, cur); paintMatches(); recalcComputed();
      });
      card.querySelector("[data-save]").addEventListener("click", ()=>{
        const cur = matches();
        const row = card;
        cur[idx].oddsA = clamp2(Number(row.querySelector("[data-a]").value||1.84));
        cur[idx].oddsB = clamp2(Number(row.querySelector("[data-b]").value||1.84));
        cur[idx].scoreA = Number(row.querySelector("[data-sa]").value||0);
        cur[idx].scoreB = Number(row.querySelector("[data-sb]").value||0);
        sset(K_BG_MATCHES, cur);
      });
      list.appendChild(card);
    });
  }

  // ======= computed totals & proposals =======
  function recalcComputed(){
    const ms = matches();
    const per = Number($("#expectedPerMatch").value||1);
    const expectedTotal = ms.length * per;
    $("#cMatches").textContent = ms.length;
    $("#cTotal").textContent = expectedTotal;

    // propose OU line if empty
    const ouLine = $("#ouLine");
    if(!ouLine.value) ouLine.value = per===1 ? (ms.length-0.5) : (expectedTotal - 0.5);

    // helpful text
    const txt = `Expected total = (matchups ${ms.length}) × (per-match ${per}) = ${expectedTotal}. 
    Over/Under line proposes ${ouLine.value}.`;
    const hint = $("#ouHint"); hint.style.display=""; hint.textContent = txt;
  }

  // build multi-range default 4 buckets around expected
  function proposeRanges(){
    const ms = matches();
    const per = Number($("#expectedPerMatch").value||1);
    const base = ms.length * per;
    // Build 4 windows around base
    const buckets = [
      {label:`${Math.max(0,Math.floor(base-2))}–${Math.floor(base-1)}.5`, odds:1.70},
      {label:`${Math.floor(base-1)}–${Math.floor(base)}.5`, odds:1.40},
      {label:`${Math.floor(base)}–${Math.floor(base+1)}.5`, odds:2.25},
      {label:`${Math.floor(base+1)}+`, odds:3.14},
    ];
    return buckets;
  }

  function paintRangeEditor(ranges){
    const wrap = $("#rangesWrap");
    wrap.innerHTML = "";
    ranges.forEach((r,idx)=>{
      const row = document.createElement("div");
      row.className = "card";
      row.innerHTML = `
        <label>Range <input class="range" type="text" value="${r.label}"/></label>
        <label>Odds <input class="odd" type="number" step="0.01" value="${r.odds||1.84}"/></label>
        <button class="btn danger" data-x>✕</button>`;
      row.querySelector("[data-x]").addEventListener("click", ()=>{ row.remove(); });
      wrap.appendChild(row);
    });
    // add row button
    const add = document.createElement("button");
    add.className = "btn"; add.textContent = "+ Add Line";
    add.addEventListener("click", ()=>{
      const r = document.createElement("div");
      r.className="card";
      r.innerHTML = `<label>Range <input class="range" type="text" placeholder="e.g. 26–27.5"/></label>
                     <label>Odds <input class="odd" type="number" step="0.01" value="1.84"/></label>
                     <button class="btn danger" data-x>✕</button>`;
      r.querySelector("[data-x]").addEventListener("click", ()=> r.remove());
      wrap.appendChild(r);
    });
    wrap.appendChild(add);
  }

  // ======= OVERALL MARKETS load/save =======
  function loadOverallToUI(){
    const sec = BG();
    const ou = (sec.overall||[]).find(m => m.type==="OVER_UNDER");
    if(ou){
      $("#ouLine").value = ou.line ?? "";
      const a = (ou.selections||[])[0]||{};
      const b = (ou.selections||[])[1]||{};
      $("#ouOver").value = a.odds ?? 1.84;
      $("#ouUnder").value = b.odds ?? 1.84;
      $("#ouStatus").value = (ou.status||"open");
    }
    const mr = (sec.overall||[]).find(m => m.type==="MULTI_RANGE");
    if(mr){
      $("#mrStatus").value = (mr.status||"open");
      const ranges = (mr.selections||[]).map(s => ({label:(s.label||s.range||""), odds:(s.odds||1.84)}));
      if(ranges.length) paintRangeEditor(ranges);
    }
  }

  function saveOU(){
    const sec = BG();
    const idx = (sec.overall||[]).findIndex(m=> m.type==="OVER_UNDER");
    const m = {
      id: "OU_BG",
      type: "OVER_UNDER",
      label: "Over / Under",
      status: $("#ouStatus").value,
      line: Number($("#ouLine").value||0),
      selections: [
        { label:"Over "+$("#ouLine").value, odds: clamp2(Number($("#ouOver").value||1.84)) },
        { label:"Under "+$("#ouLine").value, odds: clamp2(Number($("#ouUnder").value||1.84)) },
      ]
    };
    if(idx<0) (sec.overall ||= []).push(m); else sec.overall[idx] = m;
    sset(K_UNIFIED, unified);
  }

  function saveMR(){
    const sec = BG();
    const idx = (sec.overall||[]).findIndex(m=> m.type==="MULTI_RANGE");
    const sels = [];
    $all("#rangesWrap .card").forEach(row=>{
      const range = row.querySelector(".range")?.value?.trim();
      const odds = clamp2(Number(row.querySelector(".odd")?.value||1.84));
      if(range) sels.push({label:range, odds});
    });
    if(!sels.length){ alert("Add at least one range line"); return; }
    const m = {
      id:"MR_BG",
      type:"MULTI_RANGE",
      label:"Total Games Played",
      status: $("#mrStatus").value,
      selections: sels
    };
    if(idx<0) (sec.overall ||= []).push(m); else sec.overall[idx]=m;
    sset(K_UNIFIED, unified);
  }

  // ======= H2H build/refresh =======
  function buildH2HFromMatches(){
    const h2h = matches().map((m,i)=>({
      id: `H2H_${i+1}`,
      type: "CUSTOM",
      label: `${m.a} vs ${m.b}`,
      status: "open",
      selections: [
        { label: m.a, odds: clamp2(Number(m.oddsA||1.84)) },
        { label: m.b, odds: clamp2(Number(m.oddsB||1.84)) },
      ],
      live: { a:m.scoreA||0, b:m.scoreB||0 }
    }));
    BG().h2h = h2h;
    sset(K_UNIFIED, unified);
  }

  // ======= import helpers =======
  function quickImport() {
    // If you already have a game library stored in bg:games, this just refreshes the view.
    // If not, we seed with a few example rows so the UI works right away.
    if(!games().length){
      sset(K_BG_GAMES, [
        {name:"CRYSTAL ROBOT",provider:"HACKSAW"},
        {name:"DUEL AT DAWN",provider:"HACKSAW"},
        {name:"FIRE IN THE HOLE 3",provider:"NOLIMIT"},
        {name:"GATES 1000",provider:"PRAGMATIC"},
        {name:"FLIGHT MODE",provider:"NOLIMIT"},
        {name:"CLOUD PRINCESS",provider:"HACKSAW"},
        {name:"DUCK HUNTERS",provider:"NOLIMIT"},
        {name:"BRUTE FORCE",provider:"NOLIMIT"},
        {name:"BIG BASS BONANZA",provider:"PRAGMATIC"},
      ]);
    }
    paintGames();
  }

  function addPairFromSelected(){
    const sel = selected();
    if(sel.length<2){ alert("Select two games on the left first."); return; }
    const a = sel[0], b = sel[1];
    const cur = matches();
    cur.push({ a, b, oddsA:1.84, oddsB:1.84, scoreA:0, scoreB:0 });
    sset(K_BG_MATCHES, cur);
    sset(K_BG_SELECTED, []); // clear selection after pairing
    paintGames(); paintMatches(); recalcComputed();
  }

  // ======= publish / section toggles / bulk =======
  function publishToPlayers(){
    sset(K_UNIFIED, unified);
    sset(K_LAST_PUB, Date.now());
    $("#lastPub").textContent = new Date(sget(K_LAST_PUB)).toLocaleString();
    alert("Published to players.\n\nPlayer page reads `sb:markets:unified` which is now updated.");
  }

  function openAll(){
    const sec = BG();
    (sec.overall||[]).forEach(m=> m.status="open");
    (sec.h2h||[]).forEach(m=> m.status="open");
    sset(K_UNIFIED, unified);
    paintHeader();
  }
  function lockAll(){
    const sec = BG();
    (sec.overall||[]).forEach(m=> m.status="locked");
    (sec.h2h||[]).forEach(m=> m.status="locked");
    sset(K_UNIFIED, unified);
    paintHeader();
  }
  function delAll(){
    const sec = BG();
    sec.overall = [];
    sec.h2h = [];
    sset(K_UNIFIED, unified);
    loadOverallToUI(); paintMatches(); recalcComputed();
  }

  function toggleSection(){
    BG().status = (BG().status==="open")? "locked":"open";
    sset(K_UNIFIED, unified);
    paintHeader();
  }

  // ======= events =======
  $("#btnPublish").addEventListener("click", publishToPlayers);
  $("#btnOpenAll").addEventListener("click", openAll);
  $("#btnLockAll").addEventListener("click", lockAll);
  $("#btnDeleteAll").addEventListener("click", delAll);

  $("#btnImport").addEventListener("click", quickImport);
  $("#gameSearch").addEventListener("input", paintGames);
  $("#addPair").addEventListener("click", addPairFromSelected);
  $("#btnBuild").addEventListener("click", ()=>{ buildH2HFromMatches(); alert("H2H built from current matchups."); });

  $("#expectedPerMatch").addEventListener("input", recalcComputed);
  $("#autoRanges").addEventListener("click", ()=> paintRangeEditor(proposeRanges()));
  $("#saveOU").addEventListener("click", saveOU);
  $("#saveMR").addEventListener("click", saveMR);
  $("#btnToggleSection").addEventListener("click", toggleSection);

  // ======= init =======
  paintHeader();
  paintGames();
  paintMatches();
  loadOverallToUI();
  if(!$("#rangesWrap").children.length) paintRangeEditor(proposeRanges());
  recalcComputed();

})();
</script>
</body>
</html>
