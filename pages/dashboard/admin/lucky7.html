<!DOCTYPE html>
<html lang="en" data-admin="checking">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-store" />
<meta name="robots" content="noindex,nofollow">
<title>Lucky 7 — Admin (Submit → Wallet + Leaderboard)</title>
<style>
  :root{
    --bg:#0b0f10; --ink:#eaf7ff; --muted:#9cc; --teal:#00ffff; --accent:#ffb42d;
    --panel:#0f1416; --line:rgba(0,255,255,.14);
  }
  /* hide until admin check completes */
  html[data-admin="checking"] body{opacity:0;transition:opacity .12s ease}

  html,body{
    margin:0;
    background:#000 url("/assets/media/BG_page.png") center/cover fixed no-repeat; /* ensure this asset path exists */
    color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif
  }
  .topbar{max-width:820px;margin:14px auto 0;padding:0 16px;display:flex;align-items:center;justify-content:space-between}
  .miniLink{color:#cfe;text-decoration:none;font-size:13px}
  .btnMini{border:1px solid rgba(0,255,255,.25);background:#0f1c1f;color:#cfe;border-radius:10px;padding:6px 10px;cursor:pointer}

  .wrap{max-width:820px;margin:18px auto 28px;padding:0 16px}
  h1{margin:0 0 8px;color:var(--teal);text-shadow:0 0 12px #00ffff55}
  .sub{font-size:12px;color:var(--muted);margin-bottom:10px}
  .card{border:1px solid var(--line);border-radius:12px;background:#0e1416;padding:14px;margin:12px 0}

  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input{background:var(--panel);border:1px solid var(--line);color:var(--ink);padding:10px;border-radius:10px;width:100%;box-sizing:border-box}

  .row{display:flex;gap:12px;align-items:center;margin:10px 0;flex-wrap:wrap}
  .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--accent);color:#222}
  .btn.alt{background:#103036;border:1px solid var(--line);color:#cfe}
  .btn.danger{background:#61222a;color:#fff}
  .btn.ghost{background:#121a1d;border:1px solid rgba(255,255,255,.08);color:#d8f2ff}
  .btn[disabled]{opacity:.55;cursor:not-allowed}

  .award{display:flex;justify-content:space-between;align-items:center;background:#0c1316;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px 12px;margin:8px 0}
  .award .l{font-weight:700}
  .award .r{display:flex;gap:8px;align-items:center}
  .pill{padding:2px 8px;border-radius:999px;background:#22323a;border:1px solid rgba(0,255,255,.2);font-size:12px}
  .totalBox{display:flex;justify-content:space-between;align-items:center;background:#0b1619;border:1px dashed rgba(0,255,255,.25);border-radius:12px;padding:12px;margin-top:10px}
  .log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:12px;background:#0b0f10;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;max-height:180px;overflow:auto}

  .status{font-size:12px;color:#9fd}
  .toast{position:fixed;right:16px;bottom:16px;background:#0f1416;border:1px solid var(--line);padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);display:none;z-index:9999}
</style>
</head>
<body>

<!-- ===== AdminGate (server cookie) ===== -->
<script>
(function(){
  "use strict";
  const H=document.documentElement;
  // it's already on the <html>, but set again in case this file is cached
  H.setAttribute("data-admin","checking");
  const ADMIN_CHECK="/api/admin/gate/check",
        ADMIN_LOGIN="/pages/dashboard/admin/admin_login.html",
        DASH="/index.html";
  function lock(){
    H.removeAttribute("data-admin");
    const s=document.createElement("style");
    s.textContent=".lockwrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f12;color:#eaf7ff;font-family:Segoe UI,system-ui,Arial,sans-serif}.lockcard{max-width:640px;margin:24px;padding:24px;border:1px solid rgba(0,255,255,.2);border-radius:14px;background:rgba(0,0,0,.75)}.lockcard h1{margin:0 0 10px;color:#cfe}.lockcard a{color:#7ad7ff;text-decoration:underline}";
    document.head.appendChild(s);
    document.body.innerHTML='<div class="lockwrap"><div class="lockcard"><h1>Administration Locked</h1><div>You must unlock admin on the <a href="'+ADMIN_LOGIN+'">Admin Login</a> first.</div><div style="margin-top:8px;opacity:.8">If you already logged in, your session may have expired.</div><div style="margin-top:14px"><a href="'+DASH+'">Back to Dashboard</a></div></div></div>';
  }
  fetch(ADMIN_CHECK,{credentials:"include",cache:"no-store"})
    .then(r=>r.ok?r.json():null)
    .then(j=>{ if(j&&j.admin){ H.removeAttribute("data-admin"); } else { lock(); } })
    .catch(lock);
})();
</script>
<!-- ===== /AdminGate ===== -->

<div class="topbar">
  <a class="miniLink" href="/index.html">← Back to Dashboard</a>
  <div class="status" id="syncStatus">Ready</div>
  <button class="btnMini" id="logoutBtn" type="button">Logout</button>
</div>

<div class="wrap">
  <h1>Lucky 7 — Admin</h1>
  <div class="sub">Enter a USERNAME (auto-CAPS). Click awards to add Lash3zBux. Press <b>Submit</b> to credit their wallet and update the leaderboard & profile.</div>

  <div class="card">
    <label for="username">Username</label>
    <input id="username" placeholder="TYPE USERNAME" autocomplete="off" />

    <div class="row" style="margin-top:14px">
      <span class="pill">Session total: <b id="totalPill">0</b> LBX</span>
      <button class="btn ghost" id="undoBtn" type="button">Undo Last</button>
      <button class="btn danger" id="resetBtn" type="button">Reset Session</button>
    </div>
  </div>

  <div class="card">
    <div class="award">
      <div class="l">1×7</div>
      <div class="r"><span class="pill">+7</span><button class="btn alt add" data-pts="7">Add</button></div>
    </div>
    <div class="award">
      <div class="l">2×7</div>
      <div class="r"><span class="pill">+14</span><button class="btn alt add" data-pts="14">Add</button></div>
    </div>
    <div class="award">
      <div class="l">3×7</div>
      <div class="r"><span class="pill">+25</span><button class="btn alt add" data-pts="25">Add</button></div>
    </div>
    <div class="award">
      <div class="l">4×7</div>
      <div class="r"><span class="pill">+100</span><button class="btn alt add" data-pts="100">Add</button></div>
    </div>
    <div class="award">
      <div class="l">Flush</div>
      <div class="r"><span class="pill">+21</span><button class="btn alt add" data-pts="21" data-tag="flush">Add</button></div>
    </div>
    <div class="award">
      <div class="l">Straight</div>
      <div class="r"><span class="pill">+21</span><button class="btn alt add" data-pts="21" data-tag="straight">Add</button></div>
    </div>
    <div class="award">
      <div class="l">Straight Flush</div>
      <div class="r"><span class="pill">+50</span><button class="btn alt add" data-pts="50" data-tag="sflush">Add</button></div>
    </div>

    <div class="totalBox">
      <div>Total Lash3zBux (this session): <b id="totalBox">0</b></div>
      <button class="btn primary" id="submitBtn" type="button">Submit → Wallet + Profile & Leaderboard</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="pill">Activity Log</div>
      <button class="btn ghost" id="copyLogBtn" type="button">Copy Log</button>
    </div>
    <div id="log" class="log">—</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== Keys (local fallbacks for instant UI) ===== */
var PROFILES_KEY = 'overall:profiles';      // leaderboard/profiles (local mirror)
var PROFILES_TS  = 'overall:profiles:ts';   // bump key for cross-tab refresh
var USER_PROFILE_PREFIX = 'user:profile:';  // quick per-user profile blob
var L7_FORM_KEY = 'lucky7:session';         // session WIP state

/* ===== Utilities ===== */
function $(s,root){ return (root||document).querySelector(s); }
function now(){ return new Date().toISOString().replace('T',' ').slice(0,19); }
function toCaps(s){ return (s||'').toString().toUpperCase(); }
function toast(msg){
  var t = $('#toast'); if(!t) return;
  t.textContent = msg; t.style.display='block';
  clearTimeout(toast._t); toast._t = setTimeout(function(){ t.style.display='none'; }, 2200);
}
function setStatus(txt){ var s=$('#syncStatus'); if(s) s.textContent=txt; }

/* ===== State ===== */
var session = loadSession();
var submitting = false;
render();

/* ===== Guard local fallbacks for production ===== */
var ALLOW_LOCAL_FALLBACK = /^(localhost|127\.0\.0\.1)$/i.test(location.hostname) || location.protocol === 'file:';

function loadSession(){
  try{
    var s = JSON.parse(localStorage.getItem(L7_FORM_KEY)||'{}');
    return {
      username: toCaps(s.username||''),
      total: Math.max(0, Number(s.total||0)),
      log: Array.isArray(s.log) ? s.log : []   // [{ts, pts, label, tag}]
    };
  }catch(e){ return { username:'', total:0, log:[] }; }
}
function saveSession(){ localStorage.setItem(L7_FORM_KEY, JSON.stringify(session)); }

/* ===== Auth logout ===== */
document.getElementById('logoutBtn').addEventListener('click', function(){
  try{ fetch('/admin/logout',{method:'POST',credentials:'include'}); }catch(_e){}
  location.replace('/admin/login.html');
});

/* ===== Render ===== */
function render(){
  var u = $('#username'); if(u){ u.value = session.username; }
  $('#totalPill').textContent = session.total.toFixed(0);
  $('#totalBox').textContent = session.total.toFixed(0);
  renderLog();
  document.querySelectorAll('.add').forEach(function(b){
    b.disabled = !session.username || submitting;
  });
  $('#submitBtn').disabled = submitting;
}
function renderLog(){
  var el = $('#log');
  if(!session.log.length){ el.textContent = '—'; return; }
  el.innerHTML = session.log.map(function(ev){
    var tag = ev.tag ? (' ['+ev.tag+']') : '';
    var label = ev.label || ('+'+ev.pts+' LBX');
    return '['+ev.ts+'] ' + label + tag;
  }).join('<br/>');
}

/* ===== Inputs ===== */
$('#username').addEventListener('input', function(e){
  session.username = toCaps(e.target.value||'');
  e.target.value = session.username;
  saveSession(); render();
});

/* ===== Award clicks ===== */
document.querySelectorAll('.add').forEach(function(btn){
  btn.addEventListener('click', function(){
    if(!session.username){ alert('Enter USERNAME first.'); return; }
    var pts = Number(btn.getAttribute('data-pts')||0);
    var tag = btn.getAttribute('data-tag')||'';
    session.total = Math.max(0, session.total + pts);
    var pill = btn.previousElementSibling;
    var label = (pill && pill.textContent || ('+'+pts)).trim() + ' LBX';
    session.log.push({ ts: now(), pts: pts, label: label, tag: tag });
    saveSession(); render();
  });
});

/* ===== Undo / Reset ===== */
$('#undoBtn').addEventListener('click', function(){
  if(!session.log.length) return;
  var last = session.log.pop();
  session.total = Math.max(0, session.total - Number(last.pts||0));
  saveSession(); render();
});
$('#resetBtn').addEventListener('click', function(){
  if(!confirm('Clear this session tally for '+(session.username||'USER')+' ?')) return;
  session.total = 0;
  session.log = [];
  saveSession(); render();
});

/* ===== Backend helpers (with guarded fallbacks) ===== */
async function apiPost(url, body){
  const token = document.querySelector('meta[name="csrf-token"]')?.content; // optional
  const res = await fetch(url, {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type':'application/json', ...(token?{'X-CSRF-Token':token}:{}) },
    body: JSON.stringify(body||{})
  });
  if(!res.ok) throw new Error((await res.text())||('HTTP '+res.status));
  return res.json().catch(()=>({ ok:true }));
}

async function creditWallet(user, amount, reason){
  try{
    setStatus('Crediting wallet…');
    await apiPost('/api/wallet/credit', { user, amount, reason: reason||'Lucky7 award' });
    setStatus('Wallet credited ✔');
    return true;
  }catch(err){
    if(!ALLOW_LOCAL_FALLBACK){
      setStatus('Wallet credit failed ✖');
      throw err;
    }
    // Local fallback for dev/offline
    try{
      var key='sb:wallet:'+user, w=JSON.parse(localStorage.getItem(key)||'{}');
      if(!w.balance){ w.balance=0; w.tx=[]; }
      w.balance = Number(w.balance||0) + Number(amount||0);
      (w.tx||[]).push({ ts:Date.now(), delta:+amount, reason:reason||'Lucky7 award', ref:'L7' });
      w.updatedAt = Date.now();
      localStorage.setItem(key, JSON.stringify(w));
      setStatus('Wallet credited (local fallback) ✔');
      return true;
    }catch(_e){}
    setStatus('Wallet credit failed ✖');
    throw err;
  }
}

async function upsertLeaderboard(user, delta, actions){
  try{
    setStatus('Updating leaderboard…');
    await apiPost('/api/leaderboard/upsert', {
      user, deltaTournamentPoints: Number(delta||0), source: 'Lucky7', actions: actions||[]
    });
    setStatus('Leaderboard updated ✔');
    return true;
  }catch(err){
    if(!ALLOW_LOCAL_FALLBACK){
      setStatus('Leaderboard update failed ✖');
      throw err;
    }
    // Local fallback for dev/offline
    try{
      var profiles = {};
      try{ profiles = JSON.parse(localStorage.getItem(PROFILES_KEY)||'{}'); }catch(_e){ profiles={}; }
      if(!profiles[user]){
        profiles[user] = { username:user, bonusHuntPoints:0, tournamentPoints:0, lbx:0, history:[] };
      }
      profiles[user].tournamentPoints = Number(profiles[user].tournamentPoints||0) + Number(delta||0);
      profiles[user].history.unshift({ ts: now(), mode:'Lucky7', added:Number(delta||0), actions: actions||[] });
      localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
      localStorage.setItem(PROFILES_TS, String(Date.now()));
      setStatus('Leaderboard updated (local fallback) ✔');
      return true;
    }catch(_e){}
    setStatus('Leaderboard update failed ✖');
    throw err;
  }
}

function updateLocalProfileBlob(user, delta){
  // Keep per-user quick profile current for the profile page
  var userKey = USER_PROFILE_PREFIX + user;
  var userDoc = {};
  try{ userDoc = JSON.parse(localStorage.getItem(userKey)||'{}'); }catch(_e){ userDoc={}; }
  userDoc.username = user;
  userDoc.tournamentPoints = Number(userDoc.tournamentPoints||0) + Number(delta||0);
  userDoc.updatedAt = now();
  userDoc.lastMode = 'Lucky7';
  localStorage.setItem(userKey, JSON.stringify(userDoc));
}

/* ===== Submit → Wallet + Leaderboard + Profile ===== */
$('#submitBtn').addEventListener('click', async function(){
  if(submitting) return;
  var user = toCaps(session.username||'');
  if(!user){ alert('Enter USERNAME.'); return; }
  if(session.total<=0){ alert('Nothing to submit yet. Add some awards first.'); return; }

  submitting = true; render();
  const amount = Number(session.total||0);

  try{
    await creditWallet(user, amount, 'Lucky7 award');
    await upsertLeaderboard(user, amount, session.log.slice());
    updateLocalProfileBlob(user, amount);

    toast('Submitted '+amount+' LBX to '+user+' ✅');
    // Clear only the tally/log; keep username for repeated awards to same player
    session.total = 0;
    session.log = [];
    saveSession(); render();
  }catch(err){
    console.error(err);
    toast('Submit had an error — check status line.');
  }finally{
    submitting = false; render();
  }
});

/* ===== Copy log (optional) ===== */
$('#copyLogBtn').addEventListener('click', function(){
  var text = session.log.map(function(ev){
    return '['+ev.ts+'] '+(ev.label||('+'+ev.pts))+(ev.tag?(' ['+ev.tag+']'):'');
  }).join('\n') || '—';
  navigator.clipboard?.writeText(text);
  toast('Log copied.');
});
</script>
</body>
</html>
