<!DOCTYPE html>
<html lang="en" data-admin="checking">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-store"/>
  <title>PVP — Admin</title>
  <link rel="icon" type="image/png" href="/assets/L3Z_logoMain.png">
  <style>
    :root{
      --bg:#060b0d; --panel:#0b1417; --ink:#eaf7ff; --muted:#9fd0d6;
      --line:rgba(0,255,255,.18); --teal:#00ffff; --gold:#ffb42d;
      --ok:#12d48a; --bad:#e25a6f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
    html[data-admin="checking"] body{opacity:0;transition:opacity .12s ease}
    h1{margin:16px 0 8px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
    h2{margin:0 0 10px;font-size:16px;color:var(--ink)}
    .wrap{max-width:1200px;margin:0 auto;padding:0 14px 40px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .panel{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
    .btn{border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#0f1720;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.ok{background:#103d30;border-color:#1fa37b}
    .btn.warn{background:#231b0f;border-color:#8c6926}
    .btn.bad{background:#2b1116;border-color:#7e2a3c}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .tbl{width:100%;border-collapse:separate;border-spacing:0}
    .tbl th,.tbl td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px;text-align:left;font-size:13px}
    .tbl th{color:var(--muted)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#081318;color:#bfe}
    .right{margin-left:auto}
    .hint{color:var(--muted);font-size:12px}
    .seed{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
    input{border:1px solid var(--line);border-radius:10px;background:#0e151a;color:#eaf7ff;padding:8px}
    select{border:1px solid var(--line);border-radius:10px;background:#0e151a;color:#eaf7ff;padding:8px}
    .tag{padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1e22;font-size:12px}
    .list{display:flex;flex-direction:column;gap:8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
    <h1>PVP — Admin</h1>
    <div class="row">
      <a class="btn" href="/index.html">← Back to Dashboard</a>
      <button id="adminLogout" class="btn">Log out</button>
    </div>
  </div>

  <!-- Player Entries -->
  <div class="panel">
    <div class="row" style="align-items:center">
      <h2 style="margin-right:10px">Player Entries</h2>
      <span id="entCount" class="badge">—</span>
      <span class="right"></span>
      <button id="entRefresh" class="btn ok">Refresh</button>
      <button id="takeApproved" class="btn">Take Approved → Seeding</button>
    </div>
    <div class="hint" style="margin:6px 0 10px">
      From <code>/api/pvp/entries</code>. Approve/reject; you can also delete an entry.
    </div>
    <div style="max-height:320px;overflow:auto;border:1px solid var(--line);border-radius:10px">
      <table class="tbl" id="entTbl">
        <thead>
          <tr><th>When</th><th>User</th><th>Side</th><th>Game</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody><tr><td colspan="6" class="hint">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Seeding -->
  <div class="panel">
    <div class="row" style="align-items:center">
      <h2 style="margin-right:10px">Seeding (EAST vs WEST)</h2>
      <span class="tag">Bracket size</span>
      <select id="sizeSel">
        <option value="16">16 (8 per side)</option>
        <option value="32">32 (16 per side)</option>
      </select>
      <button id="autoSeedBtn" class="btn ok">Auto-Seed & Build Bracket</button>
      <button id="clearSeedsBtn" class="btn warn">Clear Seeding</button>
      <span id="seedInfo" class="pill">—</span>
    </div>

    <div class="row">
      <!-- EAST -->
      <div style="flex:1 1 480px">
        <div class="row"><h3 style="margin:6px 0">EAST Seed</h3></div>
        <div class="row" style="gap:8px;margin-bottom:8px">
          <input id="eastUser" placeholder="USERNAME (caps)" style="flex:1 1 220px"/>
          <input id="eastGame" placeholder="GAME (optional)" style="flex:1 1 220px"/>
          <button id="eastAdd" class="btn">Add</button>
        </div>
        <div id="eastList" class="list"></div>
      </div>

      <!-- WEST -->
      <div style="flex:1 1 480px">
        <div class="row"><h3 style="margin:6px 0">WEST Seed</h3></div>
        <div class="row" style="gap:8px;margin-bottom:8px">
          <input id="westUser" placeholder="USERNAME (caps)" style="flex:1 1 220px"/>
          <input id="westGame" placeholder="GAME (optional)" style="flex:1 1 220px"/>
          <button id="westAdd" class="btn">Add</button>
        </div>
        <div id="westList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Publish -->
  <div class="panel">
    <div class="row" style="align-items:center">
      <h2 style="margin-right:10px">Publish Bracket → Live</h2>
      <span class="hint">
        Writes to <code>localStorage</code> (<code>pv:builder:pvp</code> and legacy <code>pvp:builder</code>)
        and to <code>/api/pvp/bracket</code>.
      </span>
      <span class="right"></span>
      <button id="publishBtn" class="btn ok">Publish</button>
      <span id="pubMsg" class="pill">Bracket built locally. Click Publish to push to server.</span>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";
  const $=(s,r=document)=>r.querySelector(s);
  const API="";

  // ---- Admin cookie gate ----
  const H=document.documentElement; H.setAttribute("data-admin","checking");
  function lock(){
    H.removeAttribute("data-admin");
    document.body.innerHTML='<div style="min-height:100vh;display:grid;place-items:center"><div class="panel"><h2>Administration Locked</h2><div>You must unlock admin on the <a href="/pages/dashboard/home/admin_login.html?redirect=%2Fpages%2Fdashboard%2Fadmin%2Fpvp_admin.html">Admin Login</a> first.</div><div style="margin-top:8px"><a class="btn" href="/index.html">Back to Dashboard</a></div></div></div>';
  }
  fetch(API+"/api/admin/gate/check",{credentials:"include",cache:"no-store"})
    .then(r=>r.ok?r.json():null)
    .then(j=>{ if(j&&j.admin){ H.removeAttribute("data-admin"); boot(); } else lock(); })
    .catch(lock);

  // ---------- State ----------
  let entries = [];
  let east = [];  // [{name, game}]
  let west = [];
  let size = 16;  // 16 or 32

  // ---------- Helpers ----------
  const up = s => (s||"").toString().trim().toUpperCase();
  const esc = s => String(s==null?"":s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  const when = ts => (ts? new Date(ts).toLocaleString() : "—");

  function paintEntries(){
    const tb = $("#entTbl tbody");
    $("#entCount").textContent = entries.length;
    if(!entries.length){ tb.innerHTML = '<tr><td colspan="6" class="hint">No entries.</td></tr>'; return; }
    tb.innerHTML = entries.map(e=>{
      const id = e._id || e.username;
      const status = (e.status||"pending").toLowerCase();
      return `<tr data-id="${esc(id)}">
        <td>${esc(when(e.ts))}</td>
        <td><b>${esc(e.username||"")}</b></td>
        <td>${esc(e.side||"")}</td>
        <td>${esc(e.game||"—")}</td>
        <td><span class="badge">${esc(status)}</span></td>
        <td>
          <button class="btn ok" data-act="approve">Approve</button>
          <button class="btn warn" data-act="reject">Reject</button>
          <button class="btn bad" data-act="delete">Delete</button>
        </td>
      </tr>`;
    }).join("");

    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const tr = btn.closest("tr"); const id = tr.getAttribute("data-id");
        const act = btn.getAttribute("data-act"); btn.disabled = true;
        try{
          if(act==="approve"||act==="reject"){
            const status = act==="approve" ? "approved" : "rejected";
            const r = await fetch(API+`/api/pvp/entries/${encodeURIComponent(id)}/status`,{
              method:"POST", credentials:"include",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({status})
            });
            if(!r.ok) throw 0;
          }else{
            const r = await fetch(API+`/api/pvp/entries/${encodeURIComponent(id)}`,{
              method:"DELETE", credentials:"include"
            });
            if(!r.ok) throw 0;
          }
          await loadEntries();
        }catch{ alert("Action failed"); }
        finally{ btn.disabled=false; }
      });
    });
  }

  async function loadEntries(){
    try{
      const r = await fetch(API+"/api/pvp/entries",{credentials:"include",cache:"no-store"});
      const j = await r.json();
      entries = Array.isArray(j.entries)? j.entries : [];
    }catch{ entries = []; }
    paintEntries();
  }

  function paintSeeds(){
    const eBox = $("#eastList"), wBox=$("#westList");
    eBox.innerHTML = east.map((s,i)=>seedRow("EAST",i,s)).join("") || `<div class="hint">None yet.</div>`;
    wBox.innerHTML = west.map((s,i)=>seedRow("WEST",i,s)).join("") || `<div class="hint">None yet.</div>`;

    eBox.querySelectorAll("button[data-rem]").forEach(b=>{
      b.addEventListener("click", ()=>{ const i=+b.getAttribute("data-rem"); east.splice(i,1); paintSeeds(); });
    });
    wBox.querySelectorAll("button[data-rem]").forEach(b=>{
      b.addEventListener("click", ()=>{ const i=+b.getAttribute("data-rem"); west.splice(i,1); paintSeeds(); });
    });

    const perSide = size/2;
    $("#seedInfo").textContent = `Seeds: EAST ${east.length}/${perSide} • WEST ${west.length}/${perSide}`;
  }

  function seedRow(side,i,s){
    return `<div class="seed"><span class="tag">${i+1}.</span> <b>${esc(s.name)}</b> <span class="tag">${esc(side)}</span> <span class="pill">${esc(s.game||"TBD")}</span> <button class="btn bad" data-rem="${i}">Remove</button></div>`;
  }

  function autoSeedFromApproved(){
    const perSide = size/2;
    const approved = entries.filter(e=>String(e.status).toLowerCase()==="approved");
    const eApproved = approved.filter(e=>String(e.side).toUpperCase()==="EAST");
    const wApproved = approved.filter(e=>String(e.side).toUpperCase()==="WEST");

    east = eApproved.slice(0,perSide).map(x=>({name:up(x.username||""), game:up(x.game||"")}));
    west = wApproved.slice(0,perSide).map(x=>({name:up(x.username||""), game:up(x.game||"")}));

    // If one side short, fill from the other pool ignoring side
    const pool = approved.map(x=>({name:up(x.username||""), game:up(x.game||"")}));
    while(east.length < perSide && pool.length){ east.push(pool.shift()); }
    while(west.length < perSide && pool.length){ west.push(pool.shift()); }

    paintSeeds();
  }

  function addSeed(which){
    const name = up($(which==="EAST"?"#eastUser":"#westUser").value);
    const game = up($(which==="EAST"?"#eastGame":"#westGame").value);
    if(!name) return;
    (which==="EAST"?east:west).push({name, game});
    $(which==="EAST"?"#eastUser":"#westUser").value="";
    $(which==="EAST"?"#eastGame":"#westGame").value="";
    paintSeeds();
  }

  // Build a simple “builder” object that Unified Live can list (match rows).
  function buildBracketObject(){
    const perSide = size/2;
    const E = east.slice(0,perSide), W = west.slice(0,perSide);

    // Games catalog so matches can reference an id
    let gid = 0;
    function mkGameFromSeed(s){
      gid++;
      return { id:`G${gid}`, title:s.game||"TBD", provider:"", imageUrl:"" };
    }

    const games = [];
    const leftIds = E.map(s=>{ const g=mkGameFromSeed(s); games.push(g); return g.id; });
    const rightIds= W.map(s=>{ const g=mkGameFromSeed(s); games.push(g); return g.id; });

    // Create round-1 matches for East and West separately (paired sequentially)
    function pair(ids, side){
      const out=[];
      for(let i=0;i<ids.length;i+=2){
        const L = ids[i], R = ids[i+1];
        if(!R){ // odd count → bye (single advances)
          out.push({ leftId:L, rightId:null, leftTitle:side+" #"+(i+1), rightTitle:"BYE", leftScore:0, rightScore:0, side });
        }else{
          out.push({ leftId:L, rightId:R, leftTitle:side+" #"+(i+1), rightTitle:side+" #"+(i+2), leftScore:0, rightScore:0, side });
        }
      }
      return out;
    }

    const eastMatches = pair(leftIds, "EAST");
    const westMatches = pair(rightIds, "WEST");

    // Publish a combined “matches” list; Unified Live will just list these rows.
    const matches = [...eastMatches, ...westMatches];

    const builder = {
      kind: "pvp",
      title: "PVP — East vs West",
      eventId: "pvp:"+new Date().toISOString().slice(0,10),
      size,
      lastUpdated: Date.now(),
      games,
      matches
    };

    // Local storage (for your current unified live)
    try{
      localStorage.setItem("pv:builder:pvp", JSON.stringify(builder));
      localStorage.setItem("pvp:builder", JSON.stringify(builder)); // legacy
    }catch{}

    return builder;
  }

  async function publish(){
    const builder = buildBracketObject();
    $("#pubMsg").textContent = "Publishing…";
    try{
      const r = await fetch(API+"/api/pvp/bracket",{
        method:"PUT", credentials:"include",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ bracket: builder })
      });
      if(!r.ok) throw 0;
      $("#pubMsg").textContent = "Published ✓";
    }catch{
      $("#pubMsg").textContent = "Publish failed.";
    }
  }

  // ---------- Boot ----------
  function boot(){
    // load entries
    loadEntries();

    // wire entries controls
    $("#entRefresh").addEventListener("click", loadEntries);
    $("#takeApproved").addEventListener("click", ()=>{
      // mark approved quickly in UI (quality-of-life)
      entries.forEach(e=>{ if(String(e.status).toLowerCase()==="approved"){
        const s = String(e.side).toUpperCase()==="WEST" ? west : east;
        if(!s.find(x=>x.name===up(e.username))) s.push({name:up(e.username), game:up(e.game||"")});
      }});
      paintSeeds();
    });

    // seed controls
    $("#autoSeedBtn").addEventListener("click", ()=>{ autoSeedFromApproved(); buildBracketObject(); $("#pubMsg").textContent="Bracket built locally. Click Publish to push to server."; });
    $("#clearSeedsBtn").addEventListener("click", ()=>{ east=[]; west=[]; paintSeeds(); });

    $("#eastAdd").addEventListener("click", ()=>addSeed("EAST"));
    $("#westAdd").addEventListener("click", ()=>addSeed("WEST"));

    $("#sizeSel").addEventListener("change", (e)=>{ size = Number(e.target.value)||16; paintSeeds(); });

    // publish
    $("#publishBtn").addEventListener("click", publish);

    // logout
    $("#adminLogout").addEventListener("click", async ()=>{
      try{ await fetch("/api/admin/gate/logout",{method:"POST",credentials:"include"}); }catch{}
      location.href="/index.html";
    });

    // defaults
    size = Number($("#sizeSel").value)||16;
    paintSeeds();
  }
})();
</script>
</body>
</html>
