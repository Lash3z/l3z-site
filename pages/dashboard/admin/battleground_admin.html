<!DOCTYPE html>
<html lang="en" data-admin="checking">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battleground — Admin (Games • Matchups • Live)</title>
<meta http-equiv="Cache-Control" content="no-store"/>

<style>
:root{
  --bg:#060b0d;--panel:#0b1417;--ink:#eaf7ff;--muted:#9fd0d6;--line:rgba(0,255,255,.18);
  --teal:#00ffff;--gold:#ffb42d;--ok:#12d48a;--bad:#e25a6f;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
html[data-admin="checking"] body{opacity:0;transition:opacity .12s ease}

.wrap{max-width:1400px;margin:0 auto;padding:16px 16px 64px}
h1{margin:0 0 12px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
.card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
.hr{height:1px;background:var(--line);margin:10px 0}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff;font-weight:800}
.btn{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#0f1720;color:#eaf7ff;font-weight:800;cursor:pointer}
.btn.ok{background:#103d30;border-color:#1fa37b}
.btn.danger{background:#2b1116;border-color:#7e2a3c}
.btn.warn{background:#231b0f;border-color:#8c6926}
input,select{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:#eaf7ff;padding:10px}
.small{font-size:12px;color:#9fd0d6}
.badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#081318;color:#bfe}

/* Games list */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:1100px){.grid{grid-template-columns:1fr}}
.games{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.gamesHead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
.gamesBody{max-height:520px;overflow:auto;padding:10px;background:#0b1418}
.game{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px;background:#0c1519}
.game + .game{margin-top:8px}
.thumb{width:64px;height:86px;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:#000}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.title{font-weight:900}
.prov{font-size:12px;color:#9fd0d6}

/* Matches */
.matches{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.matchesHead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
.matchesBody{max-height:520px;overflow:auto;padding:10px;background:#0b1418}
.mx{display:grid;grid-template-columns:1fr 40px 1fr auto;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px;background:#0c1519}
.mx .side{display:grid;grid-template-columns:52px 1fr;gap:10px;align-items:center}
.sThumb{width:52px;height:70px;border:1px solid var(--line);border-radius:8px;background:#000;overflow:hidden}
.sThumb img{width:100%;height:100%;object-fit:cover;display:block}
.vs{font-weight:900;text-align:center;opacity:.9}
.mCtrls{display:flex;gap:8px;align-items:center}

/* Live ticker */
.live{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.liveBody{padding:10px;background:#0b1418;display:grid;gap:10px}
.liveRow{display:grid;grid-template-columns:1fr 60px 1fr 80px 90px auto;gap:8px;align-items:center}
.score{display:flex;gap:6px;align-items:center}
.score input{width:64px;text-align:center}
</style>
</head>
<body>

<!-- ===== AdminGate (server cookie) ===== -->
<script>
(function(){
  "use strict";
  const ADMIN_CHECK="/api/admin/gate/check", ADMIN_LOGIN="/pages/dashboard/admin/admin_login.html", DASH="/index.html";
  const H=document.documentElement; H.setAttribute("data-admin","checking");
  function lock(){
    H.removeAttribute("data-admin");
    const s=document.createElement("style");
    s.textContent=".lockwrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f12;color:#eaf7ff;font-family:Segoe UI,system-ui,Arial,sans-serif}.lockcard{max-width:640px;margin:24px;padding:24px;border:1px solid rgba(0,255,255,.2);border-radius:14px;background:rgba(0,0,0,.75)}.lockcard h1{margin:0 0 10px;color:#cfe}.lockcard a{color:#7ad7ff;text-decoration:underline}";
    document.head.appendChild(s);
    document.body.innerHTML='<div class="lockwrap"><div class="lockcard"><h1>Administration Locked</h1><div>You must unlock admin on the <a href="'+ADMIN_LOGIN+'">Admin Login</a> first.</div><div style="margin-top:8px;opacity:.8">If you already logged in, your session may have expired.</div><div style="margin-top:14px"><a href="'+DASH+'">Back to Dashboard</a></div></div></div>';
  }
  fetch(ADMIN_CHECK,{credentials:"include",cache:"no-store"}).then(r=>r.ok?r.json():null).then(j=>{ if(j&&j.admin){ H.removeAttribute("data-admin"); }else{ lock(); } }).catch(lock);
})();
</script>
<!-- ===== /AdminGate ===== -->

<div class="wrap">
  <h1>Battleground — Admin</h1>

  <!-- Meta -->
  <div class="card">
    <div class="row">
      <span class="pill">Tip: Use <b>Asset Path</b> for covers (e.g. <code>/assets/slot_images/duck_hunters.png</code>). The Upload box only helps name fields; it is not persisted.</span>
    </div>
    <div class="hr"></div>
    <div class="row" style="align-items:center">
      <label>EVENT TITLE <input id="evTitle" placeholder="BATTLEGROUND" style="min-width:260px"></label>
      <label>BEST OF
        <select id="bestOf">
          <option value="1">1</option>
          <option value="3" selected>3</option>
          <option value="5">5</option>
          <option value="7">7</option>
        </select>
      </label>
      <span class="pill" id="evId">ID: —</span>
    </div>
    <div class="hr"></div>
    <div class="row">
      <label>GAME TITLE <input id="gTitle" placeholder="E.G. DUCK HUNTERS" style="min-width:260px"></label>
      <label>PROVIDER (optional) <input id="gProv" placeholder="E.G. HACKSAW" style="min-width:180px"></label>
      <label>ASSET PATH <input id="gPath" placeholder="/assets/slot_images/duck_hunters.png" style="min-width:360px"></label>
      <input id="gUpload" type="file" accept=".png,.jpg,.jpeg,.webp" multiple style="display:none">
      <button id="useUpload" class="btn">Choose Files</button>
      <button id="autoName" class="btn">Use filename → fields</button>
      <button id="addGame" class="btn ok">+ Add Game</button>
    </div>
  </div>

  <div class="grid">
    <!-- Games -->
    <div class="card games">
      <div class="gamesHead">
        <div style="font-weight:900">Games</div>
        <div class="row">
          <button id="bulkAddFromFiles" class="btn">+ Add N Games (from selected files)</button>
          <select id="bulkN">
            <option>10</option><option selected>20</option><option>40</option>
          </select>
          <span class="small">Select N files first via “Choose Files”. Uses filename for title.</span>
        </div>
      </div>
      <div id="gamesList" class="gamesBody"></div>
    </div>

    <!-- Matchups -->
    <div class="card matches">
      <div class="matchesHead">
        <div class="row">
          <div style="font-weight:900">Matchups & Live Scores</div>
          <div class="pill" id="mxCount">0 matchups</div>
        </div>
        <div class="row">
          <button id="autoGen" class="btn">Auto-generate</button>
          <select id="autoN"><option>5</option><option selected>10</option><option>20</option></select>
          <button id="genN" class="btn ok">⚡ Generate N Matchups</button>
          <button id="addPair" class="btn">+ Add Match (pair selected)</button>
        </div>
      </div>
      <div id="matchesList" class="matchesBody"></div>
    </div>
  </div>

  <!-- Live controls + Push/Publish -->
  <div class="card live">
    <div class="gamesHead">
      <div style="font-weight:900">Live Controls — Push / Publish</div>
      <div class="row">
        <span id="srcBadge" class="pill" title="Where data was loaded from or published to">SRC: local</span>
        <span id="stamp" class="pill">Not pushed</span>
        <span id="msg" class="pill">Ready</span>
      </div>
    </div>
    <div class="liveBody">
      <div class="liveRow small" style="opacity:.9">
        <div>Winner</div><div></div><div></div><div>Left</div><div>Right</div><div>Actions</div>
      </div>
      <div id="liveRows"></div>

      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="openAll" class="btn">Open All</button>
          <button id="lockAll" class="btn">Lock All</button>
          <button id="clearAll" class="btn danger">Delete All</button>
        </div>
        <div class="row">
          <button id="refreshServer" class="btn">Refresh from Server</button>
          <button id="pushBuilder" class="btn ok">Push (local)</button>
          <button id="publishServer" class="btn">Publish to Server</button>
          <button id="exportJson" class="btn">Export JSON</button>
          <label class="btn">
            Import JSON <input id="importJson" type="file" accept=".json" style="display:none">
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  // ---------- helpers ----------
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const kid=(p='ID')=>p+Math.random().toString(36).slice(2,10).toUpperCase();
  const toast=(t,ok)=>{ const n=$("#msg"); n.textContent=t; n.style.color = ok===false ? '#ff9aa7' : '#baffea'; setTimeout(()=>{ n.textContent='Ready'; n.style.color=''; },1600); };

  // Always save absolute paths from site root
  const ASSET_DIR = '/assets/slot_images/';
  const absPath = p => {
    if (!p) return '';
    p = String(p).trim()
      .replace(/slot images\//gi,'slot_images/')  // legacy fix
      .replace(/^assets\/media\//i,'assets/');    // legacy fix
    p = p.replace(/^\.?\//,''); // strip leading ./ or /
    return '/' + p;
  };

  // ---------- storage keys ----------
  const K_BUILDER='bg:builder:battleground';   // canonical
  const K_G='bg:games';                         // legacy mirror for older widgets
  const K_M='bg:matches';                       // legacy mirror for older widgets

  // ---------- state ----------
  let state = read() || {
    games:[],
    matches:[],
    lastUpdated:0,
    eventId: 'battleground:'+new Date().toISOString().slice(0,10),
    title:'BATTLEGROUND',
    bestOf:3
  };

  function read(){ try{ const j=localStorage.getItem(K_BUILDER); return j?JSON.parse(j):null; }catch{return null;} }
  function write(){
    try{
      state.lastUpdated=Date.now();
      localStorage.setItem(K_BUILDER, JSON.stringify(state));
      // mirrors for old pages/widgets
      localStorage.setItem(K_G, JSON.stringify(state.games||[]));
      localStorage.setItem(K_M, JSON.stringify(state.matches||[]));
      $("#evId").textContent = 'ID: '+(state.eventId||'—');
    }catch{}
  }

  // --- migrate any previously saved relative paths to absolute ---
  (function migratePaths(){
    let changed=false;
    (state.games||[]).forEach(g=>{
      const fixed = g.imageUrl ? absPath(g.imageUrl) : '';
      if (fixed && fixed!==g.imageUrl){ g.imageUrl=fixed; changed=true; }
    });
    (state.matches||[]).forEach(m=>{
      const L = m.leftImg ? absPath(m.leftImg) : m.leftImg;
      const R = m.rightImg ? absPath(m.rightImg) : m.rightImg;
      if (L && L!==m.leftImg){ m.leftImg=L; changed=true; }
      if (R && R!==m.rightImg){ m.rightImg=R; changed=true; }
    });
    if(changed) write();
  })();

  // ---------- server hydrate/publish ----------
  async function tryGet(url){
    try{
      const r=await fetch(url,{cache:'no-store',credentials:'include'});
      if(r.ok) return await r.json();
    }catch{}
    return null;
  }

  async function hydrateFromServer(){
    // Priority: explicit builder endpoints -> fallback: matchups only
    let src = await tryGet('/api/battleground/builder')
           || await tryGet('/api/bg/builder')
           || await tryGet('/assets/battleground_builder.json');

    if(src){
      const b = src.builder || src;
      const title = b.title || state.title || 'BATTLEGROUND';
      const eventId = b.eventId || state.eventId || ('battleground:'+new Date().toISOString().slice(0,10));
      const bestOf = +b.bestOf || state.bestOf || 3;
      const games = Array.isArray(b.games)? b.games.map(g=>({...g, imageUrl:g.imageUrl?absPath(g.imageUrl):''})) : (state.games||[]);
      const matches = Array.isArray(b.matches)? b.matches.map(m=>({
        ...m,
        leftImg: m.leftImg?absPath(m.leftImg):m.leftImg,
        rightImg: m.rightImg?absPath(m.rightImg):m.rightImg
      })) : (state.matches||[]);
      state = { ...state, title, eventId, bestOf, games, matches, lastUpdated: Date.now() };
      write(); paintAll();
      $("#srcBadge").textContent='SRC: server';
      $("#stamp").textContent='Loaded @ '+new Date().toLocaleTimeString();
      return true;
    }

    // Fallback: try matchups only APIs
    let mx = await tryGet('/api/battleground/matchups') || await tryGet('/api/bg/matchups');
    if(Array.isArray(mx) && mx.length){
      state.matches = mx.map(m=>({
        id: m.id||kid('M'),
        leftId: m.leftId||m.AId||null,
        rightId: m.rightId||m.BId||null,
        leftTitle: m.leftTitle||m.aName||'LEFT',
        rightTitle: m.rightTitle||m.bName||'RIGHT',
        leftImg: m.leftImg?absPath(m.leftImg):'',
        rightImg: m.rightImg?absPath(m.rightImg):'',
        leftScore: m.leftScore||0,
        rightScore: m.rightScore||0,
        winnerId: m.winnerId||null,
        status: (m.status||'OPEN').toUpperCase()
      }));
      write(); paintAll();
      $("#srcBadge").textContent='SRC: server (matches)';
      $("#stamp").textContent='Loaded @ '+new Date().toLocaleTimeString();
      return true;
    }

    $("#srcBadge").textContent='SRC: local';
    return false;
  }

  async function publishToServer(){
    const payload = {
      builder:{
        title: state.title || 'BATTLEGROUND',
        eventId: state.eventId || ('battleground:'+new Date().toISOString().slice(0,10)),
        lastUpdated: Date.now(),
        games: state.games||[],
        matches: state.matches||[],
        bestOf: state.bestOf||3
      }
    };
    try{
      const r = await fetch('/api/battleground/builder', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw 0;
      $("#stamp").textContent='Published @ '+new Date().toLocaleTimeString();
      $("#srcBadge").textContent='SRC: server';
      toast('Published to server', true);
    }catch{
      // graceful fallback to local push
      state.lastUpdated=Date.now(); write();
      $("#stamp").textContent='Last push @ '+new Date(state.lastUpdated).toLocaleTimeString();
      $("#srcBadge").textContent='SRC: local (server not available)';
      toast('Server publish not available — pushed to local instead.', false);
    }
  }

  // ---------- painting ----------
  function paintGames(){
    const host=$("#gamesList"); host.innerHTML='';
    if(!(state.games||[]).length){ host.innerHTML='<div class="small">No games yet. Use the form above to add.</div>'; return; }
    (state.games||[]).forEach((g,i)=>{
      const row=document.createElement('div'); row.className='game';
      row.innerHTML=`
        <div class="thumb">${g.imageUrl?`<img src="${esc(g.imageUrl)}" alt="">`:''}</div>
        <div><div class="title">${esc(g.title||'—')}</div><div class="prov">${esc(g.provider||'')}</div><div class="small">${esc(g.imageUrl||'')}</div></div>
        <div class="row"><button class="btn warn" data-act="sel" data-i="${i}">Select</button><button class="btn danger" data-act="del" data-i="${i}">Delete</button></div>`;
      host.appendChild(row);
    });
  }

  function paintMatches(){
    const host=$("#matchesList"); host.innerHTML='';
    const L=state.matches||[]; $("#mxCount").textContent=L.length+' matchups';
    if(!L.length){ host.innerHTML='<div class="small">No matchups yet. Select two games and click “+ Add Match (pair selected)” or use Auto-generate.</div>'; return; }
    const gMap=new Map((state.games||[]).map(g=>[g.id,g]));
    L.forEach((m,mi)=>{
      const GL=gMap.get(m.leftId)||{}, GR=gMap.get(m.rightId)||{};
      const row=document.createElement('div'); row.className='mx';
      row.innerHTML=`
        <div class="side"><div class="sThumb">${(m.leftImg||GL.imageUrl)?`<img src="${esc(m.leftImg||GL.imageUrl)}" alt="">`:''}</div><div><div class="title">${esc(m.leftTitle||GL.title||'LEFT')}</div><div class="prov">${esc(GL.provider||'')}</div></div></div>
        <div class="vs">VS</div>
        <div class="side"><div class="sThumb">${(m.rightImg||GR.imageUrl)?`<img src="${esc(m.rightImg||GR.imageUrl)}" alt="">`:''}</div><div><div class="title">${esc(m.rightTitle||GR.title||'RIGHT')}</div><div class="prov">${esc(GR.provider||'')}</div></div></div>
        <div class="mCtrls">
          <button class="btn" data-act="winL" data-i="${mi}">Set Winner ←</button>
          <button class="btn" data-act="winR" data-i="${mi}">→ Set Winner</button>
          <button class="btn danger" data-act="delMx" data-i="${mi}">Delete</button>
        </div>`;
      host.appendChild(row);
    });
    paintLiveRows();
  }

  function paintLiveRows(){
    const host=$("#liveRows"); host.innerHTML='';
    const gMap=new Map((state.games||[]).map(g=>[g.id,g]));
    (state.matches||[]).forEach((m,mi)=>{
      const GL=gMap.get(m.leftId)||{}, GR=gMap.get(m.rightId)||{};
      const row=document.createElement('div'); row.className='liveRow';
      row.innerHTML=`
        <div class="small">${esc(m.leftTitle||GL.title||'LEFT')} vs ${esc(m.rightTitle||GR.title||'RIGHT')} · BO${state.bestOf||3}</div>
        <div class="pill">${esc(m.winnerId? (m.winnerId===m.leftId?'LEFT':'RIGHT') : '—')}</div>
        <div></div>
        <div class="score">L<input type="number" step="1" min="0" value="${+m.leftScore||0}" data-s="l${mi}"></div>
        <div class="score">R<input type="number" step="1" min="0" value="${+m.rightScore||0}" data-s="r${mi}"></div>
        <div class="row">
          <button class="btn" data-act="applyScore" data-i="${mi}">Apply</button>
          <button class="btn" data-act="clearScore" data-i="${mi}">Clear</button>
        </div>`;
      host.appendChild(row);
    });
  }

  function paintAll(){ paintGames(); paintMatches(); }

  // ---------- selection buffer for pairing ----------
  let selected = []; // game ids
  function toggleSelect(i){
    const id=(state.games[i]||{}).id; if(!id) return;
    const k=selected.indexOf(id); if(k>=0) selected.splice(k,1); else selected.push(id);
    selected=selected.slice(-2);
    $$('.game .btn[data-act="sel"]').forEach(btn=>{
      const gid=(state.games[+btn.dataset.i]||{}).id; btn.textContent = selected.includes(gid)?'Selected ✓':'Select';
    });
  }

  // ---------- events / handlers ----------
  $("#useUpload").addEventListener('click',()=>$("#gUpload").click());
  $("#gUpload").addEventListener('change',()=>{ /* preview only; not persisted */ });

  $("#autoName").addEventListener('click',()=>{
    const f=$("#gUpload").files?.[0]; if(!f) return;
    const base=f.name.replace(/\.[^.]+$/,''); // no ext
    if(!$("#gTitle").value) $("#gTitle").value = base.replace(/[_-]+/g,' ').toUpperCase();
    if(!$("#gPath").value) $("#gPath").value = ASSET_DIR + base + '.png';
  });

  function addGameObject(title, provider, path){
    // prevent duplicate (same title + image path)
    const dup = (state.games||[]).some(g => (g.title||'').trim().toUpperCase()===title.toUpperCase().trim() && (g.imageUrl||'')===path);
    if(dup){ toast('Game already exists', false); return false; }
    state.games.push({ id:kid('G'), title:title.toUpperCase(), provider, imageUrl:path });
    return true;
  }

  $("#addGame").addEventListener('click',()=>{
    const title=$("#gTitle").value.trim(); if(!title) return toast('Enter a GAME TITLE',false);
    const provider=$("#gProv").value.trim();
    let path=$("#gPath").value.trim();

    // If user chose a file but no path, suggest a path using filename.
    if(!path){
      const f=$("#gUpload").files?.[0];
      if(f){ const base=f.name.replace(/\.[^.]+$/,''); path=ASSET_DIR + base + '.png'; }
    }
    path = absPath(path);

    if(addGameObject(title, provider, path)){
      write(); paintGames();
      $("#gTitle").value=''; $("#gProv").value=''; $("#gPath").value=''; $("#gUpload").value='';
    }
  });

  $("#bulkAddFromFiles").addEventListener('click',()=>{
    const files = Array.from($("#gUpload").files||[]);
    if(!files.length) return toast('Choose files first',false);
    const N = +($("#bulkN").value||20) || 20;
    let added=0;
    files.slice(0,N).forEach(f=>{
      const base=f.name.replace(/\.[^.]+$/,'');
      const title=base.replace(/[_-]+/g,' ').toUpperCase();
      const path=absPath(ASSET_DIR + base + '.png');
      if(addGameObject(title, '', path)) added++;
    });
    write(); paintGames(); toast('Added '+added+' games');
  });

  $("#autoGen").addEventListener('click',()=>{
    const n=Math.min(10, Math.floor((state.games||[]).length/2));
    genN(n);
  });
  $("#genN").addEventListener('click',()=> genN(+($("#autoN").value||10)||10));

  function genN(n){
    const G=[...(state.games||[])]; if(G.length<2) return toast('Need at least 2 games',false);
    // simple shuffle
    for(let i=G.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; [G[i],G[j]]=[G[j],G[i]]; }
    state.matches=[];
    for(let i=0;i<n && (2*i+1)<G.length;i++){
      const A=G[2*i], B=G[2*i+1];
      state.matches.push({
        id:kid('M'),
        leftId:A.id, rightId:B.id,
        leftTitle:A.title, rightTitle:B.title,
        leftImg:A.imageUrl||'', rightImg:B.imageUrl||'',
        leftScore:0, rightScore:0, winnerId:null, status:'OPEN'
      });
    }
    write(); paintMatches(); toast('Generated '+state.matches.length+' matchups');
  }

  $("#addPair").addEventListener('click',()=>{
    if(selected.length!==2) return toast('Select exactly TWO games',false);
    const [A,B]=selected.map(id=> (state.games||[]).find(g=>g.id===id)).filter(Boolean);
    if(!A||!B) return;
    state.matches.push({ id:kid('M'), leftId:A.id, rightId:B.id, leftTitle:A.title, rightTitle:B.title, leftImg:A.imageUrl||'', rightImg:B.imageUrl||'', leftScore:0, rightScore:0, winnerId:null, status:'OPEN' });
    selected=[]; write(); paintMatches();
  });

  $("#openAll").addEventListener('click',()=>{ (state.matches||[]).forEach(m=>m.status='OPEN'); write(); paintMatches(); });
  $("#lockAll").addEventListener('click',()=>{ (state.matches||[]).forEach(m=>m.status='LOCKED'); write(); paintMatches(); });

  $("#clearAll").addEventListener('click',()=>{
    if(!confirm('Delete ALL games and matchups?')) return;
    state={games:[],matches:[],lastUpdated:0,eventId:'battleground:'+new Date().toISOString().slice(0,10),title:'BATTLEGROUND',bestOf:3};
    write(); paintAll(); toast('Cleared');
  });

  // ---- Push (local), Publish (server), Refresh ----
  $("#pushBuilder").addEventListener('click',()=>{
    state.lastUpdated=Date.now(); write();
    $("#stamp").textContent='Last push @ '+new Date(state.lastUpdated).toLocaleTimeString();
    $("#srcBadge").textContent='SRC: local';
    toast('Pushed to local storage (Prediction/Widget/Bets Admin will pick this up).', true);
  });

  $("#publishServer").addEventListener('click', publishToServer);
  $("#refreshServer").addEventListener('click', hydrateFromServer);

  // delegated clicks for lists
  $("#gamesList").addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    const i=+b.dataset.i;
    if(b.dataset.act==='sel'){ toggleSelect(i); }
    else if(b.dataset.act==='del'){
      const gid = (state.games[i]||{}).id;
      state.games.splice(i,1);
      // remove any matches that referenced this game id
      state.matches = (state.matches||[]).filter(mx => mx.leftId!==gid && mx.rightId!==gid);
      write(); paintAll();
    }
  });

  $("#matchesList").addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    const i=+b.dataset.i; const m=state.matches[i]; if(!m) return;
    if(b.dataset.act==='delMx'){ state.matches.splice(i,1); write(); paintAll(); }
    else if(b.dataset.act==='winL'){ m.winnerId=m.leftId; write(); paintLiveRows(); paintMatches(); }
    else if(b.dataset.act==='winR'){ m.winnerId=m.rightId; write(); paintLiveRows(); paintMatches(); }
  });

  $("#liveRows").addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    const i=+b.dataset.i; const m=state.matches[i]; if(!m) return;
    if(b.dataset.act==='applyScore'){
      const l=$('[data-s="l'+i+'"]'); const r=$('[data-s="r'+i+'"]');
      m.leftScore=+(l?.value||0); m.rightScore=+(r?.value||0); write(); paintMatches();
    }else if(b.dataset.act==='clearScore'){
      m.leftScore=0; m.rightScore=0; m.winnerId=null; write(); paintLiveRows(); paintMatches();
    }
  });

  // Export / Import
  $("#exportJson").addEventListener('click', ()=>{
    const data = {
      title: state.title||'BATTLEGROUND',
      eventId: state.eventId||'',
      lastUpdated: Date.now(),
      games: state.games||[],
      matches: state.matches||[],
      bestOf: state.bestOf||3
    };
    const blob = new Blob([JSON.stringify({builder:data}, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `battleground_builder_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  $("#importJson").addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text = await f.text();
      const j = JSON.parse(text);
      const b = j.builder || j;
      if(!b || !Array.isArray(b.games) || !Array.isArray(b.matches)) throw 0;
      state = {
        title: b.title||'BATTLEGROUND',
        eventId: b.eventId || ('battleground:'+new Date().toISOString().slice(0,10)),
        lastUpdated: Date.now(),
        games: (b.games||[]).map(g=>({...g, imageUrl: g.imageUrl?absPath(g.imageUrl):''})),
        matches: (b.matches||[]).map(m=>({
          ...m,
          leftImg: m.leftImg?absPath(m.leftImg):m.leftImg,
          rightImg: m.rightImg?absPath(m.rightImg):m.rightImg
        })),
        bestOf: b.bestOf||3
      };
      write(); paintAll(); toast('Imported builder JSON', true);
    }catch{
      toast('Import failed (bad JSON)', false);
    }finally{
      e.target.value='';
    }
  });

  // Meta wiring
  $("#evTitle").value = state.title||'BATTLEGROUND';
  $("#bestOf").value = String(state.bestOf||3);
  $("#evId").textContent = 'ID: '+(state.eventId||'—');

  $("#evTitle").addEventListener('change', e=>{ state.title=(e.target.value||'BATTLEGROUND').toUpperCase(); write(); });
  $("#bestOf").addEventListener('change', e=>{ state.bestOf=+e.target.value||3; write(); paintLiveRows(); });

  // boot
  paintAll();
  // Try to hydrate once on boot (non-fatal)
  hydrateFromServer();
})();
</script>
</body>
</html>
