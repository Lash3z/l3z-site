<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Battleground — Admin</title>
<meta http-equiv="Cache-Control" content="no-store"/>
<style>
  :root{
    --bg:#060b0d; --panel:#0b1417; --ink:#eaf7ff; --muted:#9fd0d6; --line:rgba(0,255,255,.18);
    --teal:#00ffff; --ok:#12d48a; --warn:#ffb42d; --danger:#e25a6f; --gold:#ffb42d;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  h1{margin:16px 0 10px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
  .wrap{max-width:1500px;margin:0 auto;padding:0 16px 48px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  input,select,button{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:var(--ink);padding:10px}
  button{cursor:pointer;font-weight:800}
  .btn{padding:10px 12px;border:1px solid var(--line);background:#0f1720;color:var(--ink);border-radius:10px}
  .btn.ok{background:#103d30;border-color:#1fa37b}
  .btn.warn{background:#3a2e10;border-color:#b38328}
  .btn.del{background:#2b1116;border-color:#7e2a3c}
  .card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
  .note{font-size:12px;color:#bfe}

  .grid2{display:grid;grid-template-columns:1fr 1.1fr;gap:16px}
  @media (max-width:1200px){.grid2{grid-template-columns:1fr}}

  .frow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:8px}
  .frow .col{display:flex;flex-direction:column;gap:8px}
  .cap{text-transform:uppercase}

  .gamesList{display:flex;flex-direction:column;gap:12px;max-height:calc(100vh - 360px);overflow:auto;padding-right:6px}
  .gameCard{display:grid;grid-template-columns:64px 1fr auto auto;gap:12px;align-items:center;border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:8px 12px}
  .tiny{width:64px;height:86px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#000}
  .tiny img{width:100%;height:100%;object-fit:cover;display:block}
  .gtitle{font-weight:900}
  .sub{font-size:12px;color:#9fd0d6}

  .matchesList{display:flex;flex-direction:column;gap:14px;max-height:calc(100vh - 360px);overflow:auto;padding-right:6px}
  .matchCard{
    display:grid;
    grid-template-columns: 1fr 48px 48px 48px 1fr 160px 80px;
    grid-template-rows: auto auto;
    gap:10px;
    align-items:center;
    border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:12px;
  }
  .leftName{grid-column:1;grid-row:1;justify-self:end;font-weight:900}
  .leftImg{grid-column:2;grid-row:1}
  .vs{grid-column:3;grid-row:1;display:grid;place-items:center;color:#9fe;font-weight:900}
  .rightImg{grid-column:4;grid-row:1}
  .rightName{grid-column:5;grid-row:1;font-weight:900}
  .thumb{width:48px;height:64px;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:#000}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}

  .scoreL{grid-column:2;grid-row:2}
  .scoreR{grid-column:4;grid-row:2}
  .controls{grid-column:6 / 8;grid-row:1 / 3;display:flex;gap:8px;justify-content:flex-end;align-items:center}
  .winner{color:var(--gold);filter:drop-shadow(0 0 4px #ffb42d66)}
  input[type="number"]{appearance:textfield;width:70px;text-align:center;font-weight:900}
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Battleground — Admin</h1>

  <div class="card" style="display:flex;gap:10px;align-items:center">
    <button id="btnSaveDraft" class="btn warn">Save Draft</button>
    <button id="btnPublish" class="btn ok">Push → Prediction + Live + Bets</button>
    <button id="btnDeleteAll" class="btn del" title="Click twice to confirm">Delete All</button>
    <span id="msg" class="pill" style="margin-left:auto">Ready</span>
  </div>

  <!-- Add game -->
  <div class="card">
    <div class="frow">
      <div class="col">
        <label>GAME TITLE</label>
        <input id="inTitle" class="cap" placeholder="E.G. DUCK HUNTERS"/>
      </div>
      <div class="col">
        <label>PROVIDER</label>
        <input id="inProv" class="cap" placeholder="E.G. HACKSAW"/>
      </div>
      <div class="col">
        <label>OTHER / UPDATE</label>
        <input id="inNote" class="cap" placeholder="OPTIONAL NOTE"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>UPLOAD IMAGE</label>
        <input id="inFile" type="file" accept="image/*"/>
      </div>
      <div class="col" style="flex:1;min-width:360px">
        <label>OR ASSET PATH (relative)</label>
        <div class="row" style="gap:8px">
          <input id="inAsset" style="flex:1" placeholder="assets/slot images/duck hunters.webp"/>
          <button id="btnAuto" class="btn">Auto</button>
        </div>
      </div>
      <button id="btnAdd" class="btn ok">+ Add Game</button>
      <span class="note">All text fields auto-CAP. “Auto” looks in <b>assets/slot images/</b>. To avoid storage limits, prefer Asset Path over Upload.</span>
    </div>
  </div>

  <div class="grid2">
    <!-- LEFT: Games -->
    <div class="card">
      <h3>Games</h3>
      <span class="note">Select two → “Add Match” to create a H2H. Unlimited matchups; images aren’t embedded.</span>
      <div id="gamesList" class="gamesList"></div>
    </div>

    <!-- RIGHT: Matches & Live Scores -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3>Matchups & Live Scores</h3>
        <button id="btnAddMatch" class="btn">+ Add Match (pair selected)</button>
      </div>
      <div id="matchesList" class="matchesList"></div>
    </div>
  </div>

  <div class="card">
    <div class="note">
      Push writes to: <code>bg:builder:battleground</code> (primary) and legacy keys:
      <code>bg:games</code>, <code>bg:matches</code>, <code>BG_SELECTED_GAMES</code>, <code>BG_MATCHUPS</code>, <code>BATTLEGROUND_MATCHUPS</code>, <code>battleground:matches</code>, <code>battleground:admin:matches</code>, <code>bg:admin:matches</code>, <code>bg:matchups</code>. It also updates <code>sb:markets:unified.sections.battleground.h2h</code>.
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  /* ------------------- CONFIG ------------------- */
  const BASES = ['assets/slot images/','../assets/slot images/','/assets/slot images/'];
  const EXT = ['webp','png','jpg','jpeg'];
  const MAX_EMBED_BYTES = 100 * 1024;
  let IMG_INDEX = null;

  /* ------------------- KEYS ------------------- */
  const GKEY='bg:games', MKEY='bg:matches', BKEY='bg:builder:battleground';
  const LEGACY_KEYS = [
    'BG_SELECTED_GAMES','BG_MATCHUPS','BATTLEGROUND_MATCHUPS',
    'battleground:matches','battleground:admin:matches', 'bg:admin:matches', 'bg:matchups'
  ];
  const K_UNIFIED='sb:markets:unified';

  /* ------------------- DOM ------------------- */
  const $ = s=>document.querySelector(s);
  const els = {
    msg: $('#msg'),
    inTitle: $('#inTitle'), inProv: $('#inProv'), inNote: $('#inNote'),
    inFile: $('#inFile'), inAsset: $('#inAsset'), btnAuto: $('#btnAuto'),
    btnAdd: $('#btnAdd'), btnAddMatch: $('#btnAddMatch'),
    btnSaveDraft: $('#btnSaveDraft'), btnPublish: $('#btnPublish'), btnDeleteAll: $('#btnDeleteAll'),
    gamesList: $('#gamesList'), matchesList: $('#matchesList')
  };

  function toast(t,ok){ els.msg.textContent=t; els.msg.style.color=ok===false?'#ff9aa7':'#baffea'; clearTimeout(els._t); els._t=setTimeout(()=>els.msg.textContent='',2600); }
  function load(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null;}catch{ return null; } }
  function esc(s){ s=String(s??''); return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
  function enc(u){ return encodeURI(u); }
  function pid(prefix){ return (prefix||'G') + Math.random().toString(36).slice(2,10).toUpperCase(); }
  function slug(s){ return (s||'').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }

  // quota-safe save
  function save(k,v){
    try{ localStorage.setItem(k, JSON.stringify(v)); }
    catch(e){
      if(k===GKEY){
        let games2=(v||[]).map(g=>{
          if(g.imageUrl && /^data:/i.test(g.imageUrl) && g.imageUrl.length > (MAX_EMBED_BYTES*1.37)){ return {...g, imageUrl:null}; }
          return g;
        });
        try{ localStorage.setItem(GKEY, JSON.stringify(games2)); toast('Stripped large embedded covers (use Asset Path).', false); }
        catch(e2){ toast('Storage full — couldn’t save games.', false); }
      }else{
        toast('Storage full — couldn’t save '+k, false);
      }
    }
  }

  async function imgExists(url){
    return new Promise(res=>{
      const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false);
      i.src = enc(url) + (url.includes('?')?'&':'?') + 'v=' + Date.now();
    });
  }
  async function loadIndex(){
    for(const b of BASES){
      try{
        const r = await fetch(encodeURI(b+'index.json'), {cache:'no-store'}); if(r.ok){ const j=await r.json(); return j.images || j; }
      }catch(e){}
    }
    return null;
  }
  async function autoFind(){
    const raw = els.inTitle.value.trim();
    const prv = els.inProv.value.trim();
    if(!raw){ toast('Type a game title first.', false); return; }
    if(IMG_INDEX===null) IMG_INDEX = await loadIndex();

    const tSlug = slug(raw), pSlug = slug(prv), rawLower = raw.toLowerCase();

    const k1=tSlug, k2=pSlug?`${pSlug}__${tSlug}`:null;
    const mapped = IMG_INDEX && (IMG_INDEX[k2] || IMG_INDEX[k1]);
    if(mapped){
      const cands = (/^(?:\/|\.{1,2}\/|assets\/)/.test(mapped)) ? [mapped] : BASES.map(b=>b+mapped);
      for(const u of cands){ if(await imgExists(u)){ els.inAsset.value=u; toast('Found image (index) ✓'); return; } }
    }
    const guesses=[];
    for(const base of BASES){
      EXT.forEach(ext=>guesses.push(`${base}${raw}.${ext}`));
      EXT.forEach(ext=>guesses.push(`${base}${rawLower}.${ext}`));
      EXT.forEach(ext=>guesses.push(`${base}${tSlug}.${ext}`));
      if(pSlug){
        EXT.forEach(ext=>guesses.push(`${base}${pSlug}__${tSlug}.${ext}`));
        EXT.forEach(ext=>guesses.push(`${base}${pSlug}/${tSlug}.${ext}`));
      }
    }
    for(const u of guesses){ if(await imgExists(u)){ els.inAsset.value=u; toast('Found image ✓'); return; } }
    toast('No matching image found. Upload or paste a path.', false);
  }

  els.btnAuto.addEventListener('click', autoFind);
  ['inTitle','inProv'].forEach(id=>document.getElementById(id).addEventListener('blur', ()=>{ if(!els.inAsset.value) autoFind(); }));
  ['inTitle','inProv','inNote'].forEach(id=>document.getElementById(id).addEventListener('input', function(){ this.value=this.value.toUpperCase(); }));

  /* ------------------- STATE ------------------- */
  let games = load(GKEY) || [];      // {id,title,provider,note,imageUrl}
  let matches = load(MKEY) || [];    // {id,leftId,rightId,leftTitle,rightTitle,leftImg,rightImg,leftScore,rightScore,winnerId}

  /* ------------------- RENDER: Games ------------------- */
  function renderGames(){
    els.gamesList.innerHTML='';
    if(!games.length){ els.gamesList.innerHTML='<div class="pill">No games yet.</div>'; return; }
    games.forEach(g=>{
      const div=document.createElement('div'); div.className='gameCard'; div.dataset.id=g.id;
      const src=g.imageUrl||'';
      div.innerHTML=`
        <div class="tiny">${src?`<img src="${enc(src)}" alt="">`:''}</div>
        <div><div class="gtitle">${esc(g.title||'UNTITLED')}</div><div class="sub">${esc(g.provider||'')}</div></div>
        <label class="btn" style="cursor:pointer"><input type="checkbox" class="pick" style="display:none">Select</label>
        <button class="btn del" data-act="del">Delete</button>
      `;
      div.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        games = games.filter(x=>x.id!==g.id);
        matches = matches.filter(mx=>mx.leftId!==g.id && mx.rightId!==g.id);
        save(GKEY,games); save(MKEY,matches); renderGames(); renderMatches();
      });
      div.querySelector('.pick').addEventListener('change', e=>{
        div.classList.toggle('picked', e.target.checked);
      });
      els.gamesList.appendChild(div);
    });
  }

  /* ------------------- RENDER: Matches ------------------- */
  function renderMatches(){
    els.matchesList.innerHTML='';
    if(!matches.length){ els.matchesList.innerHTML='<div class="pill">No matchups yet. Select two games, then Add Match.</div>'; return; }
    matches.forEach(mx=>{
      const L=games.find(x=>x.id===mx.leftId)||{}, R=games.find(x=>x.id===mx.rightId)||{};
      const leftWin = mx.winnerId && mx.winnerId===mx.leftId;
      const rightWin = mx.winnerId && mx.winnerId===mx.rightId;

      const li=document.createElement('div'); li.className='matchCard'; li.dataset.id=mx.id;
      li.innerHTML=`
        <div class="leftName">${leftWin?'<span class="winner">🏆</span> ':''}${esc(mx.leftTitle||L.title||'LEFT')}</div>
        <div class="leftImg"><div class="thumb">${(L.imageUrl)?`<img src="${enc(L.imageUrl)}" alt="">`:''}</div></div>
        <div class="vs">VS</div>
        <div class="rightImg"><div class="thumb">${(R.imageUrl)?`<img src="${enc(R.imageUrl)}" alt="">`:''}</div></div>
        <div class="rightName">${rightWin?'<span class="winner">🏆</span> ':''}${esc(mx.rightTitle||R.title||'RIGHT')}</div>

        <div class="scoreL"><input class="sL" type="number" min="0" step="1" value="${+mx.leftScore||0}"/></div>
        <div class="scoreR"><input class="sR" type="number" min="0" step="1" value="${+mx.rightScore||0}"/></div>

        <div class="controls">
          <button class="btn ok btnWinner">Set Winner</button>
          <button class="btn del btnDel">Delete</button>
        </div>
      `;

      li.querySelector('.sL').addEventListener('input', e=>{ mx.leftScore=+e.target.value||0; save(MKEY,matches); });
      li.querySelector('.sR').addEventListener('input', e=>{ mx.rightScore=+e.target.value||0; save(MKEY,matches); });

      li.querySelector('.btnWinner').addEventListener('click', ()=>{
        const Ls=+mx.leftScore||0, Rs=+mx.rightScore||0;
        if(Ls===Rs){ toast('Scores tied. Adjust first.', false); return; }
        mx.winnerId = (Ls>Rs)? mx.leftId : mx.rightId;
        save(MKEY,matches); renderMatches(); toast('Winner set.');
      });

      li.querySelector('.btnDel').addEventListener('click', ()=>{
        matches = matches.filter(x=>x.id!==mx.id); save(MKEY,matches); renderMatches();
      });

      els.matchesList.appendChild(li);
    });
  }

  /* ------------------- ACTIONS ------------------- */
  els.btnAdd.addEventListener('click', ()=>{
    const t=els.inTitle.value.trim().toUpperCase();
    const p=els.inProv.value.trim().toUpperCase();
    const n=els.inNote.value.trim().toUpperCase();
    const asset=els.inAsset.value.trim();
    if(!t){ toast('Enter a game title.', false); return; }

    function add(imgUrl){
      games.push({id:pid('G'), title:t, provider:p, note:n, imageUrl:imgUrl||null});
      els.inTitle.value=''; els.inProv.value=''; els.inNote.value='';
      els.inAsset.value=''; els.inFile.value='';
      save(GKEY,games); renderGames(); toast('Game added.');
    }

    const f = (els.inFile.files && els.inFile.files[0]) ? els.inFile.files[0] : null;
    if(f){
      if(f.size > MAX_EMBED_BYTES){
        const url = URL.createObjectURL(f);
        add(null);
        requestAnimationFrame(()=>{
          const last = els.gamesList.querySelector('.gameCard:last-child .tiny');
          if(last){ last.innerHTML = `<img src="${enc(url)}" alt="">`; }
        });
        toast('Image too large to embed. Saved without cover. Use Asset Path / Auto.', false);
      }else{
        const fr=new FileReader(); fr.onload=e=>add(e.target.result); fr.readAsDataURL(f);
      }
    }else{
      add(asset||null);
    }
  });

  els.btnAddMatch.addEventListener('click', ()=>{
    const picks=[...els.gamesList.querySelectorAll('.gameCard .pick:checked')].map(cb=>cb.closest('.gameCard').dataset.id);
    if(picks.length!==2){ toast('Select exactly TWO games.', false); return; }
    const L=games.find(x=>x.id===picks[0]), R=games.find(x=>x.id===picks[1]);
    matches.push({
      id:pid('MX'),
      leftId:L.id,rightId:R.id,leftTitle:L.title,rightTitle:R.title,
      leftImg:L.imageUrl||'', rightImg:R.imageUrl||'',
      leftScore:0,rightScore:0,winnerId:null
    });
    els.gamesList.querySelectorAll('.pick').forEach(cb=>cb.checked=false);
    save(MKEY,matches); renderMatches(); toast('Match added.');
  });

  // "Delete All": require two clicks within 3s (no popups)
  let delArmed=false, delTimer=null;
  els.btnDeleteAll.addEventListener('click', ()=>{
    if(!delArmed){
      delArmed=true; toast('Click again to confirm delete all…', false);
      clearTimeout(delTimer); delTimer=setTimeout(()=>{ delArmed=false; }, 3000);
      return;
    }
    delArmed=false;
    games=[]; matches=[];
    save(GKEY,games); save(MKEY,matches); save(BKEY,{games:[],matches:[],lastUpdated:Date.now()});
    renderGames(); renderMatches(); toast('Cleared.');
  });

  // Save draft only
  els.btnSaveDraft.addEventListener('click', ()=>{ save(GKEY,games); save(MKEY,matches); toast('Draft saved.'); });

  // PUBLISH / PUSH
  els.btnPublish.addEventListener('click', ()=>{
    const now = Date.now();

    // Base store
    save(GKEY,games);
    save(MKEY,matches);

    // Builder object (primary contract)
    const builder={
      games: games.map(g=>({id:g.id,title:g.title,provider:g.provider,note:g.note,imageUrl:g.imageUrl||null})),
      matches: matches.map(mx=>({
        id:mx.id,leftId:mx.leftId,rightId:mx.rightId,
        leftTitle:mx.leftTitle,rightTitle:mx.rightTitle,
        leftImg:mx.leftImg||null,rightImg:mx.rightImg||null,
        leftScore:+mx.leftScore||0,rightScore:+mx.rightScore||0,
        winnerId:mx.winnerId||null
      })),
      lastUpdated: now
    };
    save(BKEY,builder);

    // Legacy match payloads (normalised)
    const legacyMatches = builder.matches.map(m=>({
      id: m.id,
      leftId: m.leftId, rightId: m.rightId,
      leftTitle: m.leftTitle, rightTitle: m.rightTitle,
      leftImg: m.leftImg||'', rightImg: m.rightImg||'',
      leftProv: (games.find(g=>g.id===m.leftId)||{}).provider||'',
      rightProv: (games.find(g=>g.id===m.rightId)||{}).provider||'',
      // keep odds slots for consumers that expect them
      leftOdds: 1.84, rightOdds: 1.84
    }));
    // Write to all known legacy keys
    try{ localStorage.setItem('BG_SELECTED_GAMES', JSON.stringify(builder.games)); }catch(_){}
    for(const k of LEGACY_KEYS){
      try{ localStorage.setItem(k, JSON.stringify(legacyMatches)); }catch(_){}
    }

    // Also update Unified Bets H2H directly so the bet slip admin sees it instantly
    try{
      const U = JSON.parse(localStorage.getItem(K_UNIFIED)||'null') || {
        status:'open', lastUpdated:0,
        sections:{ battleground:{enabled:true,h2h:[],overall:[]}, bonus:{enabled:false,overall:[]}, pvp:{enabled:false,overall:[]} }
      };
      const prev = {};
      (U.sections.battleground.h2h||[]).forEach(o=>{ if(o.matchId) prev[o.matchId]=o; });
      U.sections.battleground.enabled = true;
      U.sections.battleground.h2h = legacyMatches.map(m=>({
        matchId: m.id,
        leftId: m.leftId, rightId: m.rightId,
        leftTitle: m.leftTitle, rightTitle: m.rightTitle,
        leftImg: m.leftImg||'', rightImg: m.rightImg||'',
        leftProv: m.leftProv||'', rightProv: m.rightProv||'',
        leftOdds: (prev[m.id]?.leftOdds)||1.84,
        rightOdds:(prev[m.id]?.rightOdds)||1.84
      }));
      U.lastUpdated = now;
      localStorage.setItem(K_UNIFIED, JSON.stringify(U));
    }catch(_){}

    // Fire a lightweight signal in case any open tabs listen
    try{ window.dispatchEvent(new CustomEvent('bg:updated', {detail:{at:now}})); }catch(_){}

    toast('Pushed to Prediction + Live + Bets ✓');
  });

  // init
  (async()=>{ IMG_INDEX = await loadIndex(); renderGames(); renderMatches(); })();
})();
</script>
</body>
</html>
