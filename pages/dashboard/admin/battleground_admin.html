<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Battleground ‚Äî Admin</title>
<meta http-equiv="Cache-Control" content="no-store"/>
<style>
  :root{
    --bg:#060b0d; --panel:#0b1417; --ink:#eaf7ff; --muted:#9fd0d6; --line:rgba(0,255,255,.18);
    --teal:#00ffff; --ok:#12d48a; --warn:#ffb42d; --danger:#e25a6f; --gold:#ffb42d;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}

  /* prevent content flash while admin check runs */
  html[data-admin="checking"] body{opacity:0;transition:opacity .12s ease}

  h1{margin:16px 0 10px;color:var(--teal);text-shadow:0 0 14px #00ffff55}
  .wrap{max-width:1500px;margin:0 auto;padding:0 16px 48px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  input,select,button{border-radius:10px;border:1px solid var(--line);background:#0c1519;color:var(--ink);padding:10px}
  button{cursor:pointer;font-weight:800}
  .btn{padding:10px 12px;border:1px solid var(--line);background:#0f1720;color:var(--ink);border-radius:10px}
  .btn.ok{background:#103d30;border-color:#1fa37b}
  .btn.warn{background:#3a2e10;border-color:#b38328}
  .btn.del{background:#2b1116;border-color:#7e2a3c}
  .card{background:linear-gradient(180deg,#0a1418,#0a1216);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:12px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#081318;color:#cfffff}
  .note{font-size:12px;color:#bfe}

  .grid2{display:grid;grid-template-columns:1fr 1.1fr;gap:16px}
  @media (max-width:1200px){.grid2{grid-template-columns:1fr}}

  .frow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:8px}
  .frow .col{display:flex;flex-direction:column;gap:8px}
  .cap{text-transform:uppercase}

  .gamesList{display:flex;flex-direction:column;gap:12px;max-height:calc(100vh - 360px);overflow:auto;padding-right:6px}
  .gameCard{display:grid;grid-template-columns:64px 1fr auto auto;gap:12px;align-items:center;border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:8px 12px}
  .tiny{width:64px;height:86px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#000}
  .tiny img{width:100%;height:100%;object-fit:cover;display:block}
  .gtitle{font-weight:900}
  .sub{font-size:12px;color:#9fd0d6}

  .matchesList{display:flex;flex-direction:column;gap:14px;max-height:calc(100vh - 360px);overflow:auto;padding-right:6px}
  .matchCard{
    display:grid;
    grid-template-columns: 1fr 48px 48px 48px 1fr 160px 80px;
    grid-template-rows: auto auto;
    gap:10px;
    align-items:center;
    border:1px solid var(--line);border-radius:12px;background:#0b1418;padding:12px;
  }
  .leftName{grid-column:1;grid-row:1;justify-self:end;font-weight:900}
  .leftImg{grid-column:2;grid-row:1}
  .vs{grid-column:3;grid-row:1;display:grid;place-items:center;color:#9fe;font-weight:900}
  .rightImg{grid-column:4;grid-row:1}
  .rightName{grid-column:5;grid-row:1;font-weight:900}
  .thumb{width:48px;height:64px;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:#000}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}

  .scoreL{grid-column:2;grid-row:2}
  .scoreR{grid-column:4;grid-row:2}
  .controls{grid-column:6 / 8;grid-row:1 / 3;display:flex;gap:8px;justify-content:flex-end;align-items:center}
  .winner{color:var(--gold);filter:drop-shadow(0 0 4px #ffb42d66)}
  input[type="number"]{appearance:textfield;width:70px;text-align:center;font-weight:900}
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
</style>
</head>
<body>

<!-- ========= AdminGate (server cookie check) ========= -->
<script>
(function(){
  "use strict";
  const ADMIN_CHECK = "/api/admin/gate/check";
  const ADMIN_LOGIN = "/pages/dashboard/admin/admin_login.html";
  const DASHBOARD  = "/index.html";
  const MAX_AGE_MS = 12*60*60*1000;

  const H = document.documentElement;
  H.setAttribute("data-admin","checking");

  function unlock(){ H.removeAttribute("data-admin"); }
  function lock(){
    unlock();
    const s=document.createElement("style");
    s.textContent=".lockwrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0f12;color:#eaf7ff;font-family:Segoe UI,system-ui,Arial,sans-serif}.lockcard{max-width:640px;margin:24px;padding:24px;border:1px solid rgba(0,255,255,.2);border-radius:14px;background:rgba(0,0,0,.75);box-shadow:0 0 18px rgba(0,255,255,.15)}.lockcard h1{margin:0 0 10px;color:#cfe}.lockcard a{color:#7ad7ff;text-decoration:underline}";
    document.head.appendChild(s);
    document.body.innerHTML='<div class="lockwrap"><div class="lockcard"><h1>Administration Locked</h1><div>You must unlock admin on the <a href="'+ADMIN_LOGIN+'">Admin Login</a> first.</div><div style="margin-top:8px;font-size:12px;opacity:.85">If you just logged in elsewhere, your unlock may have expired (lasts ~12 hours).</div><div style="margin-top:14px"><a href="'+DASHBOARD+'">Back to Dashboard</a></div></div></div>';
  }

  fetch(ADMIN_CHECK, { credentials:"include", cache:"no-store" })
    .then(r => r.ok ? r.json() : null)
    .then(j => {
      if(j && j.admin){
        try{
          const u=(j.user||"ADMIN").toString().toUpperCase();
          localStorage.setItem("l3z:session", JSON.stringify({user:u,isAdmin:true,expiresAt:Date.now()+7*24*60*60*1000}));
          localStorage.setItem("admin:token", JSON.stringify({by:u,ts:Date.now(),expiresAt:Date.now()+MAX_AGE_MS}));
        }catch(_){}
        unlock();
      }else{
        lock();
      }
    })
    .catch(()=>lock());
})();
</script>
<!-- ========= /AdminGate ========= -->

<div class="wrap">
  <h1>Battleground ‚Äî Admin</h1>

  <div class="card" style="display:flex;gap:10px;align-items:center">
    <button id="btnSaveDraft" class="btn warn">Save Draft</button>
    <button id="btnPublish" class="btn ok">Push ‚Üí Prediction + Live + Bets</button>
    <button id="btnDeleteAll" class="btn del" title="Click twice to confirm">Delete All</button>
    <span id="msg" class="pill" style="margin-left:auto">Ready</span>
  </div>

  <!-- Add game -->
  <div class="card">
    <div class="frow">
      <div class="col">
        <label>GAME TITLE</label>
        <input id="inTitle" class="cap" placeholder="E.G. DUCK HUNTERS"/>
      </div>
      <div class="col">
        <label>PROVIDER</label>
        <input id="inProv" class="cap" placeholder="E.G. HACKSAW"/>
      </div>
      <div class="col">
        <label>OTHER / UPDATE</label>
        <input id="inNote" class="cap" placeholder="OPTIONAL NOTE"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>UPLOAD IMAGE</label>
        <div class="row" style="gap:8px">
          <input id="inFile" type="file" accept="image/*"/>
          <button id="btnUseFileName" class="btn" type="button" title="Fill title/provider from file name">Use filename</button>
        </div>
      </div>
      <div class="col" style="flex:1;min-width:360px">
        <label>OR ASSET PATH (relative)</label>
        <div class="row" style="gap:8px">
          <input id="inAsset" style="flex:1" placeholder="assets/slot images/duck-hunters.webp"/>
          <button id="btnAuto" class="btn" type="button">Auto</button>
        </div>
      </div>
      <button id="btnAdd" class="btn ok" type="button">+ Add Game</button>
    </div>

    <div class="row" style="margin-top:10px;gap:12px">
      <span class="note">All text fields auto-CAP. ‚ÄúAuto‚Äù looks in <b>assets/slot images/</b>. Prefer Asset Path over Upload to avoid storage limits.</span>
    </div>

    <div class="row" style="margin-top:14px;gap:10px">
      <label class="pill" style="display:flex;align-items:center;gap:8px">
        Bulk add from assets
        <input id="bulkCount" type="number" min="1" step="1" value="20" style="width:100px">
      </label>
      <button id="btnBulkFromAssets" class="btn" type="button">+ Add N Games</button>
    </div>
  </div>

  <div class="grid2">
    <!-- LEFT: Games -->
    <div class="card">
      <h3>Games</h3>
      <span class="note">Select two ‚Üí ‚ÄúAdd Match‚Äù to create a H2H. Unlimited matchups; images aren‚Äôt embedded.</span>
      <div id="gamesList" class="gamesList"></div>
    </div>

    <!-- RIGHT: Matches & Live Scores -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3>Matchups & Live Scores</h3>
        <button id="btnAddMatch" class="btn" type="button">+ Add Match (pair selected)</button>
      </div>

      <div class="row" style="margin-top:8px;gap:8px">
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          Auto-generate
          <input id="autoMxCount" type="number" min="1" step="1" value="10" style="width:110px">
        </label>
        <button id="btnAutoMatchups" class="btn ok" type="button">‚ö° Generate N Matchups</button>
        <button class="btn" type="button" onclick="document.getElementById('autoMxCount').value=5">5</button>
        <button class="btn" type="button" onclick="document.getElementById('autoMxCount').value=10">10</button>
        <button class="btn" type="button" onclick="document.getElementById('autoMxCount').value=20">20</button>
      </div>

      <div id="matchesList" class="matchesList" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card">
    <div class="note">
      Push writes to: <code>bg:builder:battleground</code> (primary) and legacy keys:
      <code>bg:games</code>, <code>bg:matches</code>, <code>BG_SELECTED_GAMES</code>, <code>BG_MATCHUPS</code>, <code>BATTLEGROUND_MATCHUPS</code>, <code>battleground:matches</code>, <code>battleground:admin:matches</code>, <code>bg:admin:matches</code>, <code>bg:matchups</code>. It also updates <code>sb:markets:unified.sections.battleground.h2h</code>.
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  /* ------------------- CONFIG ------------------- */
  const BASES = ['assets/slot images/','../assets/slot images/','/assets/slot images/'];
  const EXT = ['webp','png','jpg','jpeg'];
  const MAX_EMBED_BYTES = 100 * 1024;
  let IMG_INDEX = null;

  /* ------------------- KEYS ------------------- */
  const GKEY='bg:games', MKEY='bg:matches', BKEY='bg:builder:battleground';
  const K_UNIFIED='sb:markets:unified';

  /* ------------------- DOM ------------------- */
  const $ = s=>document.querySelector(s);
  const els = {
    msg: $('#msg'),
    inTitle: $('#inTitle'), inProv: $('#inProv'), inNote: $('#inNote'),
    inFile: $('#inFile'), inAsset: $('#inAsset'), btnAuto: $('#btnAuto'),
    btnUseFileName: $('#btnUseFileName'),
    btnAdd: $('#btnAdd'), btnAddMatch: $('#btnAddMatch'),
    btnSaveDraft: $('#btnSaveDraft'), btnPublish: $('#btnPublish'), btnDeleteAll: $('#btnDeleteAll'),
    gamesList: $('#gamesList'), matchesList: $('#matchesList'),
    bulkCount: $('#bulkCount'), btnBulkFromAssets: $('#btnBulkFromAssets'),
    autoMxCount: $('#autoMxCount'), btnAutoMatchups: $('#btnAutoMatchups')
  };

  function toast(t,ok){ els.msg.textContent=t; els.msg.style.color=ok===false?'#ff9aa7':'#baffea'; clearTimeout(els._t); els._t=setTimeout(()=>els.msg.textContent='',2600); }
  function load(k){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):null;}catch{ return null; } }
  function esc(s){ s=String(s??''); return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function enc(u){ return encodeURI(u); }
  function pid(prefix){ return (prefix||'G') + Math.random().toString(36).slice(2,10).toUpperCase(); }
  function slug(s){ return (s||'').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function unslug(s){ return String(s||'').replace(/[-_]+/g,' ').replace(/\s+/g,' ').trim().replace(/\b\w/g,c=>c.toUpperCase()); }

  function titleFromFilename(name){
    name = String(name||'');
    const base = name.split('/').pop();
    const noExt = base.replace(/\.[a-z0-9]+$/i,'');
    let provider = '', titlePart = noExt;

    const m1 = /^([a-z0-9\-]+)__(.+)$/i.exec(noExt);
    if(m1){ provider = unslug(m1[1]); titlePart = m1[2]; }
    else if(name.includes('/')){
      const parts = name.split('/');
      if(parts.length>=2){ provider = unslug(parts[parts.length-2]); }
    }
    const title = unslug(titlePart);
    return { title, provider };
  }

  // quota-safe save
  function save(k,v){
    try{ localStorage.setItem(k, JSON.stringify(v)); }
    catch(e){
      if(k===GKEY){
        let games2=(v||[]).map(g=>{
          if(g.imageUrl && /^data:/i.test(g.imageUrl) && g.imageUrl.length > (MAX_EMBED_BYTES*1.37)){ return {...g, imageUrl:null}; }
          return g;
        });
        try{ localStorage.setItem(GKEY, JSON.stringify(games2)); toast('Stripped large embedded covers (use Asset Path).', false); }
        catch(e2){ toast('Storage full ‚Äî couldn‚Äôt save games.', false); }
      }else{
        toast('Storage full ‚Äî couldn‚Äôt save '+k, false);
      }
    }
  }

  async function imgExists(url){
    return new Promise(res=>{
      const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false);
      i.src = enc(url) + (url.includes('?')?'&':'?') + 'v=' + Date.now();
    });
  }
  async function loadIndex(){
    for(const b of BASES){
      try{
        const r = await fetch(encodeURI(b+'index.json'), {cache:'no-store'});
        if(r.ok){
          const j=await r.json();
          if(Array.isArray(j)) return j;
          if(Array.isArray(j.images)) return j.images;
          return Object.values(j);
        }
      }catch(e){}
    }
    return null;
  }

  // Try to find image path for typed title/provider using index.json or filename guesses
  async function autoFind(){
    const raw = els.inTitle.value.trim();
    const prv = els.inProv.value.trim();
    if(!raw){ toast('Type a game title first.', false); return; }
    if(IMG_INDEX===null) IMG_INDEX = await loadIndex();

    const tSlug = slug(raw), pSlug = slug(prv), rawLower = raw.toLowerCase();

    if(IMG_INDEX){
      const candidates = [];
      IMG_INDEX.forEach(entry=>{
        if(typeof entry !== 'string') return;
        const e = entry.toLowerCase();
        if(e.includes(tSlug) && (!pSlug || e.includes(pSlug))) candidates.push(entry);
      });
      for(const mapped of candidates){
        const cands = (/^(?:\/|\.{1,2}\/|assets\/)/.test(mapped)) ? [mapped] : BASES.map(b=>b+mapped);
        for(const u of cands){ if(await imgExists(u)){ els.inAsset.value=u; toast('Found image (index) ‚úì'); return; } }
      }
    }

    const guesses=[];
    for(const base of BASES){
      EXT.forEach(ext=>guesses.push(`${base}${raw}.${ext}`));
      EXT.forEach(ext=>guesses.push(`${base}${rawLower}.${ext}`));
      EXT.forEach(ext=>guesses.push(`${base}${tSlug}.${ext}`));
      if(prv){
        const pSlug2 = slug(prv);
        EXT.forEach(ext=>guesses.push(`${base}${pSlug2}__${tSlug}.${ext}`));
        EXT.forEach(ext=>guesses.push(`${base}${pSlug2}/${tSlug}.${ext}`));
      }
    }
    for(const u of guesses){ if(await imgExists(u)){ els.inAsset.value=u; toast('Found image ‚úì'); return; } }
    toast('No matching image found. Upload or paste a path.', false);
  }

  // Fill title/provider from uploaded file name
  function fillFromFileName(){
    const f = (els.inFile && els.inFile.files && els.inFile.files[0]) ? els.inFile.files[0] : null;
    if(!f){ toast('Pick a file first.', false); return; }
    const { title, provider } = titleFromFilename(f.name);
    if(title && !els.inTitle.value) els.inTitle.value = title.toUpperCase();
    if(provider && !els.inProv.value) els.inProv.value = provider.toUpperCase();
    if(!els.inAsset.value) autoFind();
    toast('Filled fields from file name.');
  }

  if(els.btnUseFileName){ els.btnUseFileName.addEventListener('click', fillFromFileName); }
  if(els.inFile){ els.inFile.addEventListener('change', fillFromFileName); }

  els.btnAuto.addEventListener('click', autoFind);
  ['inTitle','inProv'].forEach(id=>document.getElementById(id).addEventListener('blur', ()=>{ if(!els.inAsset.value) autoFind(); }));
  ['inTitle','inProv','inNote'].forEach(id=>document.getElementById(id).addEventListener('input', function(){ this.value=this.value.toUpperCase(); }));

  /* ------------------- STATE ------------------- */
  let games = load(GKEY) || [];      // {id,title,provider,note,imageUrl}
  let matches = load(MKEY) || [];    // {id,leftId,rightId,leftTitle,rightTitle,leftImg,rightImg,leftScore,rightScore,winnerId}

  /* ------------------- RENDER: Games ------------------- */
  function renderGames(){
    els.gamesList.innerHTML='';
    if(!games.length){ els.gamesList.innerHTML='<div class="pill">No games yet.</div>'; return; }
    games.forEach(g=>{
      const div=document.createElement('div'); div.className='gameCard'; div.dataset.id=g.id;
      const src=g.imageUrl||'';
      div.innerHTML=`
        <div class="tiny">${src?`<img src="${enc(src)}" alt="">`:''}</div>
        <div><div class="gtitle">${esc(g.title||'UNTITLED')}</div><div class="sub">${esc(g.provider||'')}</div></div>
        <label class="btn" style="cursor:pointer"><input type="checkbox" class="pick" style="display:none">Select</label>
        <button class="btn del" data-act="del">Delete</button>
      `;
      div.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        games = games.filter(x=>x.id!==g.id);
        matches = matches.filter(mx=>mx.leftId!==g.id && mx.rightId!==g.id);
        save(GKEY,games); save(MKEY,matches); renderGames(); renderMatches();
      });
      div.querySelector('.pick').addEventListener('change', e=>{
        div.classList.toggle('picked', e.target.checked);
      });
      els.gamesList.appendChild(div);
    });
  }

  /* ------------------- RENDER: Matches ------------------- */
  function renderMatches(){
    els.matchesList.innerHTML='';
    if(!matches.length){ els.matchesList.innerHTML='<div class="pill">No matchups yet. Select two games, then Add Match ‚Äî or use ‚ÄúGenerate N Matchups‚Äù.</div>'; return; }
    matches.forEach(mx=>{
      const L=games.find(x=>x.id===mx.leftId)||{}, R=games.find(x=>x.id===mx.rightId)||{};
      const leftWin = mx.winnerId && mx.winnerId===mx.leftId;
      const rightWin = mx.winnerId && mx.winnerId===mx.rightId;

      const li=document.createElement('div'); li.className='matchCard'; li.dataset.id=mx.id;
      li.innerHTML=`
        <div class="leftName">${leftWin?'<span class="winner">üèÜ</span> ':''}${esc(mx.leftTitle||L.title||'LEFT')}</div>
        <div class="leftImg"><div class="thumb">${(L.imageUrl)?`<img src="${enc(L.imageUrl)}" alt="">`:''}</div></div>
        <div class="vs">VS</div>
        <div class="rightImg"><div class="thumb">${(R.imageUrl)?`<img src="${enc(R.imageUrl)}" alt="">`:''}</div></div>
        <div class="rightName">${rightWin?'<span class="winner">üèÜ</span> ':''}${esc(mx.rightTitle||R.title||'RIGHT')}</div>

        <div class="scoreL"><input class="sL" type="number" min="0" step="1" value="${+mx.leftScore||0}"/></div>
        <div class="scoreR"><input class="sR" type="number" min="0" step="1" value="${+mx.rightScore||0}"/></div>

        <div class="controls">
          <button class="btn ok btnWinner">Set Winner</button>
          <button class="btn del btnDel">Delete</button>
        </div>
      `;

      li.querySelector('.sL').addEventListener('input', e=>{ mx.leftScore=+e.target.value||0; save(MKEY,matches); });
      li.querySelector('.sR').addEventListener('input', e=>{ mx.rightScore=+e.target.value||0; save(MKEY,matches); });

      li.querySelector('.btnWinner').addEventListener('click', ()=>{
        const Ls=+mx.leftScore||0, Rs=+mx.rightScore||0;
        if(Ls===Rs){ toast('Scores tied. Adjust first.', false); return; }
        mx.winnerId = (Ls>Rs)? mx.leftId : mx.rightId;
        save(MKEY,matches); renderMatches(); toast('Winner set.');
      });

      li.querySelector('.btnDel').addEventListener('click', ()=>{
        matches = matches.filter(x=>x.id!==mx.id); save(MKEY,matches); renderMatches();
      });

      els.matchesList.appendChild(li);
    });
  }

  /* ------------------- ACTIONS (existing) ------------------- */
  els.btnAdd.addEventListener('click', ()=>{
    const t=els.inTitle.value.trim().toUpperCase();
    const p=els.inProv.value.trim().toUpperCase();
    const n=els.inNote.value.trim().toUpperCase();
    const asset=els.inAsset.value.trim();
    if(!t){ toast('Enter a game title.', false); return; }

    function add(imgUrl){
      games.push({id:pid('G'), title:t, provider:p, note:n, imageUrl:imgUrl||null});
      els.inTitle.value=''; els.inProv.value=''; els.inNote.value='';
      els.inAsset.value=''; if(els.inFile) els.inFile.value='';
      save(GKEY,games); renderGames(); toast('Game added.');
    }

    const f = (els.inFile && els.inFile.files && els.inFile.files[0]) ? els.inFile.files[0] : null;
    if(f){
      if(f.size > MAX_EMBED_BYTES){
        const url = URL.createObjectURL(f);
        add(null);
        requestAnimationFrame(()=>{
          const last = els.gamesList.querySelector('.gameCard:last-child .tiny');
          if(last){ last.innerHTML = `<img src="${enc(url)}" alt="">`; }
        });
        toast('Image too large to embed. Saved without cover. Use Asset Path / Auto.', false);
      }else{
        const fr=new FileReader(); fr.onload=e=>add(e.target.result); fr.readAsDataURL(f);
      }
    }else{
      add(asset||null);
    }
  });

  els.btnAddMatch.addEventListener('click', ()=>{
    const picks=[...els.gamesList.querySelectorAll('.gameCard .pick:checked')].map(cb=>cb.closest('.gameCard').dataset.id);
    if(picks.length!==2){ toast('Select exactly TWO games.', false); return; }
    const L=games.find(x=>x.id===picks[0]), R=games.find(x=>x.id===picks[1]);
    matches.push({
      id:pid('MX'),
      leftId:L.id,rightId:R.id,leftTitle:L.title,rightTitle:R.title,
      leftImg:L.imageUrl||'', rightImg:R.imageUrl||'',
      leftScore:0,rightScore:0,winnerId:null
    });
    els.gamesList.querySelectorAll('.pick').forEach(cb=>cb.checked=false);
    save(MKEY,matches); renderMatches(); toast('Match added.');
  });

  // "Delete All": require two clicks within 3s (no popups)
  let delArmed=false, delTimer=null;
  els.btnDeleteAll.addEventListener('click', ()=>{
    if(!delArmed){
      delArmed=true; toast('Click again to confirm delete all‚Ä¶', false);
      clearTimeout(delTimer); delTimer=setTimeout(()=>{ delArmed=false; }, 3000);
      return;
    }
    delArmed=false;
    games=[]; matches=[];
    save(GKEY,games); save(MKEY,matches); save(BKEY,{games:[],matches:[],lastUpdated:Date.now()});
    renderGames(); renderMatches(); toast('Cleared.');
  });

  // Save draft only
  els.btnSaveDraft.addEventListener('click', ()=>{ save(GKEY,games); save(MKEY,matches); toast('Draft saved.'); });

  // PUBLISH / PUSH (unchanged)
  els.btnPublish.addEventListener('click', ()=>{
    const now = Date.now();
    save(GKEY,games);
    save(MKEY,matches);
    const builder={
      games: games.map(g=>({id:g.id,title:g.title,provider:g.provider,note:g.note,imageUrl:g.imageUrl||null})),
      matches: matches.map(mx=>({
        id:mx.id,leftId:mx.leftId,rightId:mx.rightId,
        leftTitle:mx.leftTitle,rightTitle:mx.rightTitle,
        leftImg:mx.leftImg||null,rightImg:mx.rightImg||null,
        leftScore:+mx.leftScore||0,rightScore:+mx.rightScore||0,
        winnerId:mx.winnerId||null
      })),
      lastUpdated: now
    };
    save(BKEY,builder);

    const legacyMatches = builder.matches.map(m=>({
      id: m.id,
      leftId: m.leftId, rightId: m.rightId,
      leftTitle: m.leftTitle, rightTitle: m.rightTitle,
      leftImg: m.leftImg||'', rightImg: m.rightImg||'',
      leftProv: (games.find(g=>g.id===m.leftId)||{}).provider||'',
      rightProv: (games.find(g=>g.id===m.rightId)||{}).provider||'',
      leftOdds: 1.84, rightOdds: 1.84
    }));
    try{ localStorage.setItem('BG_SELECTED_GAMES', JSON.stringify(builder.games)); }catch(_){}
    for(const k of ['BG_MATCHUPS','BATTLEGROUND_MATCHUPS','battleground:matches','battleground:admin:matches','bg:admin:matches','bg:matchups']){
      try{ localStorage.setItem(k, JSON.stringify(legacyMatches)); }catch(_){}
    }

    try{
      const U = JSON.parse(localStorage.getItem(K_UNIFIED)||'null') || {
        status:'open', lastUpdated:0,
        sections:{ battleground:{enabled:true,h2h:[],overall:[]}, bonus:{enabled:false,overall:[]}, pvp:{enabled:false,overall:[]} }
      };
      const prev = {};
      (U.sections.battleground.h2h||[]).forEach(o=>{ if(o.matchId) prev[o.matchId]=o; });
      U.sections.battleground.enabled = true;
      U.sections.battleground.h2h = legacyMatches.map(m=>({
        matchId: m.id,
        leftId: m.leftId, rightId: m.rightId,
        leftTitle: m.leftTitle, rightTitle: m.rightTitle,
        leftImg: m.leftImg||'', rightImg: m.rightImg||'',
        leftProv: m.leftProv||'', rightProv: m.rightProv||'',
        leftOdds: (prev[m.id]?.leftOdds)||1.84,
        rightOdds:(prev[m.id]?.rightOdds)||1.84
      }));
      U.lastUpdated = now;
      localStorage.setItem(K_UNIFIED, JSON.stringify(U));
    }catch(_){}

    try{ window.dispatchEvent(new CustomEvent('bg:updated', {detail:{at:now}})); }catch(_){}
    toast('Pushed to Prediction + Live + Bets ‚úì');
  });

  /* ------------------- NEW: Bulk add games from assets ------------------- */
  async function bulkAddFromAssets(count){
    count = Math.max(1, Math.floor(+count||0));
    if(IMG_INDEX===null) IMG_INDEX = await loadIndex();
    if(!IMG_INDEX || !IMG_INDEX.length){ toast('No assets index found (assets/slot images/index.json).', false); return; }

    const existing = new Set(games.map(g => `${(g.provider||'').toUpperCase()}::${(g.title||'').toUpperCase()}`));

    let added = 0;
    outer: for(const entry of IMG_INDEX){
      if(added >= count) break;
      if(typeof entry !== 'string') continue;

      // build URL candidates and pick first that loads
      const candidates = (/^(?:\/|\.{1,2}\/|assets\/)/.test(entry)) ? [entry] : BASES.map(b=>b+entry);
      let url = null;
      for(const u of candidates){ if(await imgExists(u)){ url = u; break; } }
      if(!url) continue;

      const { title, provider } = titleFromFilename(entry);
      const key = `${(provider||'').toUpperCase()}::${(title||'').toUpperCase()}`;
      if(existing.has(key)) continue;

      games.push({ id:pid('G'), title:(title||'UNTITLED').toUpperCase(), provider:(provider||'').toUpperCase(), note:'', imageUrl:url });
      existing.add(key);
      added++;
    }
    if(added===0){ toast('No new games added (maybe all are already present).', false); }
    else { save(GKEY,games); renderGames(); toast(`Added ${added} game${added!==1?'s':''} from assets.`); }
  }

  if(els.btnBulkFromAssets){
    els.btnBulkFromAssets.addEventListener('click', ()=> bulkAddFromAssets(els.bulkCount ? els.bulkCount.value : 20));
  }

  /* ------------------- NEW: Auto-generate N matchups ------------------- */
  async function autoGenerateMatchups(n){
    n = Math.max(1, Math.floor(+n||0));
    const needGames = n*2;
    if(games.length < needGames){
      const deficit = needGames - games.length;
      await bulkAddFromAssets(deficit);
      if(games.length < needGames){
        toast(`Not enough games to create ${n} matchups. Need ${needGames}, have ${games.length}.`, false);
        return;
      }
    }

    const ids = games.map(g=>g.id);
    for(let i=ids.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [ids[i],ids[j]]=[ids[j],ids[i]]; }
    const selected = ids.slice(0, needGames);

    for(let i=0;i<n;i++){
      const a = games.find(g=>g.id===selected[i*2]);
      const b = games.find(g=>g.id===selected[i*2+1]);
      if(!a || !b) continue;
      matches.push({
        id:pid('MX'),
        leftId:a.id, rightId:b.id,
        leftTitle:a.title, rightTitle:b.title,
        leftImg:a.imageUrl||'', rightImg:b.imageUrl||'',
        leftScore:0, rightScore:0, winnerId:null
      });
    }
    save(MKEY,matches); renderMatches(); toast(`Created ${n} matchup${n!==1?'s':''}.`);
  }

  if(els.btnAutoMatchups){
    els.btnAutoMatchups.addEventListener('click', ()=> autoGenerateMatchups(els.autoMxCount ? els.autoMxCount.value : 10));
  }

  // init
  (async()=>{ IMG_INDEX = await loadIndex(); renderGames(); renderMatches(); })();
})();
</script>

</body>
</html>
