<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Hub — L3Z</title>
<style>
  :root{
    --bg:#0b0e13; --panel:#11151d; --ink:#e8ecf3; --muted:#94a3b8; --line:rgba(0,255,255,.18);
    --gold:#f0a320; --ok:#12d48a; --err:#ff7a8a; --chip:#1b2330;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0a1016;color:#cfe;font-weight:800}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#0f131a,#0a0f15);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .head h2{margin:0;font-size:14px;letter-spacing:.3px;color:#ffd78a}
  .body{padding:12px 14px;display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row>label{min-width:110px;color:#cbd5e1}
  input,select,button,textarea{
    background:#0f141b;border:1px solid var(--line);color:var(--ink);
    border-radius:10px;padding:10px 12px;font-size:14px
  }
  input[type="number"]{width:140px}
  textarea{width:100%;min-height:80px}
  button{cursor:pointer;font-weight:800}
  button.primary{background:linear-gradient(180deg,#f5c462,#d49a2e);color:#1a1204;border:none}
  button.ghost{background:#111a22}
  button.danger{background:#2a1115;border-color:#7c2731}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  .list{display:grid;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .audit{max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#0c1117;padding:8px}
  .audit pre{margin:0;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:12px;line-height:1.5}
  .help{font-size:12px;color:#9fb3c5}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="/assets/l3z_logo.png" alt="" style="width:36px;height:36px;border-radius:10px;border:1px solid var(--line)">
      <div class="pill">Admin Hub</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="who" class="pill">admin: —</div>
      <button id="logout" class="ghost">Logout</button>
    </div>
  </div>

  <div class="grid">
    <!-- Wallet -->
    <section class="card">
      <div class="head"><h2>Wallet — Credit / Adjust</h2><div class="badge">cookie: <span id="cookieState" class="muted">checking…</span></div></div>
      <div class="body">
        <div class="row"><label>Username</label><input id="wUser" placeholder="PLAYER NAME" /></div>
        <div class="row"><label>Amount</label><input id="wAmt" type="number" step="1" placeholder="Amount" /></div>
        <div class="row"><label>Reason</label><input id="wReason" placeholder="admin_credit / admin_adjust" /></div>
        <div class="row" style="gap:10px">
          <button id="btnCredit" class="primary">Credit ( + )</button>
          <button id="btnAdjust" class="ghost">Adjust (±)</button>
          <button id="btnBal" class="ghost">Check Balance</button>
          <span id="wStatus" class="muted"></span>
        </div>
        <div class="help">Uses <code>/api/wallet/credit</code> and <code>/api/wallet/adjust</code> with <code>credentials:"include"</code>.</div>
      </div>
    </section>

    <!-- Promo Codes -->
    <section class="card">
      <div class="head"><h2>Promo Codes</h2><div class="badge" id="promoBadge">ready</div></div>
      <div class="body">
        <div class="row"><label>LBX amount</label>
          <input id="pcLbx" type="number" step="1" value="5" />
          <label>TTL (hours)</label><input id="pcTtl" type="number" step="1" value="24" />
          <label>Replace current</label><input id="pcReplace" type="checkbox" checked />
        </div>
        <div class="row" style="gap:10px">
          <button id="pcIssue" class="primary">Issue Code</button>
          <button id="pcExpire" class="danger">Expire Current</button>
          <span id="pcStatus" class="muted"></span>
        </div>

        <div class="row"><label>Redeem (test)</label>
          <input id="pcUser" placeholder="USERNAME" />
          <input id="pcCode" placeholder="CODE" />
          <button id="pcSubmit" class="ghost">Redeem</button>
          <span id="pcRedeemStatus" class="muted"></span>
        </div>
        <div class="help">Backed by <code>/api/promo/issue</code>, <code>/api/promo/expire</code>, <code>/api/promo/redeem</code>.</div>
      </div>
    </section>

    <!-- Feature switches -->
    <section class="card">
      <div class="head"><h2>Feature Switches</h2><div class="badge">local</div></div>
      <div class="body">
        <div class="row switch"><input type="checkbox" data-flag="battleground" checked/> <label>Show Battleground</label></div>
        <div class="row switch"><input type="checkbox" data-flag="bonus_hunt"  checked/> <label>Show Bonus Hunt</label></div>
        <div class="row switch"><input type="checkbox" data-flag="pvp"         checked/> <label>Show PvP</label></div>
        <div class="row switch"><input type="checkbox" data-flag="raffles"     checked/> <label>Enable Raffles</label></div>
        <div class="row switch"><input type="checkbox" data-flag="promos"      checked/> <label>Enable Promo Claims</label></div>
        <div class="row" style="gap:10px">
          <button id="btnDisableAll" class="danger">Disable All</button>
          <button id="btnEnableAll"  class="ghost">Enable All</button>
          <span id="flagsStatus" class="muted"></span>
        </div>
        <div class="help">Stored in <code>localStorage</code> under <code>admin:flags</code>. Hook these into your frontend to hide/disable modules. You can later wire this to a server API if you want.</div>
      </div>
    </section>

    <!-- Action tracking / audit -->
    <section class="card">
      <div class="head"><h2>Action Tracking (Local Audit)</h2><div class="badge">client-side</div></div>
      <div class="body">
        <div class="row" style="gap:10px">
          <button id="auditExport" class="ghost">Export JSON</button>
          <button id="auditClear"  class="danger">Clear Log</button>
          <span class="muted">Recent actions are recorded locally (no server required).</span>
        </div>
        <div class="audit"><pre id="auditOut">[]</pre></div>
      </div>
    </section>
  </div>
</div>

<script>
/* ================= utils ================= */
const $ = (s, r)=> (r||document).querySelector(s);
const $$= (s, r)=> Array.from((r||document).querySelectorAll(s));
const say = (el, msg, ok)=> { if(!el) return; el.textContent=msg||""; el.className = (ok===undefined) ? "muted" : (ok ? "ok" : "err"); };
function ts(){ return new Date().toISOString(); }

async function getJSON(url){
  const r = await fetch(url, { credentials:"include", cache:"no-store" });
  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
  return j;
}
async function postJSON(url, body){
  const r = await fetch(url, {
    method:"POST",
    credentials:"include",                       // CRITICAL: send admin cookie
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
  return j;
}

/* ================= admin session bits ================= */
(async function bootAdmin(){
  const whoEl = $("#who");
  const cookieState = $("#cookieState");
  try{
    const me = await getJSON("/api/admin/gate/check");
    whoEl.textContent = `admin: ${me.username||"—"}`;
    say(cookieState, "ok", true);
  }catch(e){
    whoEl.textContent = "admin: (not logged in)";
    say(cookieState, "missing", false);
  }
})();
$("#logout")?.addEventListener("click", async ()=>{
  try{ await postJSON("/api/admin/gate/logout", {}); location.reload(); }catch(e){ location.reload(); }
});

/* ================= audit tracking (local) ================= */
const AUDIT_KEY = "admin:audit";
function readAudit(){ try{ return JSON.parse(localStorage.getItem(AUDIT_KEY)||"[]"); }catch{return [];} }
function writeAudit(a){ try{ localStorage.setItem(AUDIT_KEY, JSON.stringify(a.slice(-500))); }catch{} }
function track(evt, payload){
  const rec = { ts: ts(), evt, payload };
  const a = readAudit(); a.push(rec); writeAudit(a);
  paintAudit();
}
function paintAudit(){
  const out = $("#auditOut");
  out.textContent = JSON.stringify(readAudit().slice(-80).reverse(), null, 2);
}
$("#auditExport")?.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(readAudit(), null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `l3z_admin_audit_${Date.now()}.json`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
});
$("#auditClear")?.addEventListener("click", ()=>{
  localStorage.removeItem(AUDIT_KEY); paintAudit();
});
paintAudit();

/* ================= wallet panel ================= */
const wUser   = $("#wUser");
const wAmt    = $("#wAmt");
const wReason = $("#wReason");
const wStatus = $("#wStatus");

async function adminCreditLBX(username, amount, reason="admin_credit"){
  username = String(username||"").trim().toUpperCase();
  const amt = Number(amount||0);
  if(!username || !Number.isFinite(amt) || amt<=0) throw new Error("bad params");
  const res = await postJSON("/api/wallet/credit", { username, amount: amt, reason });
  track("wallet.credit", { username, amount: amt, reason, balance: res?.balance });
  return Number(res?.balance ?? 0);
}
async function adminAdjustLBX(username, delta, reason="admin_adjust"){
  username = String(username||"").trim().toUpperCase();
  const d = Number(delta||0);
  if(!username || !Number.isFinite(d) || d===0) throw new Error("bad params");
  const res = await postJSON("/api/wallet/adjust", { username, delta: d, reason });
  track("wallet.adjust", { username, delta: d, reason, balance: res?.balance });
  return Number(res?.balance ?? 0);
}
async function adminGetBalance(username){
  username = String(username||"").trim().toUpperCase();
  if(!username) throw new Error("missing user");
  const j = await getJSON(`/api/wallet/balance?user=${encodeURIComponent(username)}`);
  track("wallet.balance", { username, balance: j?.balance });
  return Number(j?.balance ?? 0);
}

$("#btnCredit")?.addEventListener("click", async ()=>{
  try{
    say(wStatus, "Working…");
    const b = await adminCreditLBX(wUser.value, Number(wAmt.value), wReason.value || "admin_credit");
    say(wStatus, `Credited. New balance: ${b.toLocaleString()} LBX`, true);
  }catch(e){ say(wStatus, e.message||"failed", false); }
});
$("#btnAdjust")?.addEventListener("click", async ()=>{
  try{
    say(wStatus, "Working…");
    const b = await adminAdjustLBX(wUser.value, Number(wAmt.value), wReason.value || "admin_adjust");
    say(wStatus, `Adjusted. New balance: ${b.toLocaleString()} LBX`, true);
  }catch(e){ say(wStatus, e.message||"failed", false); }
});
$("#btnBal")?.addEventListener("click", async ()=>{
  try{
    say(wStatus, "Checking…");
    const b = await adminGetBalance(wUser.value);
    say(wStatus, `Balance: ${b.toLocaleString()} LBX`, true);
  }catch(e){ say(wStatus, e.message||"failed", false); }
});

/* ================= promo panel ================= */
const pcLbx = $("#pcLbx");
const pcTtl = $("#pcTtl");
const pcReplace = $("#pcReplace");
const pcIssue = $("#pcIssue");
const pcExpire= $("#pcExpire");
const pcStatus= $("#pcStatus");
const promoBadge = $("#promoBadge");

async function refreshCurrentPromo(){
  try{
    const j = await getJSON("/api/promo/my");
    if(j?.code){
      promoBadge.textContent = `active: ${j.code} (exp ${new Date(j.expiresAt).toLocaleString()})`;
    }else{
      promoBadge.textContent = "no active code";
    }
  }catch{ promoBadge.textContent = "promo unavailable"; }
}
pcIssue?.addEventListener("click", async ()=>{
  try{
    say(pcStatus, "Issuing…");
    const body = {
      lbx: Number(pcLbx.value||5),
      ttlHours: Number(pcTtl.value||24),
      replace: !!pcReplace.checked
    };
    const j = await postJSON("/api/promo/issue", body);
    say(pcStatus, `Issued ${j.code} (+${j.lbx} LBX)`, true);
    track("promo.issue", j);
    refreshCurrentPromo();
  }catch(e){ say(pcStatus, e.message||"failed", false); }
});
pcExpire?.addEventListener("click", async ()=>{
  try{
    say(pcStatus, "Expiring…");
    const j = await postJSON("/api/promo/expire", {});
    say(pcStatus, `Expired (${j.n||0} updated)`, true);
    track("promo.expire", j);
    refreshCurrentPromo();
  }catch(e){ say(pcStatus, e.message||"failed", false); }
});

const pcUser = $("#pcUser");
const pcCode = $("#pcCode");
const pcSubmit = $("#pcSubmit");
const pcRedeemStatus = $("#pcRedeemStatus");

try{ const last = localStorage.getItem("last_username") || ""; if(last) pcUser.value = last; }catch{}

pcSubmit?.addEventListener("click", async ()=>{
  const username = (pcUser.value||"").trim();
  const code = (pcCode.value||"").trim();
  if(!username || !code){ say(pcRedeemStatus, "Enter username + code."); return; }
  pcSubmit.disabled = true; say(pcRedeemStatus, "Submitting…");
  try{
    const j = await postJSON("/api/promo/redeem", { username, code });
    try{ localStorage.setItem("last_username", username); }catch{}
    say(pcRedeemStatus, `Success! +${j.lbx} LBX added.`, true);
    track("promo.redeem", { username, code, lbx: j.lbx });
    pcCode.value = "";
  }catch(e){ say(pcRedeemStatus, (e.message||"failed").replace(/_/g," "), false); }
  finally{ pcSubmit.disabled = false; }
});

refreshCurrentPromo();

/* ================= feature flags + group reset ================= */
const FLAGS_KEY = "admin:flags";
function readFlags(){ try{ return JSON.parse(localStorage.getItem(FLAGS_KEY)||"{}"); }catch{return {}} }
function writeFlags(f){ try{ localStorage.setItem(FLAGS_KEY, JSON.stringify(f)); }catch{} }
function loadFlagsIntoUI(){
  const f = readFlags();
  $$('input[type="checkbox"][data-flag]').forEach(cb=>{
    const k = cb.dataset.flag;
    cb.checked = f[k]!==false; // default true
  });
}
function collectFlagsFromUI(){
  const f = {}; $$('input[type="checkbox"][data-flag]').forEach(cb=> f[cb.dataset.flag] = !!cb.checked);
  return f;
}
function saveFlagsFromUI(){
  const f = collectFlagsFromUI();
  writeFlags(f);
  say($("#flagsStatus"), "Saved.", true);
  track("flags.save", f);
}
$$('input[type="checkbox"][data-flag]').forEach(cb=>{
  cb.addEventListener("change", ()=> saveFlagsFromUI());
});
$("#btnDisableAll")?.addEventListener("click", ()=>{
  $$('input[type="checkbox"][data-flag]').forEach(cb=> cb.checked = false);
  saveFlagsFromUI();
});
$("#btnEnableAll")?.addEventListener("click", ()=>{
  $$('input[type="checkbox"][data-flag]').forEach(cb=> cb.checked = true);
  saveFlagsFromUI();
});
loadFlagsIntoUI();
</script>
</body>
</html>
