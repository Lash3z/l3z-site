<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>L3Z • Live API Diag</title>
<style>
  :root{--bg:#0b0e13;--panel:#0f141b;--ink:#e8ecf3;--muted:#94a3b8;--line:rgba(0,255,255,.18);--ok:#12d48a;--err:#ff7a8a}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  h1{margin:0 0 12px 0;font-size:18px}
  .card{background:#0f141b;border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button{background:#0f141b;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px;font-size:14px}
  button{cursor:pointer;font-weight:800}
  .primary{background:linear-gradient(180deg,#f5c462,#d49a2e);color:#1a1204;border:none}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  pre{margin:8px 0 0 0;background:#0b1218;border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:10px;overflow:auto;max-height:260px}
  code{color:#cfe}
</style>
</head>
<body>
<div class="wrap">
  <h1>Live API Diagnostics</h1>
  <div class="card">
    <div class="row">
      <div>Logged in as: <b id="meUser">—</b> (<span id="meRole">—</span>)</div>
      <div class="muted">cookie: <span id="cookie">checking…</span></div>
    </div>
    <div class="row">
      <button id="btnWho" class="primary">Refresh /api/me</button>
      <button id="btnMyBal" class="primary">Refresh /api/wallet</button>
      <span id="status" class="muted"></span>
    </div>
    <pre id="out"></pre>
  </div>

  <div class="card">
    <div class="row">
      <label>View/Modify user:</label>
      <input id="u" placeholder="username (lowercase)" />
      <input id="amt" type="number" step="1" value="5" />
      <button id="btnBal" class="primary">GET admin balance</button>
      <button id="btnCredit" class="primary">POST admin credit</button>
      <button id="btnDebit">POST admin debit</button>
    </div>
    <div class="muted">Uses <code>/api/admin/wallet/balance</code>, <code>/api/wallet/credit</code>, <code>/api/wallet/debit</code> (admin cookie required).</div>
    <pre id="outUser"></pre>
  </div>

  <div class="card">
    <div class="row">
      <input id="promo" placeholder="PROMO CODE"/>
      <button id="btnRedeem">POST /api/code/redeem</button>
    </div>
    <pre id="outPromo"></pre>
  </div>
</div>

<script>
// lightweight fetch with console echo
async function fx(method, url, body){
  const trace = Math.random().toString(36).slice(2);
  console.log("[api]", method, url, body, trace);
  const res = await fetch(url, {
    method, credentials:"include",
    headers: { "Accept":"application/json", ...(body?{"Content-Type":"application/json"}:{}) },
    body: body ? JSON.stringify(body) : undefined
  });
  const json = await res.json().catch(()=> ({}));
  console.log("[api<-]", res.status, url, json, trace);
  if(!res.ok){ const e=new Error(json?.error||`HTTP ${res.status}`); e.data=json; throw e; }
  return json;
}
const $ = (s,r=document)=>r.querySelector(s);
const say=(el,msg,ok)=>{ if(!el) return; el.textContent=msg||""; el.className=(ok===undefined)?"muted":(ok?"ok":"err"); };

const meUser=$("#meUser"), meRole=$("#meRole"), cookie=$("#cookie"), status=$("#status");
const out=$("#out"), outUser=$("#outUser"), outPromo=$("#outPromo");
const u=$("#u"), amt=$("#amt"), promo=$("#promo");

async function who(){ try{
  const j = await fx("GET","/api/me");
  meUser.textContent = j?.user?.username || "—";
  meRole.textContent = j?.user?.role || "user";
  say(cookie,"ok",true);
  out.textContent = JSON.stringify(j, null, 2);
}catch(e){ meUser.textContent="(not logged in)"; meRole.textContent="—"; say(cookie,"missing",false); out.textContent = e.message; } }

async function myBal(){ try{
  say(status,"/api/wallet …");
  const j = await fx("GET","/api/wallet");
  say(status,"ok",true);
  out.textContent = JSON.stringify(j, null, 2);
}catch(e){ say(status,e.message,false); out.textContent = JSON.stringify(e.data||{error:e.message},null,2); } }

async function adminBal(){ try{
  const name = (u.value||"").trim().toLowerCase();
  outUser.textContent = "…";
  const j = await fx("GET", `/api/admin/wallet/balance?user=${encodeURIComponent(name)}`);
  outUser.textContent = JSON.stringify(j, null, 2);
}catch(e){ outUser.textContent = JSON.stringify(e.data||{error:e.message},null,2); } }

async function credit(){ try{
  const name = (u.value||"").trim().toLowerCase();
  const a = Number(amt.value||0);
  outUser.textContent = "…";
  const j = await fx("POST", "/api/wallet/credit", { username:name, amount:a, reason:"admin_credit" });
  outUser.textContent = JSON.stringify(j, null, 2);
}catch(e){ outUser.textContent = JSON.stringify(e.data||{error:e.message},null,2); } }

async function debit(){ try{
  const name = (u.value||"").trim().toLowerCase();
  const a = Number(amt.value||0);
  outUser.textContent = "…";
  const j = await fx("POST", "/api/wallet/debit", { username:name, amount:a, reason:"admin_debit" });
  outUser.textContent = JSON.stringify(j, null, 2);
}catch(e){ outUser.textContent = JSON.stringify(e.data||{error:e.message},null,2); } }

async function redeem(){ try{
  outPromo.textContent = "…";
  const j = await fx("POST","/api/code/redeem",{ code:(promo.value||"").trim().toUpperCase() });
  outPromo.textContent = JSON.stringify(j, null, 2);
}catch(e){ outPromo.textContent = JSON.stringify(e.data||{error:e.message},null,2); } }

$("#btnWho").onclick = who;
$("#btnMyBal").onclick = myBal;
$("#btnBal").onclick = adminBal;
$("#btnCredit").onclick = credit;
$("#btnDebit").onclick = debit;
$("#btnRedeem").onclick = redeem;

who();
</script>
</body>
</html>
