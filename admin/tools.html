<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin Hub — L3Z</title>
<link rel="icon" type="image/png" href="/assets/L3Z_logoMain.png">
<style>
  :root{--bg:#0b0e13;--panel:#11151d;--ink:#e8ecf3;--muted:#94a3b8;--line:rgba(0,255,255,.18);
        --gold:#f0a320;--ok:#12d48a;--err:#ff7a8a;--chip:#1b2330}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  a{color:#9bd3ff;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0a1016;color:#cfe;font-weight:800}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#0f131a,#0a0f15);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .head h2{margin:0;font-size:14px;letter-spacing:.3px;color:#ffd78a}
  .body{padding:12px 14px;display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row>label{min-width:120px;color:#cbd5e1}
  input,select,button,textarea{
    background:#0f141b;border:1px solid var(--line);color:var(--ink);
    border-radius:10px;padding:10px 12px;font-size:14px
  }
  input[type="number"]{width:140px}
  textarea{width:100%;min-height:80px}
  button{cursor:pointer;font-weight:800}
  button.primary{background:linear-gradient(180deg,#f5c462,#d49a2e);color:#1a1204;border:none}
  button.ghost{background:#111a22}
  button.danger{background:#2a1115;border-color:#7c2731}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px}
  .audit{max-height:240px;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#0c1117;padding:8px}
  .audit pre{margin:0;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:12px;line-height:1.5}
  .help{font-size:12px;color:#9fb3c5}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="/assets/l3z_logo.png" alt="" style="width:36px;height:36px;border-radius:10px;border:1px solid var(--line)">
      <div class="pill">Admin Hub</div>
      <a class="pill" href="/pages/dashboard/admin/bets_admin.html" style="border-color:#3a5166">Bets Console</a>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="who" class="pill">admin: —</div>
      <div id="cookieState" class="pill" style="border-color:#38525f">cookie: checking…</div>
      <button id="logout" class="ghost">Logout</button>
    </div>
  </div>

  <div class="grid">
    <!-- Wallet -->
    <section class="card">
      <div class="head"><h2>Wallet — Credit / Debit</h2><div class="badge">LBX</div></div>
      <div class="body">
        <div class="row"><label>Username</label><input id="wUser" placeholder="PLAYER NAME" /></div>
        <div class="row"><label>Amount</label><input id="wAmt" type="number" step="1" placeholder="Amount" /></div>
        <div class="row"><label>Reason</label><input id="wReason" placeholder="admin_credit / admin_debit" /></div>
        <div class="row" style="gap:10px">
          <button id="btnCredit" class="primary">Credit ( + )</button>
          <button id="btnDebit" class="ghost">Debit ( − )</button>
          <button id="btnBal" class="ghost">Check Balance</button>
          <span id="wStatus" class="muted"></span>
        </div>
        <div class="help">Uses <code>/api/wallet/credit</code>, <code>/api/wallet/debit</code>, and <code>/api/admin/wallet/balance</code> (with credentials).</div>
      </div>
    </section>

    <!-- Promo Codes -->
    <section class="card">
      <div class="head"><h2>Promo Codes</h2><div class="badge" id="promoBadge">checking…</div></div>
      <div class="body">
        <div class="row">
          <label>Code</label><input id="pcCode" placeholder="PROMO2025" style="width:160px"/>
          <label>LBX amount</label><input id="pcLbx" type="number" step="1" value="5" />
          <label>TTL (hours)</label><input id="pcTtl" type="number" step="1" value="24" />
          <label>Replace current</label><input id="pcReplace" type="checkbox" checked />
        </div>
        <div class="row" style="gap:10px">
          <button id="pcIssue" class="primary">Issue Code</button>
          <button id="pcExpire" class="danger">Expire Active</button>
          <span id="pcStatus" class="muted"></span>
        </div>

        <div class="row"><label>Redeem (test)</label>
          <input id="pcUser" placeholder="USERNAME" />
          <input id="pcRedeemCode" placeholder="CODE" />
          <button id="pcSubmit" class="ghost">Redeem</button>
          <span id="pcRedeemStatus" class="muted"></span>
        </div>

        <div class="help">
          Admin endpoints expected: <code>/api/admin/code/current</code>, <code>/api/admin/code/expire</code>, <code>/api/admin/code/redeem_for</code>.  
          Creation via <code>/api/code/create</code> with <code>{ code, lbx, expiresHours }</code>.
        </div>
      </div>
    </section>

    <!-- Feature switches (server-backed) -->
    <section class="card">
      <div class="head"><h2>Feature Switches (Server)</h2><div class="badge" id="flagsBadge">loading…</div></div>
      <div class="body">
        <div class="row"><label>Battleground</label><input type="checkbox" id="fBattleground"/></div>
        <div class="row"><label>Bonus Hunt</label><input type="checkbox" id="fBonus"/></div>
        <div class="row"><label>PvP</label><input type="checkbox" id="fPvP"/></div>
        <div class="row"><label>Raffles</label><input type="checkbox" id="fRaffles"/></div>
        <div class="row"><label>Promo Claims</label><input type="checkbox" id="fPromos"/></div>

        <div class="row" style="gap:10px">
          <button id="flagsSave" class="primary">Save</button>
          <button id="flagsDisableAll" class="danger">Disable All</button>
          <button id="flagsEnableAll"  class="ghost">Enable All</button>
          <span id="flagsStatus" class="muted"></span>
        </div>
        <div class="help">Backed by <code>/api/admin/flags/get</code>, <code>/api/admin/flags/set</code>, <code>/api/admin/flags/disable_all</code>, <code>/api/admin/flags/enable_all</code>.</div>
      </div>
    </section>

    <!-- Server audit -->
    <section class="card">
      <div class="head"><h2>Action Tracking (Server Audit)</h2><div class="badge">server</div></div>
      <div class="body">
        <div class="row" style="gap:10px">
          <button id="auditRefresh" class="ghost">Refresh</button>
          <button id="auditExport"  class="ghost">Export JSON</button>
          <button id="auditClear"   class="danger">Clear Log</button>
          <span id="auditStatus" class="muted"></span>
        </div>
        <div class="audit"><pre id="auditOut">[]</pre></div>
        <div class="help">Uses <code>/api/admin/audit/list</code>, <code>/api/admin/audit/export</code>, <code>/api/admin/audit/clear</code>, <code>/api/admin/audit/track</code>.</div>
      </div>
    </section>
  </div>
</div>

<script src="/assets/api-base.js"></script>
<script>
const $ = (s, r)=> (r||document).querySelector(s);
const say = (el, msg, ok)=> { if(!el) return; el.textContent=msg||""; el.className = (ok===undefined) ? "muted" : (ok ? "ok" : "err"); };

async function getJSON(url){
  const r = await fetch(url, { credentials:"include", cache:"no-store" });
  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
  return j;
}
async function postJSON(url, body){
  const r = await fetch(url, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
  return j;
}

/* session guard */
async function requireAdmin(){
  const who = $("#who"), cookieState=$("#cookieState");
  try{
    const me = await getJSON("/api/me");
    if(me?.user?.role !== "admin"){
      who.textContent = "admin: (not admin)";
      say(cookieState,"cookie: ok",true);
      alert("Admin only."); location.href="/admin/login.html"; return false;
    }
    who.textContent = `admin: ${me.user.username||"—"}`;
    say(cookieState,"cookie: ok",true);
    return true;
  }catch{
    who.textContent="admin: (not logged in)";
    say(cookieState,"cookie: missing",false);
    location.href="/admin/login.html";
    return false;
  }
}
$("#logout")?.addEventListener("click", async ()=>{ try{ await postJSON("/api/auth/logout",{});}catch{} location.href="/admin/login.html"; });

/* wallet */
const wUser=$("#wUser"), wAmt=$("#wAmt"), wReason=$("#wReason"), wStatus=$("#wStatus");
$("#btnCredit")?.addEventListener("click", async ()=>{
  const username=(wUser.value||"").trim().toLowerCase(), amount=Number(wAmt.value||0), reason=(wReason.value||"admin_credit");
  if(!username||!Number.isFinite(amount)||amount<=0){ return say(wStatus,"Enter username and positive amount.",false); }
  try{
    say(wStatus,"Working…");
    const res = await postJSON("/api/wallet/credit",{ username, amount, reason });
    say(wStatus,`Credited. New balance: ${Number(res?.user?.lbx ?? res?.balance ?? 0).toLocaleString()} LBX`,true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"wallet.credit", payload:{username,amount,reason} }); }catch{}
  }catch(e){ say(wStatus,e.message||"failed",false); }
});
$("#btnDebit")?.addEventListener("click", async ()=>{
  const username=(wUser.value||"").trim().toLowerCase(), amount=Number(wAmt.value||0), reason=(wReason.value||"admin_debit");
  if(!username||!Number.isFinite(amount)||amount<=0){ return say(wStatus,"Enter username and positive amount.",false); }
  try{
    say(wStatus,"Working…");
    const res = await postJSON("/api/wallet/debit",{ username, amount, reason });
    say(wStatus,`Debited. New balance: ${Number(res?.user?.lbx ?? res?.balance ?? 0).toLocaleString()} LBX`,true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"wallet.debit", payload:{username,amount,reason} }); }catch{}
  }catch(e){ say(wStatus,(e.message||"failed").replace(/_/g," "),false); }
});
$("#btnBal")?.addEventListener("click", async ()=>{
  const username=(wUser.value||"").trim().toLowerCase(); if(!username) return say(wStatus,"Enter username.",false);
  try{
    say(wStatus,"Checking…");
    const j = await getJSON(`/api/admin/wallet/balance?user=${encodeURIComponent(username)}`);
    const bal = Number(j?.balance ?? j?.lbx ?? 0);
    say(wStatus,`Balance: ${bal.toLocaleString()} LBX`,true);
  }catch(e){ say(wStatus,e.message||"failed",false); }
});

/* promo */
const pcCode=$("#pcCode"), pcLbx=$("#pcLbx"), pcTtl=$("#pcTtl"), pcReplace=$("#pcReplace"),
      pcIssue=$("#pcIssue"), pcExpire=$("#pcExpire"), pcStatus=$("#pcStatus"),
      promoBadge=$("#promoBadge");
async function refreshCurrentPromo(){
  try{
    const j = await getJSON("/api/admin/code/current");
    promoBadge.textContent = j?.code ? `active: ${j.code} (+${j.lbx}) exp ${new Date(j.expiresAt).toLocaleString()}` : "no active code";
  }catch{ promoBadge.textContent = "promo unavailable"; }
}
pcIssue?.addEventListener("click", async ()=>{
  const code=(pcCode.value||"").trim().toUpperCase(); const lbx=Number(pcLbx.value||0); const ttl=Number(pcTtl.value||24);
  if(!code || !Number.isFinite(lbx) || lbx<=0) return say(pcStatus,"Need CODE and positive LBX.",false);
  try{
    say(pcStatus,"Issuing…");
    if(pcReplace.checked){ try{ await postJSON("/api/admin/code/expire",{}); }catch{} }
    const j = await postJSON("/api/code/create",{ code, lbx, expiresHours:ttl });
    say(pcStatus,`Issued ${j.code} (+${j.lbx})`,true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"promo.issue", payload:j }); }catch{}
    refreshCurrentPromo();
  }catch(e){ say(pcStatus,(e.message||"failed").replace(/_/g," "),false); }
});
pcExpire?.addEventListener("click", async ()=>{
  try{
    say(pcStatus,"Expiring…");
    const j = await postJSON("/api/admin/code/expire",{});
    say(pcStatus,`Expired (${j.n||0} updated)`,true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"promo.expire", payload:j }); }catch{}
    refreshCurrentPromo();
  }catch(e){ say(pcStatus,(e.message||"failed").replace(/_/g," "),false); }
});
const pcUser=$("#pcUser"), pcRedeemCode=$("#pcRedeemCode"), pcSubmit=$("#pcSubmit"), pcRedeemStatus=$("#pcRedeemStatus");
pcSubmit?.addEventListener("click", async ()=>{
  const username=(pcUser.value||"").trim().toLowerCase(), code=(pcRedeemCode.value||"").trim().toUpperCase();
  if(!username || !code) return say(pcRedeemStatus,"Enter username + code.",false);
  pcSubmit.disabled=true; say(pcRedeemStatus,"Submitting…");
  try{
    // Admin-side test redeem (does not require user login)
    const j = await postJSON("/api/admin/code/redeem_for",{ username, code });
    say(pcRedeemStatus,`Success! +${j.lbx} LBX added.`,true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"promo.redeem_for", payload:{ username, code, lbx:j.lbx } }); }catch{}
    pcRedeemCode.value="";
  }catch(e){ say(pcRedeemStatus,(e.message||"failed").replace(/_/g," "),false); }
  finally{ pcSubmit.disabled=false; }
});
refreshCurrentPromo();

/* flags (server) */
const ids = { battleground:"#fBattleground", bonus:"#fBonus", pvp:"#fPvP", raffles:"#fRaffles", promos:"#fPromos" };
function uiReadFlags(){
  return {
    battleground: $(ids.battleground).checked,
    bonus:        $(ids.bonus).checked,
    pvp:          $(ids.pvp).checked,
    raffles:      $(ids.raffles).checked,
    promos:       $(ids.promos).checked,
  };
}
function uiWriteFlags(f){
  $(ids.battleground).checked = !!f.battleground;
  $(ids.bonus).checked        = !!f.bonus;
  $(ids.pvp).checked          = !!f.pvp;
  $(ids.raffles).checked      = !!f.raffles;
  $(ids.promos).checked       = !!f.promos;
}
async function loadFlags(){
  const badge = $("#flagsBadge");
  try{
    const j = await getJSON("/api/admin/flags/get");
    uiWriteFlags(j?.flags || {});
    badge.textContent="loaded";
  }catch(e){ badge.textContent="error"; }
}
$("#flagsSave")?.addEventListener("click", async ()=>{
  const status=$("#flagsStatus");
  try{
    say(status,"Saving…");
    const flags = uiReadFlags();
    await postJSON("/api/admin/flags/set",{ flags });
    say(status,"Saved.",true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"flags.save", payload:flags }); }catch{}
  }catch(e){ say(status,(e.message||"failed").replace(/_/g," "),false); }
});
$("#flagsDisableAll")?.addEventListener("click", async ()=>{
  const status=$("#flagsStatus");
  try{
    say(status,"Disabling…");
    const j = await postJSON("/api/admin/flags/disable_all",{});
    uiWriteFlags(j.flags||{});
    say(status,"All disabled.",true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"flags.disable_all" }); }catch{}
  }catch(e){ say(status,(e.message||"failed").replace(/_/g," "),false); }
});
$("#flagsEnableAll")?.addEventListener("click", async ()=>{
  const status=$("#flagsStatus");
  try{
    say(status,"Enabling…");
    const j = await postJSON("/api/admin/flags/enable_all",{});
    uiWriteFlags(j.flags||{});
    say(status,"All enabled.",true);
    try{ await postJSON("/api/admin/audit/track",{ evt:"flags.enable_all" }); }catch{}
  }catch(e){ say(status,(e.message||"failed").replace(/_/g," "),false); }
});
loadFlags();

/* audit (server) */
async function paintAudit(){
  try{
    const j = await getJSON("/api/admin/audit/list");
    $("#auditOut").textContent = JSON.stringify(j.records||[], null, 2);
    say($("#auditStatus"), `Loaded ${j.records?.length||0}`, true);
  }catch(e){
    $("#auditOut").textContent = "[]";
    say($("#auditStatus"), (e.message||"failed").replace(/_/g," "), false);
  }
}
$("#auditRefresh")?.addEventListener("click", paintAudit);
$("#auditExport")?.addEventListener("click", async ()=>{
  try{
    const r = await fetch("/api/admin/audit/export", { credentials:"include" });
    const blob = await r.blob(); const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=`l3z_admin_audit_${Date.now()}.json`; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),5000);
  }catch{}
});
$("#auditClear")?.addEventListener("click", async ()=>{
  try{ await postJSON("/api/admin/audit/clear",{}); paintAudit(); }catch{}
});
paintAudit();

/* boot */
(async function boot(){
  const ok = await requireAdmin();
  if (!ok) return;
})();
</script>
</body>
</html>
