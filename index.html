<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-store"/>
<title>L3Z — Dashboard</title>
<style>
  :root{
    --bg:#060b0d; --panel:#0b1417; --ink:#eaf7ff; --muted:#9fd0d6;
    --line:rgba(0,255,255,.18); --teal:#00ffff; --gold:#ffb42d;
    --ok:#12d48a; --bad:#e25a6f; --ink2:#cfffff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,Arial,sans-serif}
  a{color:#8fefff;text-decoration:none}
  a:hover{filter:brightness(1.1)}
  .app{display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
  .topbar{
    grid-column:1 / -1; display:flex; align-items:center; gap:12px;
    padding:12px 16px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,#0a1418,#0a1216);
    position:sticky; top:0; z-index:5;
  }
  .brand{font-weight:900; letter-spacing:.5px; color:var(--teal); text-shadow:0 0 12px #00ffff55}
  .spacer{flex:1}
  .btn{border:1px solid var(--line); background:#0f1720; padding:8px 12px; border-radius:10px; font-weight:800; color:var(--ink); cursor:pointer}
  .btn.ok{background:#103d30; border-color:#1fa37b}
  .btn.warn{background:#231b0f; border-color:#8c6926}
  .btn.bad{background:#2b1116; border-color:#7e2a3c}
  .side{
    border-right:1px solid var(--line); padding:16px; background:linear-gradient(180deg,#081318,#0a1216);
  }
  .side h3{margin:8px 0 10px; color:#bfe}
  .nav{display:flex; flex-direction:column; gap:8px}
  .nav a{display:block; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#0c1418; font-weight:700}
  .nav a.active{outline:1px solid #00ffff66}
  .main{padding:16px}
  .card{
    background:linear-gradient(180deg,#0a1418,#0a1216);
    border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:16px;
  }
  .kpi{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
  .badge{padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#081318; color:#bfe; font-weight:700}
  .jackpot{font-size:26px; font-weight:900; color:var(--gold); text-shadow:0 0 18px #ffb42d44}
  .muted{color:var(--muted); font-size:12px}
  .hidden{display:none!important}
  @media (max-width: 980px){
    .app{grid-template-columns:1fr}
    .side{order:2}
    .main{order:3}
  }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <header class="topbar">
    <div class="brand">L3Z Dashboard</div>
    <div class="spacer"></div>

    <!-- Always present: Home -->
    <a href="/" class="btn" id="btnHome">Home</a>

    <!-- Changes based on admin session -->
    <a href="/pages/dashboard/home/admin_login.html" class="btn" id="btnAdminLogin">Admin Login</a>
    <a href="/pages/dashboard/admin/admin_hub.html" class="btn ok hidden" id="btnAdminHub">Admin Hub</a>
    <button class="btn bad hidden" id="btnLogout">Log out</button>
  </header>

  <!-- Sidebar -->
  <aside class="side">
    <h3>Menu</h3>
    <nav class="nav">
      <a href="#overview" class="active">Overview</a>
      <a href="#leaderboard">Leaderboard</a>
      <a href="#battleground">Battleground</a>
      <a href="#bonus">Bonus Hunt</a>
      <a href="#pvp">PVP</a>
      <a href="#lucky7">Lucky 7</a>
      <!-- add more as needed -->
    </nav>
    <div class="card" style="margin-top:16px">
      <div class="muted">Tip: Admin is separate. Use the Admin button above, do your business, then click “Home”. No more traps.</div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <section id="overview" class="card">
      <h2>Overview</h2>
      <div class="kpi">
        <span class="badge">Month: <span id="jpMonth">—</span></span>
        <span class="badge">Per Sub (AUD): <span id="jpPer">—</span></span>
      </div>
      <div style="margin-top:10px">
        <div class="muted">Current Jackpot</div>
        <div class="jackpot" id="jpAmount">A$ —</div>
      </div>
    </section>

    <section id="leaderboard" class="card">
      <h2>Leaderboard</h2>
      <div class="muted">Coming soon (front-end only placeholder).</div>
    </section>

    <section id="battleground" class="card">
      <h2>Battleground</h2>
      <div class="muted">Front-end widget placeholder.</div>
    </section>

    <section id="bonus" class="card">
      <h2>Bonus Hunt</h2>
      <div class="muted">Front-end widget placeholder.</div>
    </section>

    <section id="pvp" class="card">
      <h2>PVP</h2>
      <div class="muted">Front-end widget placeholder.</div>
    </section>

    <section id="lucky7" class="card">
      <h2>Lucky 7</h2>
      <div class="muted">Front-end widget placeholder.</div>
    </section>
  </main>
</div>

<script>
(function(){
  "use strict";

  // Toggle header buttons depending on admin cookie
  async function checkAdmin() {
    try{
      const r = await fetch("/api/admin/gate/check", { credentials:"include", cache:"no-store" });
      const ok = r.ok ? await r.json() : null;
      const isAdmin = !!(ok && ok.admin);
      document.getElementById("btnAdminLogin").classList.toggle("hidden", isAdmin);
      document.getElementById("btnAdminHub").classList.toggle("hidden", !isAdmin);
      document.getElementById("btnLogout").classList.toggle("hidden", !isAdmin);
    }catch{
      // no cookie or endpoint—stay in public mode
    }
  }

  // Logout (stays on homepage after)
  document.getElementById("btnLogout").addEventListener("click", async () => {
    try { await fetch("/api/admin/gate/logout", { method:"POST", credentials:"include" }); } catch {}
    // also clear any local “unlocked” keys from your admin pages (defensive)
    try { localStorage.removeItem("l3z:admin:unlocked"); } catch {}
    await checkAdmin();
  });

  // Fetch jackpot
  async function loadJackpot(){
    try{
      const r = await fetch("/api/jackpot", { cache:"no-store" });
      if(!r.ok) throw 0;
      const a = await r.json();
      const amt = Number(a.amount ?? a.pot ?? 0).toFixed(2);
      document.getElementById("jpAmount").textContent = "A$ " + amt;
      document.getElementById("jpMonth").textContent  = a.month || "—";
      document.getElementById("jpPer").textContent    = (a.perSubAUD ?? a.jackpotPerSubAUD ?? 2.50).toFixed ? (a.perSubAUD ?? a.jackpotPerSubAUD ?? 2.50).toFixed(2) : (a.perSubAUD ?? a.jackpotPerSubAUD ?? 2.50);
    }catch{
      document.getElementById("jpAmount").textContent = "A$ —";
      document.getElementById("jpMonth").textContent  = "—";
      document.getElementById("jpPer").textContent    = "—";
    }
  }

  // Kill any old service worker caches that could hijack routing
  (async () => {
    try {
      const regs = await (navigator.serviceWorker?.getRegistrations?.() || []);
      for (const r of regs) await r.unregister();
      if (window.caches) {
        const keys = await caches.keys();
        for (const k of keys) await caches.delete(k);
      }
    } catch {}
  })();

  checkAdmin();
  loadJackpot();
})();
</script>
</body>
</html>
